/**
 * SPDX-License-Identifier: EUPL-1.2
 * (C) Copyright 2019 Regione Piemonte
 */

var Constants=Constants||{};Constants.API_METADATA_URL="//api.smartdatanet.it/metadataapi/api/",Constants.API_DATA_URL="//api.smartdatanet.it/api/",Constants.SDP_WEB_SOCKET_BASE_URL="wss://stream.smartdatanet.it/wss/",Constants.WEB_SOCKET_USER="guest",Constants.WEB_SOCKET_SECRET="Aekieh6F",Constants.SDP_WEBSOCKET_CONNECTING="Connecting",Constants.SDP_WEBSOCKET_CONNECTED="Connected",Constants.SDP_WEBSOCKET_NOT_CONNECTED="Not Connected",Constants.LINE_CHART_COLORS=["#004586","#0084d1","#d01e2a","#f37a1f","#f3c414","#3d9e00","#a6d615","#8f69c2","#e4477e"],Constants.Time={},Constants.Time.ONE_MINUTE=6e4,Constants.Time.ONE_HOUR=36e5,Constants.Time.ONE_DAY=864e5,Constants.Time.ONE_MONTH=26784e5,Constants.Time.ONE_YEAR=31536e6,Constants.MAP_TILES_CARTO_DB_POSITRON_URL="http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",angular.module("yucca.plugin",["yucca.widgets","yucca.utils","yucca.filters"]);var yuccaWidgetsTemplatesModule=angular.module("yucca.widgets.templates",["yucca.utils"]),yuccaWidgetsModule=angular.module("yucca.widgets",["yucca.widgets.templates","yucca.services","nvd3","leaflet-directive"]),yuccaWidgetsFilter=angular.module("yucca.filters",[]);yuccaWidgetsFilter.filter("safeNumber",function(e){return function(t,a,n,r){return e.render.safeNumber(t,a,n,r)}}),yuccaWidgetsFilter.filter("format_big_number",function(){return function(e,t,a){return $yuccaHelpers.render.format_big_number(e,a,t)}}),yuccaWidgetsFilter.filter("startFrom",function(){return function(e,t){if(e)return t=+t,e.slice(t)}}),yuccaWidgetsFilter.filter("string_ellipse",function(){return function(e,t,a){return"undefined"!=typeof e&&null!=e||(e=""),isNaN(t)&&(t=10),void 0===a&&(a="..."),e.length<=t||e.length-a.length<=t?e:String(e).substring(0,t-a.length)+a}});var yuccaServices=yuccaServices||angular.module("yucca.services",[]);yuccaServices.factory("metadataService",["$http","$q",function(e,t){var a={},n=function(t,a){var n={method:"GET",url:t};return a&&null!=a&&""!=a&&(n.headers={Authorization:"Bearer "+a},httpBodyRequestwithCredentials=!0),e(n)};return a.getStreamMetadata=function(e,t,a,r){var l=Constants.API_METADATA_URL+"detail/"+e+"/"+a+"/"+t+"?";return console.debug(l),n(l,r)},a.getDatasetMetadata=function(e,t,a){var r=Constants.API_METADATA_URL+"detail/"+e+"/"+t+"?";return n(r,a)},a.findMetadata=function(e,t,a,r,l){var o="http:"+Constants.API_METADATA_URL+"search/full?end=10";return"undefined"!=typeof e&&null!=e&&""!=e&&(o+="&tenant="+e),"undefined"!=typeof t&&null!=t&&""!=t&&(o+="&domain="+t),"undefined"!=typeof a&&null!=a&&""!=a&&(o+="&q="+a),"undefined"!=typeof r&&null!=r&&(o+=r?"&opendata=true":"&opendata=false"),console.debug(o),n(o,l)},a}]),yuccaServices.factory("dataService",["$http","$q","$yuccaHelpers",function(e,t,a){var n={};n.getLastValue=function(e,t,n,r,l,o){var s=this,i=a.stream.wsOutputUrl(e,t,n),d={};d.ws_url=Constants.SDP_WEB_SOCKET_BASE_URL,d.user_token=r;var c=WebsocketStompSingleton.getInstance(d);console.debug("clientSingleton",c);var u=c.getWebClient();c.addSubscription(i,l,e,o),s.onDispose=function(){u.disconnect()}};var r=function(t,a,n,r){var l="https:"+Constants.API_DATA_URL+a+"/"+t+"('"+r+"')?$format=json";l+="&callback=JSON_CALLBACK";var o={method:"GET",url:l};return n&&null!=n&&""!=n&&(o.headers={Authorization:"Bearer "+n},httpBodyRequestwithCredentials=!0),console.debug("dataUrl",l),e(o)},l=function(t,a,n,r,l,o,s){var i="https:"+Constants.API_DATA_URL+a+"/"+t+"?$format=json";console.debug("filter",r),r&&null!=r&&(i+="&$filter="+r),l&&null!=l&&(i+="&$skip="+l),i+=o&&null!=o?"&$top="+o:"&$top=30",s&&null!=s&&(i+="&$orderby="+s),i+="&callback=JSON_CALLBACK";var d={method:"GET",url:i};return n&&null!=n&&""!=n&&(d.headers={Authorization:"Bearer "+n},httpBodyRequestwithCredentials=!0),console.debug("dataUrl",i),e(d)},o=function(t,a,n,r,l,o,s,i,d){console.debug("loadDataStats",t,a,n,r,l,o,s,i,d);var c="https:"+Constants.API_DATA_URL+a+"/"+t+"?$format=json";r&&null!=r&&(c+="&timeGroupBy="+r),l&&null!=l&&(c+="&timeGroupOperators="+l),o&&null!=o&&(c+="&timeGroupFilter="+o),s&&null!=s&&(c+="&$skip="+s),c+=i&&null!=i?"&$top="+i:"&$top=1000",d&&null!=d&&(c+="&$orderby="+d),c+="&callback=JSON_CALLBACK";var u={method:"GET",url:c};return n&&null!=n&&""!=n&&(u.headers={Authorization:"Bearer "+n},httpBodyRequestwithCredentials=!0),console.debug("dataUrl",c),e(u)},s=function(t,a,n,r,l,o,s,i,d){console.debug("loadDataGrouped",t,a,n,r,l,o,s,i,d);var c="https:"+Constants.API_DATA_URL+a+"/"+t+"?$format=json";r&&null!=r&&(c+="&groupBy="+r),l&&null!=l&&(c+="&groupOperators="+l),o&&null!=o&&(c+="&groupFilter="+o),s&&null!=s&&(c+="&$skip="+s),c+=i&&null!=i?"&$top="+i:"&$top=1000",d&&null!=d&&(c+="&$orderby="+d),c+="&callback=JSON_CALLBACK";var u={method:"GET",url:c};return n&&null!=n&&""!=n&&(u.headers={Authorization:"Bearer "+n},httpBodyRequestwithCredentials=!0),console.debug("dataUrl",c),e(u)};return n.getDataEntitiesStats=function(e,t,a,n,r,l,o,i){return s("DataEntitiesStats",e,t,a,n,r,l,o,i)},n.getMeasuresStats=function(e,t,a,n,r,l,s,i){return o("MeasuresStats",e,t,a,n,r,l,s,i)},n.getSocialFeeds=function(e,t,a,n,r,o){return l("SocialFeeds",e,t,a,n,r,o)},n.getMeasures=function(e,t,a,n,r,o){return l("Measures",e,t,a,n,r,o)},n.getDataEntities=function(e,t,a,n,r,o){return l("DataEntities",e,t,a,n,r,o)},n.getSocialFeedsStats=function(e,t,a,n,r,l,s,i){return o("SocialFeedsStats",e,t,a,n,r,l,s,i)},n.getBinariesData=function(t){return e.get(t+"?$format=json")},n.getMultipleDataEnties=function(e,a,r,l,o){o>1e4&&(o=1e4);var s=parseInt(o/1e3)+1;console.debug("numOfLoop",s);for(var i=[],d=1e3,c=0;c<s;c++)i.push(n.getDataEntities(e,a,r,c*d,d,l));return t.all(i)},n.getSingleSocialFeeds=function(e,t,a){return r("SocialFeeds",e,t,a)},n.getSingleMeasures=function(e,t,a){return r("Measures",e,t,a)},n.getSingleDataEntities=function(e,t,a){return r("DataEntities",e,t,a)},n}]);var yuccaUtilsModule=angular.module("yucca.utils",[]);yuccaUtilsModule.factory("$yuccaHelpers",[function(){var e={stream:{wsOutputUrl:function(e,t,a){var n="";t&&null!=t&&a&&null!=a?n=a+"_"+t:a&&null!=a?n=a:n+=stream.stream_code;var r="/topic/output."+e+"."+n;return r}},attrs:{num:function(e,t,a,n){console.log("num",e,t,a,n);var r=e;return(isNaN(e)||null==e||""==e)&&(r=n),"undefined"!=typeof t&&null!=t&&r<t&&(r=t),"undefined"!=typeof a&&null!=a&&r>a&&(r=a),console.log("result",r),r},safe:function(e,t){var a=e;return"undefined"==typeof e||null==e||""==e?a=t:"false"===e&&(a=!1),a}},utils:{mongoDate2millis:function(e){var t=null;if(e){var a=/\/Date\((-?\d+)([+-]\d{4})?.*/.exec(e);void 0==a[2]&&(a[2]=0);var n=parseInt(a[2]);t=new Date(a[1]-6e4*n)}return t},mongoDate2string:function(e){return this.formatDateFromMillis(this.mongoDate2millis(e).getTime())},isEmpty:function(e){return"undefined"==typeof e||null==e},startsWith:function(e,t){return 0===e.lastIndexOf(t,0)},rgb2Hex:function(e){e.indexOf("(")>=0&&(e=e.match(/\(([^)]+)\)/)[1]);var t=e.split(",");return"#"+((1<<24)+(parseInt(t[0])<<16)+(parseInt(t[1])<<8)+parseInt(t[2])).toString(16).slice(1)},hex2Rgb:function(e){"#"==e.charAt(0)&&(e=e.substring(1,7));var t=parseInt(e.substring(0,2),16),a=parseInt(e.substring(2,4),16),n=parseInt(e.substring(4,6),16);return t+","+a+","+n},hex2Color:function(e){"#"==e.charAt(0)&&(e=e.substring(1,7));var t=parseInt(e.substring(0,2),16),a=parseInt(e.substring(2,4),16),n=parseInt(e.substring(4,6),16);return{r:t,g:a,b:n,opacity:16}},formatDateFromMillis:function(e){var t="";if(e){var a=new Date(e),n=a.getDate(),r=a.getMonth()+1,l=a.getFullYear(),o=a.getHours(),s=a.getMinutes();t=""+(n<=9?"0"+n:n)+"/"+(r<=9?"0"+r:r)+"/"+l+" "+(o<=9?"0"+o:o)+":"+(s<=9?"0"+s:s)}return t},lZero:function(e){var t="00";return isNaN(e)||(t=e<=9?"0"+e:e),t},formatDate:function(e,t,a){var n=e;return e&&(a?"en"==a&&(a="en-EN"):a="it-IT",n=new Date(e).toLocaleDateString(a,t)),n},formatStreamDate:function(e,t){var a="";if(e){var n=new Date(e),r=n.getDate(),l=n.getMonth()+1,o=n.getFullYear(),s=n.getHours(),i=n.getMinutes(),d=n.getSeconds();a=""+o+"/"+(l<=9?"0"+l:l)+"/"+(r<=9?"0"+r:r),t&&(a+=" "+(s<=9?"0"+s:s)+":"+(i<=9?"0"+i:i)+":"+(d<=9?"0"+d:d))}return a},isTouchDevice:function(){return"ontouchstart"in document.documentElement}},odata:{decodeDateFilter:function(e){console.log("attr",e);var t=null,a=null,n=null,r=null;if(null!=e.timeRange&&""!=e.timeRange){var l=new Date,o=new Date;switch(e.timeRange){case"today":l.setHours(0,0,0,0),o.setHours(23,59,59,999);break;case"yesterday":l.setDate(l.getDate()-1),l.setHours(0,0,0,0),o.setDate(o.getDate()-1),o.setHours(23,59,59,999);break;case"this_month":l=new Date(l.getFullYear(),l.getMonth(),1),o=new Date(l.getFullYear(),l.getMonth()+1,0),o.setHours(23,59,59,999);break;case"last_month":l=new Date(l.getFullYear(),l.getMonth()-1,1),o=new Date(l.getFullYear(),o.getMonth(),0),o.setHours(23,59,59,999);break;case"this_year":l=new Date(l.getFullYear(),0,1),o=new Date(l.getFullYear()+1,0,0),o.setHours(23,59,59,999);break;case"last_year":l=new Date(l.getFullYear()-1,0,1),o=new Date(o.getFullYear(),0,0),o.setHours(23,59,59,999);break;default:l.setHours(0,0,0,0),o.setHours(23,59,59,999)}t=this.formatData(l.getTime()-6e4*l.getTimezoneOffset()),a=this.formatData(o.getTime()-6e4*o.getTimezoneOffset()),n=l.getTime()-6e4*l.getTimezoneOffset(),r=o.getTime()-6e4*o.getTimezoneOffset()}else if(null!=e.timeMaxDate&&""!=e.timeMaxDate&&null!=e.timeMinDate&&""!=e.timeMinDate)n=new Date(e.timeMinDate).getTime(),r=new Date(e.timeMaxDate).getTime(),t=this.formatData(n-6e4*(new Date).getTimezoneOffset()),a=this.formatData(r-6e4*(new Date).getTimezoneOffset());else{var l=new Date,o=new Date;l.setHours(0,0,0,0),o.setHours(23,59,59,999),t=this.formatData(l.getTime()-6e4*l.getTimezoneOffset()),a=this.formatData(o.getTime()-6e4*o.getTimezoneOffset()),n=l.getTime()-6e4*l.getTimezoneOffset(),r=o.getTime()-6e4*o.getTimezoneOffset()}return{timeFilter:"time%20ge%20datetimeoffset%27"+t+"%27%20and%20time%20lt%20datetimeoffset%27"+a+"%27",minDateMillis:n,maxDateMillis:r}},formatData:function(e){var t="";if(e){var a=new Date(e),n=a.getDate(),r=a.getMonth()+1,l=a.getFullYear(),o=a.getHours(),s=a.getMinutes(),i=a.getSeconds(),d="02:00";t=""+l+"-"+(r<=9?"0"+r:r)+"-"+(n<=9?"0"+n:n)+"T"+(o<=9?"0"+o:o)+":"+(s<=9?"0"+s:s)+":"+(i<=9?"0"+i:i),t+="+"+d}return t},extractTimeGroupFilter:function(e,t){var a="year";if(e>0&&t>e){var n=t-e;n<Constants.Time.ONE_DAY?a="hour_dayofmonth_month_year":n<Constants.Time.ONE_MONTH?a="dayofmonth_month_year":n<Constants.Time.ONE_YEAR&&(a="month_year")}return a},timeGroup2resultKey:function(e){var t="year";return"hour_dayofmonth_month_year"==e?t="hour":"dayofmonth_month_year"==e?t="dayofmonth":"month_year"==e&&(t="month"),t},timeGroupLabel:function(e){var t="Year";return"hour_dayofmonth_month_year"==e?t="Hour of the day":"dayofmonth_month_year"==e?t="Day of the month":"month_year"==e&&(t="Month of the year"),t}},csv:{downloadCSV:function(e,t){var a=new Blob([e],{type:"text/csv"}),n=document.createElement("a");n.download=t,n.href=window.URL.createObjectURL(a),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)},prepareKeyValue:function(e,t,a){return this.prepareSeriesKeyValue(e,[{label:t,values:a}])},prepareSeriesKeyValue:function(e,t){console.log(t);var a=e;if(t){for(var n=0;n<t.length;n++)a+=";"+t[n].label;a+="\r\n";for(var r=0;r<t[0].values.length;r++){a+=t[0].values[r].label;for(var n=0;n<t.length;n++)a+=";"+t[n].values[r].value;a+="\r\n"}}return a},prepareSeriesXY:function(e,t){var a=e;if(t){for(var n=0;n<t.length;n++)a+=";"+t[n].label;a+="\r\n";for(var n=0;n<t.length;n++){a+=t[n].values[0].x;for(var r=0;r<t[n].values.length;r++)a+=";"+t[n].values[r].y;a+="\r\n"}}return a}},statistic:{timeAggregation:function(e){result=[];var t="%H:%M",a=[];if(null!=e&&e.length>1){var n=e[0][0].getTime(),r=e[e.length-1][0].getTime(),l=n-r,o=Constants.Time.ONE_YEAR;l<Constants.Time.ONE_MINUTE?(o=Constants.Time.ONE_MINUTE/6,t="%s s"):l<Constants.Time.ONE_HOUR?(o=Constants.Time.ONE_HOUR/6,t="%m min"):l<Constants.Time.ONE_DAY?(o=Constants.Time.ONE_HOUR/12,t="%H:%M"):l<Constants.Time.ONE_MONTH?(o=Constants.Time.ONE_MONTH/15,t="%d/%M"):l<Constants.Time.ONE_YEAR&&(o=Constants.Time.ONE_YEAR/12,t="%b/%y"),o=l/10;for(var s=r,i=0,d=[],c=e.length-1;c>=0;c--)e[c][0].getTime()<s+o?(d.push(e[c][1]),i++):(result.push({label:s,value:i}),s+=o,a.push(d),i=0,d=[])}return console.debug("in",e),console.debug("out",result),console.debug("dataValues",a),{data:result,labelFormat:t,dataValues:a}}},d3color:{getRange:function(e){var t=d3.scale.linear().domain([1,10]).range(["white",e,"black"]);return[t(3),t(7)]},brighter:function(t,a){var n=1/.7,r=e.utils.hex2Color(t);return a=null==a?n:Math.pow(n,a),e.utils.rgb2Hex("("+r.r*a+","+r.g*a+","+r.b*a+")")},darker:function(t,a){var n=.7,r=e.utils.hex2Color(t);return a=null==a?n:Math.pow(n,a),e.utils.rgb2Hex("("+r.r*a+","+r.g*a+","+r.b*a+")")}},render:{safeDate:function(t,a){var n=t;if(t&&e.utils.startsWith(t,"/Date(")){var r=e.utils.mongoDate2millis(t);n=e.utils.formatDate(r,a)}return n},safeNumber:function(e,t,a,n){var r=e;return isNaN(e)||(e&&(e=parseFloat(e)),a?r=this.formatEuro(e,t,n):(isNaN(t)&&(Math.abs(e)>100?t=0:Math.abs(e)<1?(t=-1*Math.log10(e)+1,t<0?t=0:t>20&&(t=20)):t=2),r=parseFloat(e).toFixed(t),n&&(r=this.format_big_number(r,t)))),r},format_big_number:function(e,t,a){var n="";return t||(t=2),e&&(n=this.formatBigNumberValue(e,t)),(""+n).replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".")},formatBigNumberValue:function(e,t,a){return a||(a="it"),e<1e3?output=parseFloat(e).toFixed(t):e<1e6?output=(e/1e3).toFixed(t)+("it"==a?" mila":" k"):e<1e9?output=(e/1e6).toFixed(t)+("it"==a?" mln":" M"):output=(e/1e9).toFixed(t).toLocaleString()+("it"==a?" mld":" B"),output},isFloat:function(e){return Number(e)===e&&e%1!==0},completeTweet:function(e,t){var a=e;return a.getTextPretty=this.prettifyTwitterMessage(e.getText),a.createdAtFormatted=t,a.twitterLink="https://twitter.com/"+e.userScreenName+"/status/"+e.tweetid,a.twitterUserLink="https://twitter.com/"+e.userScreenName,a},safeTags:function(e){var t="";if("undefined"!=typeof e&&null!=e){var a=typeof e;t="string"==a?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):e}return t},prettifyTwitterUser:function(e){var t="";if("undefined"!=typeof e&&null!=e){var a=typeof e;t="string"==a?e.replace(/(^|\W)(@[a-z\d][\w-]*)/gi,'$1<span class="tweet-user">$2</span>'):e}return t},prettifyTwitterHashtag:function(e){var t="";if("undefined"!=typeof e&&null!=e){var a=typeof e;t="string"==a?e.replace(/(^|\W)(#[a-z\d][\w-]*)/gi,'$1<span class="tweet-hashtag">$2</span>'):e}return t},linkify:function(e){var t="";if("undefined"!=typeof e&&null!=e){var a=typeof e;if("string"==a){var n,r,l;n=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,t=e.replace(n,'<a href="$1" target="_blank">$1</a>'),r=/(^|[^\/])(www\.[\S]+(\b|$))/gim,t=t.replace(r,'$1<a href="http://$2" target="_blank">$2</a>'),l=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(l,'<a href="mailto:$1">$1</a>')}else t=e}return t},prettifyTwitterMessage:function(e){var t=this.safeTags(e);return t=this.linkify(t),t=this.prettifyTwitterHashtag(t),t=this.prettifyTwitterUser(t)},safeColors:function(e,t,a,n){var r=new Array;if(t&&null!=t&&t.length>0)for(var l=0,o=0;o<e;o++)r.push(t[l]),l++,l==t.length&&(l=0);else if(a){var s=this.colorLuminance(a,-.6),i=this.colorLuminance(a,.6),d=d3.scale.linear().range([s,i]).domain([0,e]);r=d3.range(e).map(function(e){return d(e)})}return r},hex2RgbaColor:function(e,t){return e=e.replace("#",""),r=parseInt(e.substring(0,2),16),g=parseInt(e.substring(2,4),16),b=parseInt(e.substring(4,6),16),result="rgba("+r+","+g+","+b+","+t/100+")",result},colorLuminance:function(e,t){e=String(e).replace(/[^0-9a-f]/gi,""),e.length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),t=t||0;var a,n,r="#";for(n=0;n<3;n++)a=parseInt(e.substr(2*n,2),16),a=Math.round(Math.min(Math.max(0,a+a*t),255)).toString(16),r+=("00"+a).substr(a.length);return r},formatEuro:function(e,t,a){var n=e;("undefined"==typeof t||isNaN(t))&&(t=2);var r=" â‚¬";return isNaN(e)||(n=a?this.formatBigNumberValue(e,t):parseFloat(e).toFixed(t).toString()),n.toString().replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".")+r},widgetSize:function(e,t){var a=window.getComputedStyle(e.parentElement),n=parseInt(a.paddingLeft.replace("px","")),r=parseInt(a.paddingRight.replace("px","")),l=(parseInt(a.paddingTop.replace("px","")),parseInt(a.paddingBottom.replace("px","")),24+n+r);return{w:e.parentElement.clientWidth-l,h:e.parentElement.clientHeight}}},data:{aggregationSeriesKeyValue:function(t,a,n,r,l,o){console.log("aggregationSeriesKeyValue",a,n);var s={},i={},d=0;a&&null!=a&&0!=a.lenght||(a=["empty"]);for(var c={},u={},g=0;g<t.length;g++){s[t[g][n]]||(s[t[g][n]]=Array(a.length).fill(0),o&&(i[t[g][n]]=t[g][o.key]),d++);for(var p=0;p<a.length;p++)"sum"==a[p].countingMode?s[t[g][n]][p]+=parseFloat(t[g][a[p].key]):"max"==a[p].countingMode?(c[a[p].key]?c[a[p].key]>parseFloat(t[g][a[p].key])&&(c[a[p].key]=parseFloat(t[g][a[p].key])):c[a[p].key]=parseFloat(t[g][a[p].key]),s[t[g][n]][p]=parseFloat(t[g][a[p].key])):"min"==a[p].countingMode?(u[a[p].key]?u[a[p].key]>parseFloat(t[g][a[p].key])&&(u[a[p].key]=parseFloat(t[g][a[p].key])):u[a[p].key]=parseFloat(t[g][a[p].key]),s[t[g][n]][p]=parseFloat(t[g][a[p].key])):s[t[g][n]][p]++}console.log("dentro",s);var v=e.render.safeColors(d,r,l);console.log("colors",v);for(var f=new Array,p=0;p<a.length;p++){var h=angular.copy(a[p]);h.realKey=h.key,h.key=h.label,h.values=new Array,f.push(h);var m=0;for(var y in s)if(s.hasOwnProperty(y)){var b={key:y,label:y,value:s[y][p]};v&&v.length>0&&"undefined"==typeof h.color&&(b.color=v[m]),o&&(b.description=i[y]),f[p].values.push(b),m++}}return f},aggregationSeriesValueKey:function(t,a,n,r,l){console.log("aggregationSeriesValueKey",a,n);for(var o={},s=0,i=0;i<t.length;i++){o[t[i][n]]||(o[t[i][n]]={values:{}},s++);for(var d=0;d<a.length;d++){o[t[i][n]].values[a[d].key]||(o[t[i][n]].values[a[d].key]={key:a[d].key,label:a[d].label,value:0});var c=t[i][a[d].key];a[d].scale&&(c*=a[d].scale),"sum"==a[d].countingMode?o[t[i][n]].values[a[d].key].value+=parseFloat(c):o[t[i][n]].values[a[d].key].value++}}console.log("dentro",o);var u=e.render.safeColors(s,r,l);console.log("colors",u);var g=new Array,p=0;for(var v in o)if(o.hasOwnProperty(v)){var f={key:v,label:v,values:new Array};u[p]&&(f.color=u[p]),p++;for(var h in o[v].values)o[v].values.hasOwnProperty(h)&&f.values.push(o[v].values[h]);g.push(f)}return console.log("chartData",g),g},aggregationValuesValueKey:function(t,a,n,r,l,o){console.log("aggregationValuesValueKey",a,n,r);var s={},i={};if(a)for(var d=0;d<a.length;d++)i[a[d].value]=a[d];else for(var c="L",u=0;u<t.length;u++){var g=t[u][n.key];i[g]||(i[g]={value:g,label:g,side:c},c="L"==c?"R":"L")}for(var p=0,u=0;u<t.length;u++){var g=t[u][n.key],v=t[u][r.key];i[g]&&(s[g]||(s[g]=i[g],s[g].values={}),s[g].values[v]||(s[g].values[v]={label:v,value:0},p++),s[g].values[v].value++)}console.log("dentro aggregationValuesValueKey",s);var f=e.render.safeColors(p,l,o);console.log("colors",f);var h=new Array,m=0;for(var y in s)if(s.hasOwnProperty(y)){var b={key:s[y].label,label:s[y].label,side:s[y].side,values:new Array};s[y].color?b.color=s[y].color:f[m]&&(b.color=f[m]),m++;for(var w in s[y].values)s[y].values.hasOwnProperty(w)&&b.values.push(s[y].values[w]);h.push(b)}return console.log("chartData aggregationValuesValueKey",h),h},aggregationSeriesXY:function(e,t,a,n){for(var r=new Array,l=0;l<a.length;l++){var o={},s=angular.copy(a[l]);s.values=new Array,n&&n.length>0&&"undefined"==typeof s.color&&(s.color=n[l]);for(var i=0;i<e.length;i++)o[e[i][t.key]]||(o[e[i][t.key]]=0),"sum"==a[l].countingMode?o[e[i][t.key]]+=parseFloat(e[i][a[l].key]):o[e[i][t.key]]++;var d=0;console.log("linechart dataMap",t);for(var c in o)if(o.hasOwnProperty(c)){var u={x:parseInt(c),y:o[c]};s.shape&&(u.shape=s.shape),s.values.push(u),d++}console.log("linechart serie",s),s.key=s.label,r.push(s)}return r},aggregationKeyValue:function(e,t,a,n,r,l){var o=this.aggregationSeriesKeyValue(e,[t],a,n,r,l);return o[0].values},aggregationTree:function(e,t,a,n,r,l,o){console.log("aggregationTree",a);var s={name:e,column:"",absolutedepth:0,children:new Array,valueLabel:n.label};n.countingMode||(n.countingMode="count"),r&&(s.valueLabel2=r.label,r.countingMode||(r.countingMode="count"));for(var i=0;i<t.length;i++){for(var d=new Array,c=0;c<a.length;c++)d.push({k:t[i][a[c].key],c:a[c],d:c});var u=1;if("sum"==n.countingMode&&(u=t[i][n.key]),r){var g=1;"sum"==r.countingMode&&(g=t[i][r.key])}s=this.initTreeNode(s,d,u,g,l,o)}return s},initTreeNode:function(t,a,n,r,l,o){for(var s=t,i=0;i<a.length;i++){var d=a[i].k,c=a[i].c.key,u=a[i].c.label,g=a[i].c.direction?a[i].c.direction:"none",p=this.hasNameInArray(s.children,d);p==-1&&(p=i==a.length-1?r?s.children.push({name:""+d,column:c,label:u,direction:g,absolutedepth:i+1,value:0,value2:0})-1:s.children.push({name:""+d,column:c,label:u,direction:g,absolutedepth:i+1,value:0})-1:s.children.push({name:""+d,column:c,label:u,direction:g,absolutedepth:i+1,children:new Array})-1),s=s.children[p]}return s.value+=parseFloat(n),"undefined"!=typeof l&&l?s.formattedValue=e.render.safeNumber(s.value,l.decimalValue,l.isEuro,l.formatBigNumber):s.formattedValue=s.value,r&&(s.value2+=parseFloat(r),"undefined"!=typeof o&&o?s.formattedValue2=e.render.safeNumber(s.value2,o.decimalValue,o.isEuro,o.formatBigNumber):s.formattedValue2=s.value2),t},hasNameInArray:function(e,t){for(var a=-1,n=0;n<e.length;n++)if(e[n].name==t){a=n;break}return a},aggregationTreeDrill:function(e,t,a,n){for(var r={name:e,column:"",absolutedepth:0,children:new Array},l=0;l<t.length;l++){for(var o=new Array,s=new Array,i=0;i<a.length;i++)o.push({k:t[l][a[i]],c:a[i],d:i});for(var d=0;d<n.length;d++)s.push({k:t[l][n[d].key],c:n[d].key});r=this.initTreeNodeDrill(r,o,s)}return r},initTreeNodeDrill:function(e,t,a){for(var n=e,r=0;r<t.length;r++){var l=t[r].k,o=t[r].c,s=this.hasNameInArray(n.children,l);s==-1&&(s=r==t.length-1?n.children.push({name:""+l,column:o,absolutedepth:r+1})-1:n.children.push({name:""+l,column:o,absolutedepth:r+1,children:new Array})-1),n=n.children[s]}for(var i=0;i<t.length;i++){var d=t[i].c;n[d]||(n[d]=""),n[d]+=t[i].k}for(var c=0;c<a.length;c++){var d=a[c].c;n[d]||(n[d]=0),n[d]+=a[c].k}return e},recursiveTree:function(e,t,a,n){for(var r=e,l=e.absolutedepth,o=r.children.length,s=0;s<o;s++){l<n-2&&(r.children[s]=this.recursiveTree(r.children[s],t,a,n));var i=this.sumKeys(r.children[s],t);for(j=0;j<t.length;j++)r.children[s][t[j]]=i[t[j]];var d=this.sumValues(r.children[s],a);for(j=0;j<a.length;j++)r.children[s][a[j].key]=d[a[j].key]}return r},sumKeys:function(e,t){var a=new Array;for(r=0;r<t.length;r++)a[t[r]]=new Array;for(k=0;k<e.children.length;k++){var n=e.children[k];for(r=0;r<t.length;r++)a[t[r]][k]=n[t[r]]}for(var r=0;r<t.length;r++)a[t[r]]=Array.from(new Set(a[t[r]].sort())).join(", "),a[t[r]]=Array.from(new Set(a[t[r]].split(", "))).sort().join(", ");return a},sumValues:function(e,t){var a=new Array;for(j=0;j<t.length;j++)a[t[j].key]=0;for(k=0;k<e.children.length;k++){var n=e.children[k];for(j=0;j<t.length;j++)"sum"==t[j].counting_mode?a[t[j].key]+=n[t[j].key]:"count"==t[j].counting_mode&&(a[values[j].key]+=1)}return a},aggregationNodesLinks:function(e,t,a,n,r,l){console.info("aggregationNodesLinks");for(var o={},s=[],i=[],d=[],c=[],u=0,g=0;g<e.length;g++)for(var p=0;p<t.length;p++){if("undefined"==typeof i[t[p].key]&&(i[t[p].key]=[]),"undefined"==typeof o[t[p].key+"_"+e[g][t[p].key]]){var v=l,f={name:""+e[g][t[p].key],index:u,label:""+e[g][t[p].key],color:v,fades:!0};if(console.debug("render",t[p]+"_"+f.name),"undefined"!=typeof r&&"undefined"!=typeof r[t[p].key+"_"+f.name]){var h=r[t[p].key+"_"+f.name];void 0!=typeof h.label&&(f.label=h.label),void 0!=typeof h.color&&(f.color=h.color),"true"==h.fades?f.fades=!0:f.fades=!1}s.push(f),i[t[p].key].push({node:e[g][t[p].key],index:u}),u++}o[t[p].key+"_"+e[g][t[p].key]]=0}console.debug("nodes",s),console.debug("matrix",i);for(var g=0;g<e.length;g++)for(var p=0;p<t.length;p++)if(p<t.length-1)for(var m=t[p].key,y=0;y<i[m].length;y++)for(var b=i[m][y],w=0;w<i[t[p+1].key].length;w++){var x=i[t[p+1].key][w];if("undefined"==typeof c[m+"|"+b.node+"|"+x.node]&&(c[m+"|"+b.node+"|"+x.node]={source:b.index,target:x.index,value:0}),e[g][t[p].key]==b.node&&e[g][t[p+1].key]==x.node){var k="sum"==n?parseFloat(e[g][a]):1;c[m+"|"+b.node+"|"+x.node].value+=k}}console.debug("linksDictionary",c);for(var m in c)0!=c[m].value&&d.push(c[m]);return{nodes:s,links:d}},aggregationForcedirected:function(e,t,a){var n=new Array;if(t){for(var r={},l=0;l<t.length;l++)for(var o=t[l].source,s=t[l].sourceType,i=t[l].target,d=t[l].targetType,c=t[l].relationType,u=t[l].color?t[l].color:a[l],g=t[l].linkLine?t[l].linkLine:null,p=0;p<e.length;p++){var v=e[p][o],f=e[p][i];r[v+"_"+f]||(r[v+"_"+f]={}),r[v+"_"+f]={source:v,sourceType:s,target:f,targetType:d,type:c,color:u,linkLine:g}}for(var h in r)r.hasOwnProperty(h)&&n.push(r[h])}return console.log("links",n),n}},geo:{fitGeojson:function(t,a,n,r){var l=d3.geo.centroid(t),o=e.geo.getProjection(1,l,[0,0],r),s=d3.geo.path().projection(o),i=s.bounds(t),d=.95/Math.max((i[1][0]-i[0][0])/a,(i[1][1]-i[0][1])/n),c=[(a-d*(i[1][0]+i[0][0]))/2,(n-d*(i[1][1]+i[0][1]))/2];return console.log("offset s c t ",d,l,c),d3.geo.path().projection(e.geo.getProjection(d,l,c,r))},getProjection:function(e,t,a,n){return n?"azimuthalEqualArea"==n?d3.geo.azimuthalEqualArea().scale(e).center(t).translate(a):"azimuthalEquidistant"==n?d3.geo.azimuthalEquidistant().scale(e).center(t).translate(a):"conicConformal"==n?d3.geo.conicConformal().scale(e).center(t).translate(a):"conicEqualArea"==n?d3.geo.conicEqualArea().scale(e).center(t).translate(a):"conicEquidistant"==n?d3.geo.conicEquidistant().scale(e).center(t).translate(a):"equirectangular"==n?d3.geo.equirectangular().scale(e).center(t).translate(a):"gnomonic"==n?d3.geo.gnomonic().scale(e).center(t).translate(a):"orthographic"==n?d3.geo.orthographic().scale(e).center(t).translate(a):"stereographic"==n?d3.geo.stereographic().scale(e).center(t).translate(a):d3.geo.mercator().scale(e).center(t).translate(a):d3.geo.mercator().scale(e).center(t).translate(a)}},svg:{createSvg:function(e,t,a,n,r,l){console.log("svgAttrs",e);var o=document.createElementNS("http://www.w3.org/2000/svg","svg");for(var s in e)o.setAttribute(s,e[s]);var i=document.createElementNS("http://www.w3.org/2000/svg",t);for(var s in a)i.setAttribute(s,a[s]);if(n&&o.appendChild(n),o.appendChild(i),r){var d=document.createElementNS("http://www.w3.org/2000/svg","text");for(var s in l)d.setAttribute(s,l[s]);d.textContent=r,o.appendChild(d)}return o},updateSvg:function(e,t,a,n,r,l){var o=(new DOMParser).parseFromString(e,"text/xml").children[0];for(var s in t)o.setAttribute(s,t[s]);n&&o.appendChild(n);for(var i=0;i<=o.childNodes.length;i++)if("g"==o.childNodes[i].nodeName||"path"==o.childNodes[i].nodeName){el=o.childNodes[i];break}for(var s in a)el.setAttribute(s,a[s]);if(o.appendChild(el),r){var d=document.createElementNS("http://www.w3.org/2000/svg","text");for(var s in l)d.setAttribute(s,l[s]);d.textContent=r,o.appendChild(d)}return o},createPercentage:function(e,t,a,n,r,l,o){var s=document.createElementNS("http://www.w3.org/2000/svg","defs"),i=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");i.setAttribute("id",e+"bg"),i.setAttribute("x1","0%"),i.setAttribute("y2","0%"),i.setAttribute("gradientUnits","userSpaceOnUse"),"horizontal"==l?(i.setAttribute("y1","0%"),i.setAttribute("x2","100%")):(i.setAttribute("y1","100%"),i.setAttribute("x2","0%"));var d=document.createElementNS("http://www.w3.org/2000/svg","stop");d.setAttribute("offset",t),d.setAttribute("stop-color",a);var c=document.createElementNS("http://www.w3.org/2000/svg","stop");c.setAttribute("offset",t),c.setAttribute("stop-color",n);var u=document.createElementNS("http://www.w3.org/2000/svg","animate");u.setAttribute("dur","0.5s"),u.setAttribute("attributeName","offset"),u.setAttribute("fill","freeze"),u.setAttribute("from","0"),u.setAttribute("to",t),d.appendChild(u),i.appendChild(d),c.appendChild(angular.copy(u)),i.appendChild(c),s.appendChild(i);var g=document.createElementNS("http://www.w3.org/2000/svg","linearGradient");g.setAttribute("id",e+"stroke");var p=document.createElementNS("http://www.w3.org/2000/svg","stop");return p.setAttribute("offset","0"),p.setAttribute("stop-color",r),g.appendChild(p),s.appendChild(g),s},createText:function(e,t,a){},sizeAttrs:function(e,t,a){var n={};switch(e){case"ellipse":n.cx=t/4+1,n.cy=a/4,n.rx=t/4,n.ry=a/4;break;case"circle":n.cx=(t>a?a:t)/4+1,n.cy=(t>a?a:t)/4,n.r=(t>a?a:t)/4;break;default:n.width=t,n.height=a}return n},baseSize:function(e){var t=0,a=0;if(e)for(var n=e.split(" "),r=0;r<n.length;r++){var l=parseFloat(n[r].split(",")[0]),o=parseFloat(n[r].split(",")[1]);t=l>t?l:t,a=o>a?o:a}return[t,a]}},event:{createEvent:function(e,t,a,n,r){return{sourceId:e,widget:t,eventtype:a,data:n,eventControlId:r}},clearArrayTextFilter:function(e,t){if(e)for(var a in e)a.startsWith(t)&&delete e[a];return e},updateTextFilter:function(e,t,a){var n="";e&&(n=e);for(var r in t)if(t.hasOwnProperty(r)){var l=t[r];if(l.value&&null!=l.value&&""!=l.value){""!=n&&(n+=" and ");"number"==a[l.column]?"":"'";n+="number"==a[l.column]?l.advanced?l.column+" "+l.advanced+" "+l.value:l.value+" eq "+l.column:l.advanced?"startWith"==l.advanced?"startswith("+l.column+",'"+l.value+"')":"endWith"==l.advanced?"endswith("+l.column+",'"+l.value+"')":"'"+l.value+"' eq "+l.column:"(substringof('"+l.value+"',"+l.column+") eq true)"}}return console.log("filter",n),n},readWidgetEventAttr:function(e){var t={};return angular.forEach(e,function(e,a){a.startsWith("evt")&&(t[a]=e)}),t},ignoreEvent:function(e,t){console.debug("ignoreEvent: event",e),console.debug("ignoreEvent: eventconfig",t);var a=!1,n={"dataset.change.group_by_column":"evtChangeGroupbycolumn","dataset.change.value_column":"evtChangeValuecolumn","dataset.filter.text":"evtFiltertext","dataset.filter.odata":"evtFilterodata","dataset.de_highlight.group_by_column":"evtHighlightGroupbycolumn","dataset.highlight.group_by_column":"evtDehighlightGroupbycolumn"},r=n[e.eventtype],l={enabled:!0,onlySameDataset:!1};if(t[r]&&(l=JSON.parse(t[r])),r){if(l.enabled!==!0)a=!0;else if(e.eventControlId&&t.evtAcceptedControlIds&&t.evtAcceptedControlIds.length>2){a=!0;for(var o=JSON.parse(t.evtAcceptedControlIds),s=0;s<o.length;s++)if(e.eventControlId==o[s]){a=!1;break}}!a&&l.onlySameDataset&&(a=!e.data.datasetcode||e.data.datasetcode!=datasetcode)}return a}}};return e}]);var WebsocketStompSingleton=function(){var e=null,t=[],a=[],n=!1,r=function(){for(var e=0;e<a.length;e++){var n=a[e];debug&&console.debug(":::: Unsubscribe for ::::",n),n.unsubscribe()}t=[],a=[]},l=function(e,o){console.debug("createClient");var s=e,i=Stomp.client(s.ws_url),d=Constants.WEB_SOCKET_USER,c=Constants.WEB_SOCKET_SECRET;return console.debug("intSettings",s),s.user_token&&null!=s.user_token&&""!=s.user_token&&(d="Bearer "+s.user_token,c=""),console.debug("user = ",d),i.connect(d,c,function(e){console.debug("connet 2 - SubscriptionList",t);for(var r=0;r<t.length;r++){var l=t[r];console.debug(":::: subscribe for ::::",l),a.push(i.subscribe(l.keyTopic,l.keyCallback))}console.debug(":::: Finish with the subscribe:::::"),n=!0},function(e){console.info("frame",e),o<5?(console.debug("createClient count ::::::::::::: ",o),setTimeout(function(){l(s,++o)},1e3*o),console.debug("awake.. ")):console.error(":::: connection error::::")}),{getWebClient:function(){return i},addSubscription:function(e,a,r,l){n?(console.debug(":::: addSubscription Client connected::::",e,a),t.push({keyTopic:e,keyCallback:a,keyTenantCode:r,keyDataCallbackIndex:l}),i.subscribe(e,a)):(console.debug(":::: addSubscription Client NOT connected Add to SubscriptionList::::"),t.push({keyTopic:e,keyCallback:a,keyTenantCode:r,keyDataCallbackIndex:l}))},cancelAllSubscriptionsmetadata:r}};return{getInstance:function(t,a){
return console.debug("clientInstance",e),e&&null!=e?e:t?(e||(console.debug("::::  New Stomp Client Created ::::"),e=l(t,1)),e):null}}}();yuccaWidgetsModule.directive("collapsibleTree",function(e,t){return{restrict:"E",scope:{data:"=",selected:"@",columns:"=",widgetId:"@",rowDepth:"@",updateCallback:"&updateCallback"},template:'<div id="collapsibleTree{{panelIndex}}" class="collapsible-tree-container" style="min-width:{{svgWidth}}px; border: solid 0px red; display: inline-block"></div>',link:function(e,a,n){console.log("attr",n),console.log("elem",a),console.log("scope",e),e.panelIndex=Math.floor(1e4*Math.random()+1);var r,l={top:0,right:0,bottom:0,left:0},o="undefined"!=typeof n.fixHeight&&"true"==n.fixHeight,s=0,i=n.rowHeight?n.rowHeight:32,d=n.rowDepth?parseInt(n.rowDepth):160,c=n.radius?parseInt(n.radius):i/3,u={},g="undefined"!=typeof n.startClosed&&"true"==n.startClosed,p=n.nodeOffsetX?parseInt(n.nodeOffsetX):0;e.$watch("data",function(){function a(a,n){if(console.log("onAreaClick ignoreClick",a,k),k)k=!1;else{console.log("data",e.data);var r=[];for(var l in a)a.hasOwnProperty(l)&&r.push(a[l].value);r.push(e.data.name),n||r.shift();var o={sourceId:e.widgetid,eventtype:"dataset.browse",data:{browseHistory:a,path:r.reverse()},widget:"collapsibletree"};t.$broadcast("yucca-collapsibletree-event",o),console.log("yucca-collapsibletree-event",o)}}function f(e){e.children&&(e.children.forEach(f),m(e))}function h(t){function l(e,t){return e.parent&&(t.push({column:e.column,value:e.name}),t=l(e.parent,t)),t}console.info("source",t);var g=d3.event&&d3.event.altKey?5e3:500,f=new Array;f[0]=1;var b=function(e,t){t.children&&t.children.length>0&&(f.length<=e+1&&f.push(0),f[e+1]+=t.children.length,t.children.forEach(function(t){b(e+1,t)}))};b(0,r);var k=d3.max(f)*i;o&&d3.select("#collapsibleTree"+e.panelIndex).attr("style","height:"+k+"px"),d3.select("#collapsibleTree"+e.panelIndex+" svg").attr("height",k),w=w.size([k,y]);var C=w.nodes(r).reverse();console.log("nodes root",r,C),C.forEach(function(e){var t=D.append("svg:text").attr("id","invisible").attr("class",e.cssClass).attr("x",0).attr("y",0).attr("dy",".35em");t.append("svg:tspan").attr("class",e.title+" title").text(e.name+" "),t.append("svg:tspan").attr("class",e.title+" subtitle").text("undefined"!=typeof e.subtitle&&null!=e.subtitle?e.subtitle:"");var a=parseInt(t.node().getBBox().width+4*c);e.titleLength=a,d3.select("#invisible").remove(),"undefined"==typeof u["depth_"+e.depth]?u["depth_"+e.depth]={current:e.children||e._children?a:d}:a>u["depth_"+e.depth].current&&(e.children||e._children)&&(u["depth_"+e.depth]={current:a});var n=0;console.log("maxWidth",n)});var I=0;C.forEach(function(e){e.y=0;for(var t=0;t<=e.depth;t++)e.y+=u["depth_"+t].current+p;I+=e.children&&null!=e.children?e.children.length:0}),console.log("levelDepth",u),_=0==I;var M=D.selectAll("g.node").data(C,function(e){return e.id||(e.id=++s)}),L=M.enter().append("svg:g").attr("class",function(e){return"node node_depth_"+e.depth}).attr("transform",function(e){return"translate("+t.y0+","+t.x0+")"});L.append("svg:circle").attr("r",1e-6).attr("class",function(e){return"node_circle "+(e._children?"full":"empty")+"circle_depth_"+e.depth}).on("click",function(e){m(e),h(e);var t=!!e.children;a(l(e,new Array),t)});var T=L.append("svg:text").attr("id",function(e){return"text_"+e.depth+"_"+e.id}).attr("x",function(e){return e.children||e._children?-i/2:i/2}).attr("dy",".35em").attr("text-anchor",function(e){return e.children||e._children?"end":"start"}).attr("class",function(e){return e.cssClass+" title_depth_"+e.depth}).on("click",function(e){e.action(e.filter)});if(T.append("svg:title").attr("class",function(e){return v(e.name)+" tooltip"}).text(function(e){return"undefined"!=typeof e.tooltip&&null!=e.tooltip?e.tooltip:""}),T.append("svg:tspan").attr("class",function(e){return console.debug("tree ",e),v(e.name)+" title"}).text(function(e){return e.name+" "}),T.append("svg:tspan").attr("class",function(e){return v(e.name)+" subtitle"}).text(function(e){return"undefined"!=typeof e.subtitle&&null!=e.subtitle?e.subtitle:""}),!n.hideValues||"true"!=n.hideValues){T.append("svg:tspan").attr("class",function(e){return v(e.name)+" value_separator"}).text(function(e){return"undefined"!=typeof e.formattedValue&&null!=e.formattedValue?" - ":""});var $=T.append("svg:tspan").attr("class",function(e){return v(e.name)+" value"}).text(function(e){return"undefined"!=typeof e.formattedValue&&null!=e.formattedValue?e.formattedValue:""});n.valueNotColored&&"true"==n.valueNotColored||$.style("fill",function(e){return e.color})}var E=M.transition().duration(g).attr("transform",function(e){return"translate("+e.y+","+e.x+")"});E.select("circle").attr("r",c).attr("class",function(e){return"node_circle "+(e._children?"full":"empty")+" circle_depth_"+e.depth}).style("stroke",function(e){return e.color}),E.select("text").style("fill-opacity",1),E.select("tspan").style("fill-opacity",1);var S=M.exit().transition().duration(g).attr("transform",function(e){return"translate("+t.y+","+t.x+")"}).remove();S.select("circle").attr("r",1e-6),S.select("text").style("fill-opacity",1e-6);var V=D.selectAll("path.link").data(w.links(C),function(e){return e.target.id});V.enter().insert("svg:path","g").attr("class","link").attr("d",function(e){var a={x:t.x0,y:t.y0};return x({source:a,target:a})}).transition().duration(g).attr("d",x),V.transition().duration(g).attr("d",x),V.exit().transition().duration(g).attr("d",function(e){var a={x:t.x,y:t.y};return x({source:a,target:a})}).remove(),C.forEach(function(e){e.x0=e.x,e.y0=e.y}),e.updateCallback&&e.updateCallback({isRoot:_})}function m(e){e.children?(e._children=e.children,e.children=null):(e.children=e._children,e._children=null)}console.log("attr.width in",n.width);var y="undefined"==typeof n.width||null==n.width?800:parseInt(n.width),b="undefined"==typeof n.height||null==n.height?50:parseInt(n.height);b=b-l.top-l.bottom,console.log("width in",y),console.log("ssdata",e.data);var w=d3.layout.tree().size([b,y]),x=d3.svg.diagonal().projection(function(e){return[e.y,e.x]}),k=!1;d3.select("#collapsibleTree"+e.panelIndex+" svg").remove();var D=d3.select("#collapsibleTree"+e.panelIndex).append("svg").attr("width",y).attr("height",b+l.top+l.bottom).append("g").attr("transform","translate("+l.left+","+l.top+")");r=e.data,r.x0=b/2,r.y0=0,r.children&&r.children.forEach(f),g&&m(r),h(r);var _=!0});var v=function(e){return e?e.replace(/[^A-Z0-9]+/gi,"_").toLowerCase():""}}}}),yuccaWidgetsModule.directive("collapsibleTreeBoxes",function(e,t){return{restrict:"E",scope:{data:"=",selected:"@",columns:"=",widgetId:"@",boxShadow:"=",updateCallback:"&updateCallback"},template:'<div id="collapsibleTreeBoxes{{panelIndex}}" class="collapsible-tree-boxes-container"></div> <div id="panel-{{panelIndex}}-fake"></div>',link:function(e,t,a){function n(t){function n(e,t){return"left"==e||"both"==e?t?"url(#start-arrow-selected)":"url(#start-arrow)":""}function r(e,t){return"right"==e||"both"==e?t?"url(#end-arrow-selected)":"url(#end-arrow)":""}var l=h.nodes(f).reverse(),u=h.links(l);s(h.nodes(f),i);var p=0;l.forEach(function(e){e.y=e.depth*(1.5*w.width);var t=e.x+w.height(e.name)+4;p=p<t?t:p}),console.log("maxHeight",p),L.attr("height",p+m.top+m.bottom);var v=E.selectAll("g.node").data(l,function(e){return e.id||(e.id=++k)}),b=S.selectAll("g").data(l,function(e){return e.id||(e.id=++k)}),_=v.enter().insert("g","g.node").attr("class","node").attr("transform",function(e){return"translate("+t.y0+","+t.x0+")"}).on("click",function(e){o(e)}),C=(b.enter().append("g").attr("transform",function(e){return"translate("+t.y0+","+t.x0+")"}),_.append("g").append("rect").attr("rx",y).attr("ry",y).attr("width",w.width).attr("height",function(e){return w.height(e.name)}).attr("class","node-rect").attr("stroke",function(e){return e.color?e.color:"#ccc"}));e.boxShadow&&C.attr("filter","url(#drop-shadow)"),_.append("foreignObject").attr("x",w.textMargin).attr("y",w.textMargin).attr("width",function(){return w.width-2*w.textMargin<0?0:w.width-2*w.textMargin}).attr("height",function(e){return w.height(e.name)-2*w.textMargin<0?0:w.height(e.name)-2*w.textMargin}).append("xhtml").html(function(e){return'<div style="width: '+(w.width-2*w.textMargin)+"px; height: "+(w.height(e.name)-2*w.textMargin)+'px;" class="node-text wordwrap"><b>'+e.name+"</b></div>"}).on("mouseover",function(e){$("#nodeInfoID"+e.id).css("visibility","visible"),$("#nodeInfoTextID"+e.id).css("visibility","visible")}).on("mouseout",function(e){$("#nodeInfoID"+e.id).css("visibility","hidden"),$("#nodeInfoTextID"+e.id).css("visibility","hidden")});var I=(_.append("g").append("text").attr("x",4*w.textMargin+w.width).attr("y",function(e){return w.textMargin+w.height(e.name)/2}).attr("width",w.width).attr("height",function(e){return w.height(e.name)}).attr("class","node-value").attr("fill",function(e){return e.color?e.color:"#ccc"}).text(function(e){return e.formattedValue}).style("visibility",function(e){return e.formattedValue&&"true"!=a.hideValues?"visible":"hidden"}),_.append("g").append("line").attr("x1",w.width+1).attr("y1",function(e){return w.height(e.name)/2}).attr("x2",3*w.textMargin+w.width).attr("y2",function(e){return w.height(e.name)/2}).attr("class","node-value-link").attr("stroke",function(e){return e.color?e.color:"#ccc"}).style("visibility",function(e){return e.formattedValue&&"true"!=a.hideValues?"visible":"hidden"}),v.transition().duration(D).attr("transform",function(e){return"translate("+e.y+","+e.x+")"}));I.select("rect").attr("class",function(e){return e._children?"node-rect-closed":"node-rect"}).style("fill-opacity",.1).style("fill",function(e){return e.color}),I.select("text").style("fill-opacity",1);var M=v.exit().transition().duration(D).attr("transform",function(e){return"translate("+t.y+","+t.x+")"}).remove();b.exit().transition().duration(D).attr("transform",function(e){return"translate("+t.y+","+t.x+")"}).remove(),M.select("text").style("fill-opacity",1e-6);var T=V.selectAll("path").data(u,function(e){return e.target.id}),N=A.selectAll("g").data(u,function(e){return e.target.id});d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})};T.enter().insert("path","g").attr("class","link").attr("id",function(e){return"linkID"+e.target.id}).attr("d",function(e){return g(e)}).attr("marker-end",function(e){return r(e.target.direction,!1)}).attr("marker-start",function(e){return n(e.target.direction,!1)}).on("mouseover",function(e){d3.select(this).moveToFront(),d3.select(this).attr("marker-end",r(e.target.direction,!0)),d3.select(this).attr("marker-start",n(e.target.direction,!0)),d3.select(this).attr("class","linkselected"),$("#tooltipLinkID"+e.target.id).attr("x",(e.target.y+w.width-e.source.y)/2+e.source.y),$("#tooltipLinkID"+e.target.id).attr("y",(e.target.x-e.source.x)/2+e.source.x),$("#tooltipLinkID"+e.target.id).css("visibility","visible"),$("#tooltipLinkTextID"+e.target.id).css("visibility","visible")}).on("mouseout",function(e){d3.select(this).attr("marker-end",r(e.target.direction,!1)),d3.select(this).attr("marker-start",n(e.target.direction,!1)),d3.select(this).attr("class","link"),$("#tooltipLinkID"+e.target.id).css("visibility","hidden"),$("#tooltipLinkTextID"+e.target.id).css("visibility","hidden")});N.enter().append("rect").attr("id",function(e){return"tooltipLinkID"+e.target.id}).attr("class","tooltip-box").style("fill-opacity",.8).attr("x",function(e){return(e.target.y+w.width-e.source.y)/2+e.source.y}).attr("y",function(e){return(e.target.x-e.source.x)/2+e.source.x}).attr("width",x.width).attr("height",x.height).on("mouseover",function(e){$("#tooltipLinkID"+e.target.id).css("visibility","visible"),$("#tooltipLinkTextID"+e.target.id).css("visibility","visible"),$("#linkID"+e.target.id).attr("class","linkselected"),$("#linkID"+e.target.id).attr("marker-end",r(e.target.direction,!0)),$("#linkID"+e.target.id).attr("marker-start",n(e.target.direction,!0)),d()}).on("mouseout",function(e){$("#tooltipLinkID"+e.target.id).css("visibility","hidden"),$("#tooltipLinkTextID"+e.target.id).css("visibility","hidden"),$("#linkID"+e.target.id).attr("class","link"),$("#linkID"+e.target.id).attr("marker-end",r(e.target.direction,!1)),$("#linkID"+e.target.id).attr("marker-start",n(e.target.direction,!1)),c()}),N.enter().append("text").attr("id",function(e){return"tooltipLinkTextID"+e.target.id}).attr("class","tooltip-text").attr("x",function(e){return(e.target.y+w.width-e.source.y)/2+e.source.y+x.textMargin}).attr("y",function(e){return(e.target.x-e.source.x)/2+e.source.x+2*x.textMargin}).attr("width",x.width).attr("height",x.height).style("fill","white").append("tspan").text(function(e){return e.label}).append("tspan").attr("x",function(e){return(e.target.y+w.width-e.source.y)/2+e.source.y+2*x.textMargin}).attr("dy","0.75em").text(function(e){return e.target.label});T.transition().duration(D).attr("d",function(e){return g(e)});N.transition().duration(D).attr("d",function(e){return g(e)}),T.exit().transition().remove(),N.exit().transition().remove(),l.forEach(function(e){e.x0=e.x,e.y0=e.y})}function r(){var e=1,t=d3.event.translate,a=-C*e,n=C*e,r=(-_+m.right)*e,l=(_-m.left)*e;t=[Math.max(Math.min(t[0],l),r),Math.max(Math.min(t[1],n),a)],d3.select(".drawarea").attr("transform","translate("+t+") scale("+e+")")}function l(e){e.children?(e._children=e.children,e.children=null):(e.children=e._children,e._children=null)}function o(e){e.children?(e._children=e.children,e.children=null):(e.children=e._children,e._children=null),n(e)}function s(e,t){var a=0;if(e&&e.length>0){var n=e[0].depth,r=[],l=[];for(r.push(e[0]);r.length>0;){var o=r.shift();if(o.depth>n&&(t(l),n++,a=Math.max(a,l.length),l=[]),l.push(o),o.children)for(var s=0;s<o.children.length;s++)r.push(o.children[s])}return t(l),Math.max(a,l.length)}return 0}function i(e){var t=5;if(e)for(var a=0;a<e.length-1;a++)e[a+1].x-(e[a].x+w.height(e[a].name))<t&&(e[a+1].x=e[a].x+w.height(e[a].name)+t)}function d(){I=d3.select("#collapsibleTreeBoxes"+e.panelIndex).select("svg").on("mousedown.zoom"),d3.select("#collapsibleTreeBoxes"+e.panelIndex).select("svg").on("mousedown.zoom",null)}function c(){d3.select("#collapsibleTreeBoxes"+e.panelIndex).select("svg").on("mousedown.zoom",I)}function u(){return d3.select("#collapsibleTreeBoxes"+e.panelIndex).select("svg").on("wheel.zoom")?(M="wheel.zoom",d3.select("#collapsibleTreeBoxes"+e.panelIndex).select("svg").on("wheel.zoom")):null!=d3.select("#collapsibleTreeBoxes"+e.panelIndex).select("svg").on("mousewheel.zoom")?(M="mousewheel.zoom",d3.select("#collapsibleTreeBoxes"+e.panelIndex).select("svg").on("mousewheel.zoom")):d3.select("#collapsibleTreeBoxes"+e.panelIndex).select("svg").on("DOMMouseScroll.zoom")?(M="DOMMouseScroll.zoom",d3.select("#collapsibleTreeBoxes"+e.panelIndex).select("svg").on("DOMMouseScroll.zoom")):void 0}function g(e){var t="both"==e.target.direction||"right"==e.target.direction?12:2,a="both"==e.target.direction||"left"==e.target.direction?12:2,n={x:e.source.x+w.height(e.name)/2,y:e.source.y+w.width+a},r={x:e.target.x+w.height(e.name)/2,y:e.target.y-t},l=(n.y+r.y)/2,o=[n,{x:n.x,y:l},{x:r.x,y:l},r];return o=o.map(function(e){return[e.y,e.x]}),"M"+o[0]+"C"+o[1]+" "+o[2]+" "+o[3]}function p(){var e=N.append("filter").attr("id","drop-shadow").attr("color-interpolation-filters","sRGB");e.append("feOffset").attr("result","offOut").attr("in","SourceGraphic").attr("dx",0).attr("dy",0),e.append("feGaussianBlur").attr("stdDeviation",2),e.append("feOffset").attr("dx",2).attr("dy",2).attr("result","shadow"),e.append("feComposite").attr("in","offOut").attr("in2","shadow").attr("operator","over")}function v(){N.append("marker").attr("id","end-arrow").attr("viewBox","0 -5 10 10").attr("refX",0).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").attr("class","arrow").append("path").attr("d","M0,-5L10,0L0,5"),N.append("marker").attr("id","end-arrow-selected").attr("viewBox","0 -5 10 10").attr("refX",0).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").attr("class","arrowselected").append("path").attr("d","M0,-5L10,0L0,5"),N.append("marker").attr("id","start-arrow").attr("viewBox","-10 -5 10 10").attr("refX",0).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").attr("class","arrow").append("path").attr("d","M0,-5L-10,0L0,5"),N.append("marker").attr("id","start-arrow-selected").attr("viewBox","-10 -5 10 10").attr("refX",0).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").attr("class","arrowselected").append("path").attr("d","M0,-5L-10,0L0,5")}console.log("attr",a),console.log("elem",t),console.log("scope",e),e.panelIndex=Math.floor(1e4*Math.random()+1);var f,h,m={top:0,right:0,bottom:0,left:0},y=a.boxRadius?a.boxRadius:6,b=a.rowDepth?parseInt(a.rowDepth):120,w={width:b,height:function(t){if(t){var a=angular.element(document.querySelector("#panel-"+e.panelIndex+"-fake"));a.html('<div style="padding: 3px;width: '+b+'px; display: inline-block" class="node-text wordwrap"><b>'+t+"</b></div>");var n=1.3*a[0].offsetHeight;return a.html(""),n<45?45:n}return 45},textMargin:5},x={width:150,height:30,textMargin:5},k=0,D=750,_="undefined"==typeof a.width||null==a.width?800:parseInt(a.width),C="undefined"==typeof a.height||null==a.height?50:parseInt(a.height);e.$watch("data",function(){function t(e){e.children&&(e.children.forEach(t),l(e))}console.log("attr.width in",a.width),C=C-m.top-m.bottom,console.log("width in",_),h=d3.layout.tree().size([C,_]),f=e.data,f.x0=C/2,f.y0=0;var o=0,i=s(h.nodes(f),function(e){o++});C=i*(w.height()+20)+x.height+20-m.right-m.left,_=o*(1.5*w.width)+x.width/2-m.top-m.bottom,d3.select("#collapsibleTreeBoxes"+e.panelIndex+" svg").remove(),L=d3.select("#collapsibleTreeBoxes"+e.panelIndex).append("svg").attr("width",_+m.right+m.left).attr("height",C+m.top+m.bottom).attr("class","svgContainer").call(d3.behavior.zoom().on("zoom",r)),u(),d3.select("#collapsibleTreeBoxes"+e.panelIndex).select("svg").on(M,null),d3.select("#collapsibleTreeBoxes"+e.panelIndex).select("svg").on("dblclick.zoom",null),T=L.append("g").attr("class","drawarea").append("g").attr("transform","translate("+m.left+","+m.top+")"),E=T.append("g").attr("id","nodes"),V=T.append("g").attr("id","links"),A=T.append("g").attr("id","linksTooltips"),S=T.append("g").attr("id","nodesTooltips"),N=L.append("defs"),v(),p(),f.children&&f.children.forEach(t),n(f)});var I,M,h,L,T,E,S,V,A,N}}}),yuccaWidgetsModule.directive("forcedirectedChart",function(){return{restrict:"E",scope:{links:"="},template:'<div class="forcedirected-chart"><div id="forcedirectedPanel{{panelIndex}}" class="forcedirected-canvas"></div><div class="forcedirected-legend"><div class="forcedirected-legend-block {{block.name}}" ng-repeat="block in legendBlocks"><div class="forcedirected-legend-block-title">{{block.label}}</div><span ng-repeat="n in block.items track by $index" class="forcedirected-legend-item legend_{{n.clazz}}"><span class="forcedirected-legend-{{n.type}}" style="{{n.style}}"></span><span>{{n.label}}</span></div>',link:function(e,t,a){function n(e,t,a){return"M "+e+" "+t+" m -"+a+", 0 a "+a+","+a+" 0 1,0 "+2*a+",0 a "+a+","+a+" 0 1,0 -"+2*a+",0"}function r(e,t,a){var n=a*Math.sin(Math.PI/3),r=new Array;r.push({x:e-a,y:t}),r.push({x:e-a/2,y:t+n}),r.push({x:e+a/2,y:t+n}),r.push({x:parseInt(e)+parseInt(a),y:t}),r.push({x:e+a/2,y:t-n}),r.push({x:e-a/2,y:t-n}),r.push({x:e-a,y:t});for(var l="M 0 0",o=0;o<r.length;o++){var s=r[o];l+="L"+s.x+" "+s.y+" "}return l+" Z"}function l(e){var t=a.linkLine;return e.linkLine&&(t=e.linkLine),"bezier"==t?d(e):"arc"==t?o(e):"straight"==t?s(e):d(e)}function o(e){var t=e.target.x-e.source.x,a=e.target.y-e.source.y,n=Math.sqrt(t*t+a*a);return"M"+e.source.x+","+e.source.y+"A"+n+","+n+" 0 0,1 "+e.target.x+","+e.target.y}function s(e){return"M"+e.source.x+","+e.source.y+"L"+e.target.x+","+e.target.y}function i(e){return e.replace(/[^\w\s]/gi,"")}function d(e){var t=.5,a=d3.interpolateNumber(e.source.x,e.target.x),n=a(t),r=a(1-t);return"M"+e.source.x+","+e.source.y+"C"+n+","+e.source.y+" "+r+","+e.target.y+" "+e.target.x+","+e.target.y}function c(e){return"translate("+e.x+","+e.y+")"}console.log("forcedirectedChart attr",a),e.panelIndex=Math.floor(1e4*Math.random()+1);var u={top:8,right:8,bottom:8,left:8},g=function(e,t){return"hexagon"==e?r(0,0,t):n(0,0,t)},p=e.$eval(a.nodeTypes);console.log("nodeTypeIcon",p),"undefined"!=typeof a.linkLine&&null!==a.linkLine||(a.linkLine="bezier");var v=120;"undefined"!=typeof a.linkLength&&null!==a.linkLength&&"null"!==a.linkLength&&""!==a.linkLength&&(v=a.linkLength);var f=6,h=Math.round(f+f/2);"undefined"!=typeof a.nodeSize&&null!==a.nodeSize&&"null"!==a.nodeSize&&""!==a.nodeSize&&(h=a.nodeSize,f=Math.round(2*h/3)),e.$watch("links",function(){function t(e){x.attr("d",l),k.attr("transform",c),D.attr("transform",c)}var n="undefined"==typeof a.width||null===a.width?500:parseInt(a.width),r="undefined"==typeof a.height||null===a.height?500:parseInt(a.height);console.log("forcedirected - width: "+n+" height: "+r),r=r-u.top-u.bottom;var o=e.links,s={},d={};e.legendBlocks={Links:{items:[],name:"force-directed-links",label:""},Series:{items:[],name:"force-directed-series",label:""}};var f={};o.forEach(function(t){var a="circle";"undefined"!=typeof p&&null!==p&&"undefined"!=p[t.sourceType]&&(a=p[t.sourceType]),t.source=s[t.source+"_"+t.sourceType]||(s[t.source+"_"+t.sourceType]={name:t.source,type:t.sourceType,label:t.sourceLabel,count:0,radius:h,nodeIcon:a}),s[t.source.name+"_"+t.sourceType].count+=t.count,a="circle","undefined"!=typeof p&&null!==p&&"undefined"!=p[t.sourceType]&&(a=p[t.targetType]),t.target=s[t.target+"_"+t.targetType]||(s[t.target+"_"+t.targetType]={name:t.target,type:t.targetType,label:t.targetLabel,count:0,radius:h,nodeIcon:a}),s[t.target.name+"_"+t.targetType].count+=t.count,"undefined"==typeof d[t.type]&&(d[t.type]=t.type,e.legendBlocks.Links.items.push({type:"link",label:t.type,clazz:"links_"+i(t.type.split(" ").join("_")).toLowerCase(),style:"background-color: "+t.color})),f[t.sourceType]||(f[t.sourceType]=t.sourceType),f[t.targetType]||(f[t.targetType]=t.targetType)});for(var m in f)f.hasOwnProperty(m)&&e.legendBlocks.Series.items.push({type:"serie",label:f[m],clazz:"serie_"+i(f[m].split(" ").join("_")).toLowerCase()});for(var m in s)if(s.hasOwnProperty(m)){var y=s[m].type;"undefined"==typeof e.legendBlocks[y]&&(e.legendBlocks[y]={name:"force-directed-nodes node_"+y,label:s[m].label,items:[]}),e.legendBlocks[y].items.push({type:"node",label:s[m].name,clazz:"serie_"+s[m].type+" node_"+i((""+s[m].name).split(" ").join("_"))})}var b=d3.layout.force().nodes(d3.values(s)).links(o).size([n,r]).linkDistance(v).charge(-800).on("tick",t).start();d3.select("#forcedirectedPanel"+e.panelIndex+" svg").remove();var w=d3.select("#forcedirectedPanel"+e.panelIndex).append("svg").attr("class","forcedirected-chart").attr("width",n+u.left+u.right).attr("height",r+u.top+u.bottom),x=w.append("g").selectAll("path").data(b.links()).enter().append("path").attr("class",function(e){return"link link_"+e.type+" source_"+i((""+e.source.name).split(" ").join("_"))+" target_"+i((""+e.target.name).split(" ").join("_"))+" link_"+e.sourceType+"_"+e.targetType}).attr("marker-end",function(e){return"url(#link_"+e.sourceType+"_"+e.targetType+")"}).attr("style",function(e){return e.color?"stroke:"+e.color:""}),k=w.append("g").selectAll("circle").data(b.nodes()).enter().append("path").attr("d",function(e){return g(e.nodeIcon,e.radius)}).attr("class",function(e){var t="node "+e.type;return"undefined"!=typeof e.name&&(t+=" "+i((""+e.name).split(" ").join("_"))),t}).call(b.drag),D=w.append("g").selectAll("text").data(b.nodes()).enter().append("text").attr("x",16).attr("y",".31em").attr("class",function(e){var t="label "+e.type;return"undefined"!=typeof e.name&&(t+=" "+i((""+e.name).split(" ").join("_"))),t}).text(function(e){return e.name})})}}}),yuccaWidgetsModule.directive("funnelChart",function(e,t){return{restrict:"E",scope:{data:"=",showLegend:"@",widgetid:"@",colors:"=",mouth:"="},template:'<div id="funnelPanel{{panelIndex}}" class="funnel-container"><div id="fake-{{panelIndex}}"></div></div>',link:function(e,t,a){console.info("Funnel - attr",a),console.debug("Funnel - elem",t),console.debug("Funnel - scope",e);var n=!0;"false"==e.showLegend&&(n=!1),e.panelIndex=Math.floor(1e4*Math.random()+1);var r={top:0,right:0,bottom:0,left:0};e.$on("yucca-widget-event-"+e.widgetid,function(t,a){console.log("yucca-widget-event-"+e.widgetid,t,a)});var l=function(){for(var t="",a=0;a<e.data.length;a++)e.data[a].label.length>t.length&&(t=e.data[a].label);return t};e.$watch("data",function(){console.log("data change",e.data);var t="undefined"==typeof a.width||null==a.width?500:parseInt(a.width),n="undefined"==typeof a.height||null==a.height?500:parseInt(a.height);n=n-r.top-r.bottom;var o=parseInt(n/e.data.length),s=(Math.min(t,n)/2,d3.scale.ordinal().range(e.colors));if(console.log("colors",s),console.log("colors",e.colors),e.legendColors=[],null!=e.data){var i=l(),d=d3.select("#fake-"+e.panelIndex).insert("svg").append("text").text(i),c=d.node().getComputedTextLength()+6;d3.select("#fake-"+e.panelIndex).remove(),d3.select("#funnelPanel"+e.panelIndex+" svg").remove();var u=d3.select("#funnelPanel"+e.panelIndex).append("svg").attr("width",t+r.left+r.right).attr("height",n+r.bottom+r.top).style("margin-left",-r.left+"px").style("margin.right",-r.right+"px").append("g"),g=d3.funnel().size([t,n]).showMouth(e.mouth).horizontalOffset(c).value(function(e){return e.value}),p=d3.svg.line().interpolate("line-closed").x(function(e,t){return e.x}).y(function(e,t){return e.y}),v=u.selectAll(".funnel-group").data(g(e.data)).enter().append("g").attr("class","funnel-group");v.append("path").attr("d",function(e){return p(e.coordinates)}).style("fill",function(e){return s(e.label)}),v.append("line").attr("x1",0).attr("x2",function(e){return e.coordinates[2].x}).attr("y1",function(e){return e.coordinates[0].y+o}).attr("y2",function(e){return e.coordinates[0].y+o}).attr("class",function(e){return"funnel-chart-label-line "+e.key}),v.append("text").attr({y:function(e,t){return parseInt(e.coordinates[0].y+o-4)},x:function(e,t){return 0}}).style("text-anchor","right").text(function(e){return e.label})}}),d3.funnel=function(){function e(e){var t=0,a=s(e);return e.sort(function(e,t){return t.value-e.value}),e.forEach(function(){e[t].coordinates=a[t].values,t++}),e}var t,a,n=[1,1],r=[1,1],l=function(e){return e.value},o=function(e){var t=e.map(l),a=e.map(function(a,n){a.value=+t[n];var r=d3.max(e,function(e,t){return e.value});return a.value/r*100});return a.sort(function(e,t){return t-e}),a},s=function(e){console.log("funnel data",e,n[1]);for(var r=n[0]-t,l=n[1],s=[],i=o(e),d=parseInt(l/e.length),c=0;c<e.length;c++){var u,g,p=(i[c],c*d),v=(c+1)*d,f=t+parseInt((r-r*i[c]/100)/2),h=t+parseInt((r-r*i[c]/100)/2+r*i[c]/100);c==e.length-1?a?(u=t+parseInt((r-r*i[c]/100)/2),g=t+parseInt((r-r*i[c]/100)/2+r*i[c]/100)):(u=t+parseInt(r/2),g=t+parseInt(r/2)):(u=t+parseInt((r-r*i[c+1]/100)/2),g=t+parseInt((r-r*i[c+1]/100)/2+r*i[c+1]/100)),s[c]={values:[{x:f,y:p},{x:h,y:p},{x:g,y:v},{x:u,y:v}]}}return s};return e.size=function(t){return 2!==t.length||(n=t),e},e.mouth=function(t){return 2!==t.length||(r=t),e},e.showMouth=function(t){return a=t,e},e.horizontalOffset=function(a){return t=a?a:0,e},e.value=function(t){return arguments.length?(l=t,e):l},e}}}}),yuccaWidgetsModule.directive("sankeyChart",function(){return{restrict:"E",scope:{data:"=",numberFormat:"="},template:'<div id="sankeyPanel{{panelIndex}}"></div><div class="legend" ng-show="legendColors.length>0"><span class="legend-label">0</span><span ng-repeat="c in legendColors track by $index" class="legend-bullet" style="background-color: {{c}}">{{cc}}</span><span class="legend-label">100</span></div>',link:function(e,t,a){function n(e,t){e=String(e).replace(/[^0-9a-f]/gi,""),e.length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),t=t||0;var a,n,r="#";for(n=0;n<3;n++)a=parseInt(e.substr(2*n,2),16),a=Math.round(Math.min(Math.max(0,a+a*t),255)).toString(16),r+=("00"+a).substr(a.length);return r}console.log("attr",a),console.log("elem",t),console.log("scope",e),console.log("scope.numberFormat",e.numberFormat),e.panelIndex=Math.floor(1e4*Math.random()+1);var r={top:0,right:0,bottom:0,left:0},l=d3.scale.category20();e.$watch("data",function(){function t(e){d3.select(this).attr("transform","translate("+e.x+","+(e.y=Math.max(0,Math.min(i-e.dy,d3.event.y)))+")"),c.relayout(),g.attr("d",u)}console.log("attr.width in",a.width);var s="undefined"==typeof a.width||null==a.width?500:parseInt(a.width),i="undefined"==typeof a.height||null==a.height?500:parseInt(a.height);i=i-r.top-r.bottom-12,d3.select("#sankeyPanel"+e.panelIndex+" svg").remove();var d=d3.select("#sankeyPanel"+e.panelIndex).append("svg").attr("class","sankey-chart").attr("width",s+r.left+r.right).attr("height",i+r.top+r.bottom).append("g").attr("transform","translate("+r.left+","+r.top+")"),c=d3.sankey().nodeWidth(15).nodePadding(10).size([s,i]),u=c.link();c.nodes(e.data.nodes).links(e.data.links).layout(32);var g=d.append("g").selectAll(".link").data(e.data.links).enter().append("path").attr("class","link").attr("d",u).style("stroke-width",function(e){return Math.max(1,e.dy)}).sort(function(e,t){return t.dy-e.dy});g.append("title").text(function(t){return t.source.name+" â†’ "+t.target.name+"\n"+o(t.value,e.numberFormat)});var p=d.append("g").selectAll(".node").data(e.data.nodes).enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+e.x+","+e.y+")"}).call(d3.behavior.drag().origin(function(e){return e}).on("dragstart",function(){this.parentNode.appendChild(this)}).on("drag",t));p.append("rect").attr("height",function(e){return e.dy}).attr("width",c.nodeWidth()).style("fill",function(e){return"undefined"==typeof e.color||null==e.color?e.color=l(e.name.replace(/ .*/,"")):e.fades&&(e.color=n(e.color,Math.random()-.5)),e.color}).style("stroke",function(e){return d3.rgb(e.color).darker(2)}).append("title").text(function(t){return t.label+"\n"+o(t.value,e.numberFormat)}),p.append("text").attr("x",-6).attr("y",function(e){return e.dy/2}).attr("dy",".35em").attr("text-anchor","end").attr("transform",null).text(function(e){return e.label}).filter(function(e){return e.x<s/2}).attr("x",6+c.nodeWidth()).attr("text-anchor","start");var v=c.computeHeight();console.log("newHeight",v),d3.select("#sankeyPanel"+e.panelIndex+" svg").attr("height",v+12)});var o=function(e,t){var a=e;return isNaN(e)||(e&&(e=parseFloat(e)),t&&(t.euro?a=i(e,t.decimal,t.bigNumber):(isNaN(t.decimal)&&(Math.abs(e)>100?t.decimal=0:Math.abs(e)<1?(t.decimal=-1*Math.log10(e)+1,t.decimal<0?t.decimal=0:t.decimal>20&&(t.decimal=20)):t.decimal=2),a=parseFloat(e).toFixed(t.decimal),t.bigNumber&&(a=s(a,t.decimal,t.lang))))),a},s=function(e,t,a){var n="";return t||(t=2),e&&(n=d(e,t)),(""+n).replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".")},i=function(e,t,a){var n=e;("undefined"==typeof t||isNaN(t))&&(t=2);var r=" â‚¬";return isNaN(e)||(n=a?d(e,t):parseFloat(e).toFixed(t).toString()),n.replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".")+r},d=function(e,t,a){return a||(a="it"),e<1e3?output=parseFloat(e).toFixed(t):e<1e6?output=(e/1e3).toFixed(t)+("it"==a?" mila":" k"):e<1e9?output=(e/1e6).toFixed(t)+("it"==a?" mln":" M"):output=(e/1e9).toFixed(t).toLocaleString()+("it"==a?" mld":" B"),output}}}}),d3.sankey=function(){function e(){p.forEach(function(e){e.sourceLinks=[],e.targetLinks=[]}),v.forEach(function(e){var t=e.source,a=e.target;"number"==typeof t&&(t=e.source=p[e.source]),"number"==typeof a&&(a=e.target=p[e.target]),t.sourceLinks.push(e),a.targetLinks.push(e)})}function t(){p.forEach(function(e){e.value=Math.max(d3.sum(e.sourceLinks,i),d3.sum(e.targetLinks,i))})}function a(){for(var e,t=p,a=0;t.length;)e=[],t.forEach(function(t){t.x=a,t.dx=c,t.sourceLinks.forEach(function(t){
e.indexOf(t.target)<0&&e.push(t.target)})}),t=e,++a;n(a),r((g[0]-c)/(a-1))}function n(e){p.forEach(function(t){t.sourceLinks.length||(t.x=e-1)})}function r(e){p.forEach(function(t){t.x*=e})}function l(e){function t(){var e=d3.min(o,function(e){return(g[1]-(e.length-1)*u)/d3.sum(e,i)});o.forEach(function(t){t.forEach(function(t,a){t.y=a,t.dy=t.value*e})}),v.forEach(function(t){t.dy=t.value*e})}function a(e){function t(e){return s(e.source)*e.value}o.forEach(function(a,n){a.forEach(function(a){if(a.targetLinks.length){var n=d3.sum(a.targetLinks,t)/d3.sum(a.targetLinks,i);a.y+=(n-s(a))*e}})})}function n(e){function t(e){return s(e.target)*e.value}o.slice().reverse().forEach(function(a){a.forEach(function(a){if(a.sourceLinks.length){var n=d3.sum(a.sourceLinks,t)/d3.sum(a.sourceLinks,i);a.y+=(n-s(a))*e}})})}function r(){o.forEach(function(e){var t,a,n,r=0,o=e.length;for(e.sort(l),n=0;n<o;++n)t=e[n],a=r-t.y,a>0&&(t.y+=a),r=t.y+t.dy+u;if(a=r-u-g[1],a>0)for(r=t.y-=a,n=o-2;n>=0;--n)t=e[n],a=t.y+t.dy+u-r,a>0&&(t.y-=a),r=t.y})}function l(e,t){return e.y-t.y}var o=d3.nest().key(function(e){return e.x}).sortKeys(d3.ascending).entries(p).map(function(e){return e.values});t(),r();for(var d=1;e>0;--e)n(d*=.99),r(),a(d),r()}function o(){function e(e,t){return e.source.y-t.source.y}function t(e,t){return e.target.y-t.target.y}p.forEach(function(a){a.sourceLinks.sort(t),a.targetLinks.sort(e)}),p.forEach(function(e){var t=0,a=0;e.sourceLinks.forEach(function(e){e.sy=t,t+=e.dy}),e.targetLinks.forEach(function(e){e.ty=a,a+=e.dy})})}function s(e){return e.y+e.dy/2}function i(e){return e.value}var d={},c=24,u=8,g=[1,1],p=[],v=[];return d.nodeWidth=function(e){return arguments.length?(c=+e,d):c},d.nodePadding=function(e){return arguments.length?(u=+e,d):u},d.nodes=function(e){return arguments.length?(p=e,d):p},d.links=function(e){return arguments.length?(v=e,d):v},d.size=function(e){return arguments.length?(g=e,d):g},d.layout=function(n){return e(),t(),a(),l(n),o(),d},d.relayout=function(){return o(),d},d.computeHeight=function(){var e=0;return p.forEach(function(t){t.dy+t.y>e&&(e=t.dy+t.y)}),e},d.link=function(){function e(e){var a=e.source.x+e.source.dx,n=e.target.x,r=d3.interpolateNumber(a,n),l=r(t),o=r(1-t),s=e.source.y+e.sy+e.dy/2,i=e.target.y+e.ty+e.dy/2;return"M"+a+","+s+"C"+l+","+s+" "+o+","+i+" "+n+","+i}var t=.5;return e.curvature=function(a){return arguments.length?(t=+a,e):t},e},d},yuccaWidgetsModule.directive("treemapChart",function(e,t,a){return{restrict:"E",scope:{data:"=",showLegend:"@",widgetid:"@",numberFormat:"=",numberFormat2:"="},template:'<div id="treemapPanel{{panelIndex}}" class="treemap-container" style="width: {{width}}px"></div><div class="legend" ng-if="legendColors.length>0 && showLegend">\t<span class="legend-label">0</span>\t<span ng-repeat="c in legendColors track by $index" class="legend-bullet" style="background-color: {{c}}">{{cc}}</span>\t<span class="legend-label">100</span></div><style>{{scrolltext_keyframe}}</style><div class="treemap-textscroll-wrapper" style="width: {{width}}px"><div class="treemap-textscroll" ng-bind-html="textvalues" style=" animation-duration: {{scrolltext_duration}}s; "></div></div>',link:function(n,r,l){function o(e){if(console.log("onAreaClick ignoreClick",e,u),u)u=!1;else{console.log("data",n.data);var a=[];for(var r in e)e.hasOwnProperty(r)&&a.push(e[r].value);a.push(n.data.name);var l={sourceId:n.widgetid,eventtype:"dataset.browse",data:{browseHistory:e,path:a.reverse()},widget:"treemap"};t.$emit("yucca-treemap-event",l),console.log("yucca-treemap-event",l)}}function s(e){var t=parseInt(e.replace("#",""),16),a=t>>16&255,n=t>>8&255,r=t>>0&255,l=.2126*a+.7152*n+.0722*r,o="#fff";return l>164&&(o="#000"),o}function i(e,t){e=String(e).replace(/[^0-9a-f]/gi,""),e.length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),t=t||0;var a,n,r="#";for(n=0;n<3;n++)a=parseInt(e.substr(2*n,2),16),a=Math.round(Math.min(Math.max(0,a+a*t),255)).toString(16),r+=("00"+a).substr(a.length);return r}console.info("Treemap - attr",l),console.debug("Treemap - elem",r),console.debug("Treemap - scope",n);var d=!0;"false"==n.showLegend&&(d=!1),n.panelIndex=Math.floor(1e4*Math.random()+1);var c={top:30,right:0,bottom:0,left:0},u=!1;n.$on("yucca-widget-event-"+n.widgetid,function(e,t){console.log("yucca-widget-event-"+n.widgetid,e,t),"browse"==t.type&&g(t.path)});var g=function(t){console.log("browseToPath",t);var a=parseInt(d3.select("#absoluteparent").attr("absolutedepth"))+1;t.length;if(a>t.pathdepth)p(),g(t);else{var n=d3.select("#absoluteparent").attr("parentname"),r=t[a-1],l=t[t.length-1];r!=l&&(r==n?(v(t[a]),e(function(){g(t)},1e3)):(p(),e(function(){g(t)},1e3)))}},p=function(){u=!0,e(function(){d3.select(".grandparent").node().dispatchEvent(new Event("click"))},1)},v=function(t){u=!0;var a="#id_"+t.replace(/\s/g,"_")+"_1";e(function(){d3.select(a).node().dispatchEvent(new Event("click"))},1)},f=function(e){console.log("refreshTextvalues",e),console.log("refreshTextvalues numberFormat",n.numberFormat);var t="",r="";if(e&&e._children)for(var l=0;l<e._children.length;l++){var o=e._children[l],i=o.color?s(o.color):"#333",d=h(o.value,n.numberFormat);if(t+="<span class='treemap-column' style='background-color: "+o.color+"; color: "+i+"'>"+o.name+"</span>\t<span class='treemap-first-value'>\t\t<span class='treemap-data-label'>"+n.data.valueLabel+"</span> <span class='treemap-data-value'>"+d+"</span>     </span>",r+=o.name+n.data.valueLabel+o.value,o.value2){var c=h(o.value2,n.numberFormat2);t+="\t<span class='treemap-first-value'>\t\t<span class='treemap-data-label'>"+n.data.valueLabel2+"</span> <span class='treemap-data-value'>"+c+"</span>     </span>",r+=n.data.valueLabel2+o.value2}}console.log("refreshTextvalues text",r),n.scrolltext_keyframe="@keyframes scroll{0% {left:100%;}100% {left:-"+r.length/1.8+"em;}}",n.scrolltext_duration=r.length/5,n.textvalues=a.trustAsHtml(t)};n.$watch("data",function(){function e(e){var t=h(e.value,n.numberFormat),a=b.valueLabel+": "+t;if("undefined"!=typeof e.label&&(a=e.label),e.fourthElement)try{a+=" - "+e.fourthElement.label+": "+parseFloat(e.fourthElement.value).toFixed(1)+"%"}catch(r){}if(e.value2)try{var l=h(e.value2,n.numberFormat2);a+=" - "+b.valueLabel2+": "+l}catch(r){}return a}function t(e){var t=r(e);if(e.fourthElement){var a=.9*e.fourthElement.value/50-.9;t=i(t,a)}else if(e.value2){var n=e.value2/e.parent.value2,a=n;t=i(t,a)}return"fill:"+t}function a(e){var t=r(e);if(e.fourthElement){var a=.9*e.fourthElement.value/50-.9;t=i(t,a)}return"fill: "+s(t)}function r(e){return e.color?e.color:e.parent?r(e.parent):"#ddd"}function u(e,t){return e.parent&&(t.push({column:e.column,value:e.name}),t=u(e.parent,t)),t}function g(e,t){e.attr("x",function(e){return x(e.x)+6}).attr("y",function(e){return k(e.y)+6}).text(function(e){var t=10,a=e.name.trim().length*t,n=e.name,r=x(e.x+e.dx)-x(e.x);if(r<a){var l=parseInt(r/t)-1;n=l>3?e.name.substring(0,l)+"...":""}return n})}function p(e){e.attr("x",function(e){return x(e.x)}).attr("y",function(e){return k(e.y)}).attr("width",function(e){return x(e.x+e.dx)-x(e.x)}).attr("height",function(e){return k(e.y+e.dy)-k(e.y)})}function v(e){return e.parent?v(e.parent)+"  -  "+e.name:e.name}console.log("data change");var m="undefined"==typeof l.width||null==l.width?500:parseInt(l.width),y="undefined"==typeof l.height||null==l.height?500:parseInt(l.height);n.width=m,y=y-c.top-c.bottom;var b=n.data;if(n.legendColors=[],null!=b){var w,x=d3.scale.linear().domain([0,m]).range([0,m]),k=d3.scale.linear().domain([0,y]).range([0,y]),D=d3.layout.treemap().children(function(e,t){return t?null:e._children}).sort(function(e,t){return e.value-t.value}).ratio(y/m*.5*(1+Math.sqrt(5))).round(!1);d3.select("#treemapPanel"+n.panelIndex+" svg").remove();var _=d3.select("#treemapPanel"+n.panelIndex).append("svg").attr("width",m+c.left+c.right).attr("height",y+c.bottom+c.top).style("margin-left",-c.left+"px").style("margin.right",-c.right+"px").append("g").attr("transform","translate("+c.left+","+c.top+")").style("shape-rendering","crispEdges"),C=_.append("g").attr("class","grandparent");C.append("rect").attr("y",-c.top).attr("width",m).attr("height",c.top),C.append("text").attr("x",8).attr("y",8-c.top).attr("dy",".75em");var I=function(e){e.x=e.y=0,e.dx=m,e.dy=y,e.depth=0},M=function(e){return(e._children=e.children)?e.value=e.children.reduce(function(e,t){return e+M(t)},0):e.value},L=function(e){return(e._children=e.children)?e.value2=e.children.reduce(function(e,t){return e+L(t)},0):e.value2},T=function(e){e._children&&(D.nodes({_children:e._children}),e._children.forEach(function(t){t.x=e.x+t.x*e.dx,t.y=e.y+t.y*e.dy,t.dx*=e.dx,t.dy*=e.dy,t.parent=e,T(t)}))},$=function(r){function l(e){if(!w&&e){w=!0;var t=$(e),a=s.transition().duration(750),r=t.transition().duration(750);if(x.domain([e.x,e.x+e.dx]),k.domain([e.y,e.y+e.dy]),_.style("shape-rendering",null),_.selectAll(".depth").sort(function(e,t){return e.depth-t.depth}),t.selectAll("text").style("fill-opacity",0),a.selectAll("text").call(g).style("fill-opacity",0),r.selectAll("text").call(g).style("fill-opacity",1),a.selectAll("rect").call(p),r.selectAll("rect").call(p),a.remove().each("end",function(){_.style("shape-rendering","crispEdges"),w=!1}),"undefined"!=typeof e.parent&&d){n.legendColors=[];for(var l=e.color?e.color:e.parent.color,c=0;c<5;c++){var v=.9*c/2-.9,h=i(l,v);n.legendColors.push(h)}}else n.legendColors=[];f(e),n.$apply(),o(u(e,new Array))}}console.log("ttt ddd ",r),C.datum(r.parent).on("click",l).select("text").text(v(r));var s=_.insert("g",".grandparent").datum(r).attr("class","depth").attr("parentname",r.name).attr("id","absoluteparent").attr("absolutedepth",function(e){return e.absolutedepth}),c=s.selectAll("g").data(r._children).enter().append("g");return c.filter(function(e){return e._children}).classed("children",!0).on("click",l),c.selectAll(".child").data(function(e){return e._children||[e]}).enter().append("rect").attr("class","child").attr("style",function(e){return t(e)}).call(p),c.append("rect").attr("class","parent").attr("style",function(e){return t(e)}).call(p).append("title").text(function(t){return e(t)}),c.append("text").attr("dy",".75em").attr("style",function(e){return a(e)}).call(g),c.attr("id",function(e){return"id_"+e.name.replace(/\s/g,"_")+"_"+e.depth}),c.attr("column",function(e){return e.column}),c.attr("absolutedepth",function(e){return e.absolutedepth}),f(b),c};I(b),M(b),L(b),T(b),$(b)}});var h=function(e,t){var a=e;return isNaN(e)||(e&&(e=parseFloat(e)),t&&(t.euro?a=y(e,t.decimal,t.bigNumber):(isNaN(t.decimal)&&(Math.abs(e)>100?t.decimal=0:Math.abs(e)<1?(t.decimal=-1*Math.log10(e)+1,t.decimal<0?t.decimal=0:t.decimal>20&&(t.decimal=20)):t.decimal=2),a=parseFloat(e).toFixed(t.decimal),t.bigNumber&&(a=m(a,t.decimal,t.lang))))),a},m=function(e,t,a){var n="";return t||(t=2),e&&(n=b(e,t)),(""+n).replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".")},y=function(e,t,a){var n=e;("undefined"==typeof t||isNaN(t))&&(t=2);var r=" â‚¬";return isNaN(e)||(n=a?b(e,t):parseFloat(e).toFixed(t).toString()),n.replace(".",",").replace(/\B(?=(\d{3})+(?!\d))/g,".")+r},b=function(e,t,a){return a||(a="it"),e<1e3?output=parseFloat(e).toFixed(t):e<1e6?output=(e/1e3).toFixed(t)+("it"==a?" mila":" k"):e<1e9?output=(e/1e6).toFixed(t)+("it"==a?" mln":" M"):output=(e/1e9).toFixed(t).toLocaleString()+("it"==a?" mld":" B"),output}}}}),yuccaWidgetsModule.directive("ngYuccaDatasetBulletChart",["metadataService","dataService","$yuccaHelpers","$timeout","$compile",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_bullet_chart.html",link:function(e,n,r){console.log("elem",n),e.debug="true"===r.debug,e.debugMessages=[];var l=r.userToken,o=r.filter,s=a.attrs.safe(r.currentValueColumn,null),i=a.attrs.safe(r.previousValueColumn,null),d=e.$eval(r.barColors);"undefined"!=typeof d&&null!=d&&""!=d||(d=Constants.LINE_CHART_COLORS);var c=e.$eval(r.rangeValues,null);null!=c&&3!=c.length&&(e.debugMessages.push("Invalid range values: range values must be an array with 3 elements: Min, Mean, Max"),c=null);var u=e.$eval(r.rangeColumnValues,null);null!=u&&3!=u.length&&(e.debugMessages.push("Invalid range column values: range column values must be an array with 3 elements: Column with Min, Column with Mean, Column with Max"),u=null);var g="true"===r.averageValues,p=(a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1),e.$eval(r.internalIds)),v=a.attrs.safe(r.filterIds,null),f=a.attrs.safe(r.barTitleColumn,null),h=a.attrs.safe(r.barSubtitleColumn,null),m=a.attrs.safe(r.barTitleLabel,null),y=a.attrs.safe(r.barSubtitleLabel,null),b=e.$eval(r.rangeLabels),w=e.$eval(r.measureLabels),x=(e.$eval(r.customMarkers),e.$eval(r.customMarkerColumns)),k=e.$eval(r.markerLabels),D=a.attrs.safe(r.euroValue,!1),_=a.attrs.safe(r.decimalValue,2);e.isEuroValue=function(){return"true"==D},e.chartWidth=a.attrs.num(r.chartWidth,100,null,n[0].offsetWidth),e.chartHeight=a.attrs.num(r.chartHeight,100,null,n[0].offsetHeight);var C=function(t,n,r,l,o){var s=(t.index,"");return s+="  <span class='yucca-dataset-bullet-chart-tooltip'>",s+="    <i class='glyphicon glyphicon-stop' style='color:"+t.color+"'></i> "+t.label+" <strong>"+a.render.safeNumber(t.value,_,e.isEuroValue())+"</strong></span>",s+="  </span>"},I=function(){t.getDataEntities(r.datasetCode,l,o,0,1,null).success(function(e){var a=e.d.__count>1e4?1e4:e.d.__count;t.getMultipleDataEnties(r.datasetCode,l,o,null,a).then(function(e){for(var t=0,a=0,n=null,r=null,l=0;l<e.length;l++)for(var o=0;o<e[l].data.d.results.length;o++){var i=parseFloat(e[l].data.d.results[o][s]);(null==n||i<n)&&(n=i),(null==r||i>r)&&(r=i),t+=i,a++}c.push(n),c.push(t/a),c.push(r),console.log("ranges",c),$()})})};e.options={chart:{type:"bulletChart",duration:500,tooltip:{contentGenerator:C},tickFormat:function(t){return a.render.safeNumber(t,_,e.isEuroValue())},ticks:2}};var M=0,L=function(t,a){console.log("createBulletChart",t);var n=[];null!=u&&(c=[parseFloat(t[u[0]]),parseFloat(t[u[1]]),parseFloat(t[u[2]])]),null!=t[s]&&n.push(parseFloat(t[s].replace(",",".")));var r=m;"undefined"!=typeof f&&null!=f&&""!=f&&(r=t[f]);var l=y;"undefined"!=typeof h&&null!=h&&""!=h&&(l=t[h]);var o="bullet_"+a+"_"+(new Date).getTime(),g={chartId:o,title:r,subtitle:l,ranges:c,measures:n,color:d[M],markers:[],markerLabels:[],markersControl:[]};if(null!=i&&(g.markers.push(t[i]),g.markerLabels.push("Previous")),"undefined"!=typeof x&&null!=x)for(var p=0;p<x.length;p++)g.markersControl.push({marker:x[p],show:!0});if("undefined"!=typeof x&&null!=x)for(var p=0;p<x.length;p++)g.markers.push(t[x[p]]);if("undefined"!=typeof b&&null!=b&&(g.rangeLabels=b),"undefined"!=typeof w&&null!=w&&(g.measureLabels=w),"undefined"!=typeof k&&null!=k)for(var p=0;p<k.length;p++)g.markerLabels.push(k[p]),"undefined"!=typeof g.markersControl[p]&&(g.markersControl[p].label=k[p]);e.chartDataArray.push(g),M++,M==d.length&&(M=0),console.debug("chartData",g),e.isLoading=!1},T=null,$=function(){null!=p?E():t.getDataEntities(r.datasetCode,l,v,0,50,null).success(function(t){if(console.debug("loadIds",t),T=t.d.results,null!=t.d.results&&t.d.__count>0){p=[];for(var a=0;a<t.d.results.length;a++)p.push(t.d.results[a].internalId);E()}else e.infoMessage="No data found",e.isLoading=!1}).error(function(t){e.isLoading=!1,console.error("loadIds error",t),e.debugMessages.push("Load ids error "+t)})},E=function(){e.chartDataArray=[],console.log("loadData",p);if(null!=T&&T.length>0)if(g){for(var a=T[0],n=1;n<T.length;n++)a[s]=parseFloat(a[s])+parseFloat(T[n][s]);a[s]=a[s]/T.length,L(a,0)}else for(var n=0;n<T.length;n++)L(T[n],n);else for(var n=0;n<p.length;n++)t.getSingleDataEntities(r.datasetCode,l,p[n]).then(function(e){L(e.data.d,n)})};e.isLoading=!0,null!=c||null!=u?$():(c=[],I()),console.log("attrs",r),e.widgetTitle=r.widgetTitle,e.widgetIntro=a.attrs.safe(r.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_bullet_chart.html",'<div class="yucca-widget yucca-dataset-bullet-chart">\n    <header class="yucca-dataset-bullet-chart-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-bullet-chart-content">\n        <section >\n           <div ng-show="isLoading" class="yucca-dataset-bullet-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-show="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-show="!isLoading" ng-repeat="chartData in chartDataArray track by $index" class="yucca-dataset-bullet-chart-chart" >\n        \t\t<!--<div class="yucca-dataset-bullet-chart-marker-controls">\n        \t\t  <div class="check-control" ng-repeat="m in chartData.markersControl track by $index">\n        \t\t    <div class="check-bullet" ng-click="toggleMarker(chartData.chartId, m)"></div>{{m.label}}\n        \t\t  </div>\n        \t\t</div>\n\t\t\t\t<div id="{{chartData.chartId}}"><nvd3 options="options" data="chartData" ></nvd3></div>-->\n\t\t\t\t<nvd3 options="options" data="chartData" ></nvd3>\n\t\t\t\t<!--<bullet-chart options="options" data="chartData" width="{{chartWidth}}" height="{{chartHeight}}" ></bullet-chart>-->\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-show="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetImageGallery",["metadataService","dataService","$yuccaHelpers","$interval","leafletData","$compile","$timeout",function(e,t,a,n,r,l,o){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_image_gallery.html",link:function(e,r,s){var i=s.userToken;e.debug="true"===s.debug,e.panel=a.attrs.safe(s.landingPanel,"slideshow"),e.datasetImageGalleryMapId="map"+(new Date).getTime();var d=s.filter,c=s.skip,u=s.top;isNaN(u)||u<1?u=10:u>50&&(u=50);var g=s.interval;(isNaN(g)||g<500)&&(g=2e3);var p=e.$eval(s.imageColumns);e.hasMap=!1;var v=null;void 0!=typeof s.positionColumns&&null!=s.positionColumns&&(v=e.$eval(s.positionColumns),e.hasMap=!0);var f=s.imageTitleColumn,h="true"===s.markerAsImage,m=s.markerUrl;e.showTitle="false"!==s.showTitle;var y=s.markerUrl;"undefined"!=typeof y&&null!=y||(y="#00bbf0"),e.allData=[],e.currentImageIndex=0,e.nexImage=function(t){null!=t&&t<e.allData.length?(e.currentImageIndex=t,n.cancel(b)):e.currentImageIndex>=e.allData.length-1?e.currentImageIndex=0:e.currentImageIndex++};var b=n(function(){e.nexImage()},g);e.mapData={markers:{},markerstyles:[]};var w={};w[e.datasetImageGalleryMapId]=[];var x=function(t,a,n){var r={};return r.lat=parseFloat(a),r.lng=parseFloat(n),h?r.icon={iconUrl:t,iconSize:[48,48]}:null!=m&&""!=m?r.icon={iconUrl:m}:r.icon={markerColor:y},r.message="<img src='"+t+"'  class='yucca-dataset-image-gallery-popup-img'> </img>",w[e.datasetImageGalleryMapId].push([L.latLng(r.lat,r.lng)]),r};e.totalCount="-",e.imgUrl=null,e.debugMessages=[],e.datasetImageGalleryMaxBounds={southWest:{lat:38.700247900602726,lng:-9.165430068969727},northEast:{lat:38.72703673982525,lng:-9.110498428344725}},t.getDataEntities(s.datasetCode,i,d,c,u,"internalId%20desc").success(function(a){if(null!=a&&null!=a.d){e.totalCount=a.d.__count;for(var n=[],r=[],l=[],o=0;o<a.d.results.length;o++){for(var i=a.d.results[o],d=i.Binaries.__deferred.uri.replace("http://","https://"),c=0;c<p.length;c++)null!=i[p[c]]&&(n.push(i[p[c]].idBinary),r[i[p[c]].idBinary]=[i[v[0]],i[v[1]]],"undefined"!=typeof f&&null!=f&&(l[i[p[c]].idBinary]=i[f]));for(var c=0;c<p.length;c++)null!=i[p[c]]?t.getBinariesData(d).success(function(t){console.log("idBinary, binariesData",t);for(var a=0;a<t.d.results.length;a++){var o=t.d.results[a].idBinary;if(n.indexOf(o)>-1){var s=t.d.results[a].urlDownloadBinary,i=t.d.results[a].aliasNameBinary;console.log("urlDownloadBinary",s);var d={};d.url=Constants.API_DATA_URL+s.substring(5),d.label=i,"undefined"!=typeof l[o]&&null!=l[o]&&""!=l[o]&&(d.label=l[o]),e.allData.push(d),e.hasMap&&null!=r[o]&&(e.mapData.markers[o.replace(".","_")]=x("http:"+d.url,r[o][0],r[o][1])),console.log(e.mapData.markers)}}}):e.debugMessages.push("Invalid column name: "+p[c])}}else e.debugMessages.push("No data found with dataset code "+s.datasetCode)}),e.viewMap=function(){e.panel="map",o(function(){var t='<leaflet width="100%" height="300px" markers="mapData.markers" maxbounds="datasetImageGalleryMaxBounds"></leaflet>';angular.element(document.getElementById(e.datasetImageGalleryMapId)).empty().append(l(t)(e));var a=new L.latLngBounds(w[e.datasetImageGalleryMapId]);e.datasetImageGalleryMaxBounds={southWest:a.getSouthWest(),northEast:a.getNorthEast()},console.info("scope.datasetImageGalleryMaxBounds",e.datasetImageGalleryMaxBounds)},100)},console.log("attrs",s),e.widgetTitle=s.widgetTitle,e.widgetIntro=a.attrs.safe(s.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_image_gallery.html",'<div class="yucca-widget yucca-dataset-image-gallery">\n    <header class="yucca-dataset-image-gallery-header">\n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-image-gallery-content">\n        <section class="yucca-dataset-image-gallery-map" ng-show="panel==\'map\'">\n             <div ng-attr-id="{{datasetImageGalleryMapId}}"></div>\n        </section>\n        <section class="yucca-dataset-image-gallery-slideshow" ng-show="panel==\'slideshow\'" >\n        \t<div>\n              <img ng-src="{{data.url}}" ng-repeat="data in allData track by $index" ng-show="$index==currentImageIndex"/>\n              <div class="yucca-dataset-image-gallery-slide-title" ng-show="showTitle">{{allData[currentImageIndex].label}}</div>\n              <div class="yucca-dataset-image-gallery-bullets-panel">\n                  <a ng-repeat="image in allData track by $index" href ng-click="nexImage($index)" class="yucca-dataset-image-gallery-bullet" ng-class="{active: $index == currentImageIndex}"></a>\n        \t   </div>\n        \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-show="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n        <section class="yucca-dataset-image-gallery-data" ng-hide="allData!=null">\n           No data\n        </section>\n        <section class="yucca-dataset-image-gallery-total-count">\n            Total: {{totalCount}}\n        </section>\n        <section class="yucca-dataset-image-gallery-toolbar" ng-show="hasMap">\n            <a href ng-click="viewMap()"  ng-class="{active: panel == \'map\'}">Map</a> | <a href ng-click="panel=\'slideshow\'"  ng-class="{active: panel == \'slideshow\'}">Slideshow</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetMultidataStats",["metadataService","dataService","$yuccaHelpers",function(e,t,a){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_multidata_stats.html",link:function(e,n,r){e.debug="true"===r.debug;var l=r.userToken;e.panel=a.attrs.safe(r.landingPanel,"chart");var o=r.filter,s=a.attrs.safe(r.firstGroupColumn,null),i=e.$eval(r.firstGroupColors);"undefined"!=typeof i&&null!=i&&0!=i.length||(i=Constants.LINE_CHART_COLORS);var d=e.$eval(r.secondGroupColumn);console.log("secondGroupColumn",d);var c=e.$eval(r.secondGroupLabel),u=a.attrs.safe(r.thirdGroupColumn,null),g=a.attrs.safe(r.euroValue,!1),p=a.attrs.safe(r.decimalValue,2),v=a.attrs.safe(r.formatBigNumber,!1);e.isEuroValue=function(){return"true"==g},e.decimalValue=p;var f=r.countingMode,h=a.attrs.safe(r.histogramGroupColumn,null),m=a.attrs.safe(r.histogramGroupValueColumn,null);"undefined"==typeof d&&null==h?(d=[s],f="count"):null!=h&&(d=[]);var y=a.attrs.num(r.chartHeight,100,null,400),b=a.attrs.safe(r.chartType,"multiBarChart"),w=a.attrs.safe(r.groupingWay,"grouped"),x=!1;"stacked"==w&&(x=!0);var k=(a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1),function(t,n,r,l,o){var s=(t.index,"");s+="  <h3 class='yucca-dataset-multidata-stats-tooltip-header'>"+t.value+"</h3>",s+="<div class='yucca-dataset-multidata-stats-tooltip'>",s+="  <table><tbody>";for(var i=0;i<e.chartData.length;i++)for(var d=e.chartData[i],c=0;c<d.values.length;c++){var u=d.values[c];if(u.label==t.value){var g="",f=u.value;f=a.render.safeNumber(f,p,e.isEuroValue(),v),d.key==t.data.key&&(g="font-weight:  bold; color: "+d.color+";"),s+="  <tr style='"+g+"'>",s+="      <td><span class='yucca-dataset-multidata-stats-tooltip-label'>"+u.key+"</span></td>",s+="      <td><span class='yucca-dataset-multidata-stats-tooltip-value'>"+f+"</span></td>",s+="  </tr>"}}return s+="  </tbody></table>",s+="</div>"});e.options={chart:{type:b,height:parseInt(y),margin:{top:24,right:24,bottom:24,left:64},x:function(e){return e.label},y:function(e){return e.value},showValues:!0,valueFormat:function(t){return a.render.safeNumber(t,p,e.isEuroValue(),v)},duration:500,stacked:x,xAxis:{showMaxMin:!1},yAxis:{axisLabelDistance:-10,tickFormat:function(t){return a.render.safeNumber(t,p,e.isEuroValue(),v)}},reduceXTicks:"true"==r.reduceXTicks,tooltip:{contentGenerator:k}}};var D=[];e.changeTableData=function(t,a){console.log("index",t,a),a&&null!=u&&(e.tableData=D[t])};var _=function(t){var a={},n={},r=0,l={},o={};if(null!=h)for(var g=0;g<t.length;g++){var p=t[g];d.indexOf(p[h])<0&&d.push(p[h])}for(var g=0;g<t.length;g++){var p=t[g];if("undefined"==typeof a[p[s]]){var v=[];o[p[s]]=[p[s]];for(var y=0;y<d.length;y++){n[p[s]+"_"+d[y]]=y;var b=d[y];"undefined"!=typeof c&&null!=c&&c.length>y&&(b=c[y]),v[y]={label:b,value:0},o[p[s]].push(0),l[p[s]]={}}a[p[s]]=[{key:p[s],values:v}],"undefined"!=typeof i&&null!=i&&r<i.length&&(a[p[s]][0].color=i[r],r++)}for(var y=0;y<d.length;y++){var w=1;if(null!=h?d[y]==p[h]?"sum"==f&&null!=m&&(w=parseFloat(p[m])):w=0:"sum"==f&&(w=parseFloat(p[d[y]])),a[p[s]][0].values[n[p[s]+"_"+d[y]]].value+=w,o[p[s]][y+1]+=w,null!=u){var x=p[u];if("undefined"==typeof l[p[s]][x]){l[p[s]][x]=new Array(d.length),l[p[s]][x][0]=x;for(var k=0;k<d.length;k++)l[p[s]][x][k+1]=0}l[p[s]][x][y+1]+=w}}}console.log("secondGroupColumn",d),console.log("dataGroup",a),console.log("valueIndexs",n);for(var _ in a)e.chartData.push(a[_][0]);D.push({title:"",mainPanel:!0,data:o});for(var C in l)D.push({title:C,mainPanel:!1,data:l[C]});e.tableData=D[0],console.log("scope.chartData",e.chartData),console.log("allTableData  f",D),console.log("detailsTableData  f",l)};e.tableData=[],e.tableDataColums=[];for(var C=0;C<d.length;C++){var I=d[C];"undefined"!=typeof c&&null!=c&&c.length>C&&(I=c[C]),e.tableDataColums.push(I)}e.chartData=[],t.getDataEntities(r.datasetCode,l,o,0,1,null).then(function(a){console.log("firstData",a),t.getMultipleDataEnties(r.datasetCode,l,o,"internalId%20desc",a.data.d.__count).then(function(t){var a=[];console.log("data",t);for(var n=0;n<t.length;n++)a=a.concat(t[n].data.d.results);console.log("allData",a),_(a),console.log("----",e.allChartData)})}),console.log("attrs",r),e.widgetTitle=r.widgetTitle,e.widgetIntro=a.attrs.safe(r.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_multidata_stats.html",'<div class="yucca-widget yucca-dataset-multidata-stats">\n    <header class="yucca-dataset-multidata-stats-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-multidata-stats-content">\n        <section class="yucca-dataset-multidata-stats-chart" ng-show="panel==\'chart\'">\n        \t<nvd3 options="options" data="chartData"></nvd3>\n        </section>\n        <section class="yucca-dataset-multidata-stats-data"  ng-show="panel==\'data\'">\n           <table class="yucca-dataset-multidata-stats-table">\n               <thead >\n                  <tr>\n                      <th><a href ng-click="changeTableData(0, true)" ng-hide="tableData.mainPanel"><span  class="back">&laquo; Back</span> </a> {{tableData.title}}</th>\n                      <th ng-repeat="title in tableDataColums track by $index">{{title}}</th>\n                  </tr>\n               </thead>\n               <tbody>\n                   <tr ng-repeat="row in tableData.data track by $index" ng-click="changeTableData(($index+1), tableData.mainPanel)" ng-class="{selectable: tableData.mainPanel}">\n                     <td ng-repeat="data in row track by $index">\n                         <span class="yucca-dataset-multidata-stats-value">{{data|safeNumber:decimalValue}}</span>\n                     </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-dataset-multidata-stats-toolbar">\n            <a href ng-click="panel=\'chart\'" ng-class="{active: panel == \'chart\'}">Chart</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetMultidataTreemap",["metadataService","dataService","$yuccaHelpers",function(e,t,a){"use strict";return{restrict:"AE",scope:{},templateUrl:"template/dataset_multidata_treemap.html",link:function(e,n,r){e.treemapData=null,e.debug="true"===r.debug;var l=r.userToken;e.panel=a.attrs.safe(r.landingPanel,"chart");var o=r.filter;e.widgetTitle=a.attrs.safe(r.widgetTitle,"Treemap"),e.widgetIntro=a.attrs.safe(r.widgetIntro,null);var s=a.attrs.safe(r.chartTitle,r.datasetCode),i=a.attrs.safe(r.secondGroupColumn,null),d=e.$eval(r.colors);"undefined"!=typeof d&&null!=d&&0!=d.length||(d=Constants.LINE_CHART_COLORS);var c=e.$eval(r.firstGroupColumn);console.log("secondGroupColumn",i);var u=e.$eval(r.firstGroupLabel),g=a.attrs.safe(r.thirdGroupColumn,null),p=a.attrs.safe(r.fourthGroupColumn,null),v=a.attrs.safe(r.euroValue,!1);e.decimalValue=a.attrs.safe(r.decimalValue,2),e.isEuroValue=function(){return"true"==v};var f=r.countingMode;e.chartWidth=a.attrs.num(r.chartWidth,100,null,500),e.chartHeight=a.attrs.num(r.chartHeight,100,null,400);var h=(a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1),[]);e.changeTableData=function(t,a){console.log("index",t,a),a&&null!=g&&(e.tableData=h[t])},e.treemapData={name:s,children:[]};var m=function(t){for(var a={},n={},r=[],l=0;l<c.length;l++)r[c[l]]=[];for(var o=1,v=0;v<t.length;v++){var m=t[v];if("undefined"==typeof r[c[0]][m[i]])for(var l=0;l<c.length;l++)r[c[l]][m[i]]=[];"undefined"==typeof a[m[i]]&&(a[m[i]]=[m[i]],n[m[i]]={});for(var l=0;l<c.length;l++){var y=p?m[p]:0;null!=g&&"undefined"==typeof r[c[l]][m[i]][m[g]]&&(r[c[l]][m[i]][m[g]]={value:0,fourthElement:y}),"sum"==f&&(o=parseFloat(m[c[l]])),r[c[l]][m[i]][m[g]].value+=o,a[m[i]].length==l+1&&a[m[i]].push(0),a[m[i]][l+1]+=o;var b=m[g];if("undefined"==typeof n[m[i]][b]){n[m[i]][b]=new Array(c.length),n[m[i]][b][0]=b;for(var w=0;w<c.length;w++)n[m[i]][b][w+1]=0}n[m[i]][b][l+1]+=o}}console.log("mainTableData new",a),console.log("detailsTableData new",n),
h.push({title:"",mainPanel:!0,data:a});for(var x in n)h.push({title:x,mainPanel:!1,data:n[x]});e.tableData=h[0],e.treemapData={name:s,children:[]};var k=0;for(var D in r)if(r.hasOwnProperty(D)){var _=D;"undefined"!=typeof u&&null!=u&&"undefined"!=typeof u[k]&&null!=u[k]&&(_=u[k]),k++;var C={name:_,children:[],color:d[k]};for(var I in r[D])if(r[D].hasOwnProperty(I)){var M={name:I,children:[]};for(var L in r[D][I])r[D][I].hasOwnProperty(L)&&M.children.push({name:L,value:r[D][I][L].value,fourthElement:{label:p,value:r[D][I][L].fourthElement}});C.children.push(M)}e.treemapData.children.push(C)}console.log("scope.treemapData",e.treemapData)};e.tableData=[],e.tableDataColums=[];for(var y=0;y<c.length;y++){var b=c[y];"undefined"!=typeof u&&null!=u&&u.length>y&&(b=u[y]),e.tableDataColums.push(b)}e.isLoading=!0,e.chartMessage=null,t.getDataEntities(r.datasetCode,l,o,0,1,null).then(function(a){console.log("firstData",a),t.getMultipleDataEnties(r.datasetCode,l,o,"internalId%20desc",a.data.d.__count).then(function(t){if(e.isLoading=!1,e.chartMessage=null,"undefined"==typeof t||null==t||0==t.length)e.chartMessage="No data found";else{var a=[];console.log("data",t);for(var n=0;n<t.length;n++)a=a.concat(t[n].data.d.results);console.log("allData",a),m(a),console.log("----",e.allChartData)}},function(){e.isLoading=!1,e.chartMessage="An error occurred. Please try again later."})}),console.log("attrs",r)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_multidata_treemap.html",'<div class="yucca-widget yucca-dataset-multidata-treemap">\n    <header class="yucca-dataset-multidata-treemap-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-multidata-treemap-content">\n        <section class="yucca-dataset-multidata-treemap-chart" ng-show="panel==\'chart\'">\n           <div ng-show="isLoading" class="yucca-dataset-multidata-treemap-loading" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px" ><p>Loading&hellip;</p>\n             <div class="yucca-widget-spinner"> <div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-show="chartMessage != null" class="yucca-dataset-multidata-treemap-chart-message" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px">Loading&hellip;</div>\n        \t<treemap-chart ng-show="!isLoading &&  chartMessage == null "data="treemapData" width="{{chartWidth}}" height="{{chartHeight}}"></treemap-chart>\n        </section>\n        <section class="yucca-dataset-multidata-treemap-data"  ng-show="panel==\'data\'">\n           <table class="yucca-dataset-multidata-treemap-table">\n               <thead >\n                  <tr>\n                      <th><a href ng-click="changeTableData(0, true)" ng-hide="tableData.mainPanel"><span  class="back">&laquo; Back</span> </a> {{tableData.title}}</th>\n                      <th ng-repeat="title in tableDataColums track by $index">{{title}}</th>\n                  </tr>\n               </thead>\n               <tbody>\n                   <tr ng-repeat="row in tableData.data track by $index" ng-click="changeTableData(($index+1), tableData.mainPanel)" ng-class="{selectable: tableData.mainPanel}">\n                     <td ng-repeat="data in row track by $index">\n                         <span class="yucca-dataset-multidata-treemap-value">{{data|safeNumber:decimalValue:isEuroValue()}}</span>\n                     </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-dataset-multidata-treemap-toolbar">\n            <a href ng-click="panel=\'chart\'" ng-class="{active: panel == \'chart\'}">Chart</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetPopulationPyramid",["metadataService","dataService","$yuccaHelpers","$rootScope",function(e,t,a,n){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_population_pyramid.html",link:function(e,n,r){var l="YuccaDatasetPopulationPyramid";e.widgetId=a.attrs.safe(r.widgetId,l+(new Date).getTime()),e.debug="true"===r.debug;var o=r.userToken;e.panel=a.attrs.safe(r.landingPanel,"chart");var s=r.filter,i=a.attrs.safe(r.genderColumn,null),d=e.$eval(r.genderLabels);"undefined"!=typeof d&&null!=d&&0!=d.length||(d=["F","M"]);var c=e.$eval(r.genderValues);"undefined"!=typeof c&&null!=c&&0!=c.length||(c=["F","M"]);var u=e.$eval(r.genderColors);"undefined"!=typeof u&&null!=u&&2==u.length||(u=["#f8a0df","#19aeff"]);var g=a.attrs.safe(r.ageColumn,null),p=a.attrs.safe(r.ageValues,null),p=e.$eval(r.ageValues);"undefined"==typeof p||null==p||0==p.length;var v=e.$eval(r.ageLabels);"undefined"!=typeof v&&null!=v&&0!=v.length||(v=null);var f=a.attrs.safe(r.valueColumn,null),h=a.attrs.safe(r.countingMode,"count"),m=a.attrs.num(r.chartHeight,100,null,400),y=a.attrs.safe(r.chartType,"multiBarHorizontalChart"),b=a.attrs.safe(r.groupingWay,"stacked"),w=!1;"stacked"==b&&(w=!0);a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1);e.$on("yucca-widget-event",function(t,a){console.log("yucca-widget-event",a),void 0!=typeof a&&null!=a&&a.sourceId!=e.widgetId&&(a.data.datasetcode==r.datasetCode&&"dataset.filter.column"==a.eventtype?e.selected=a.data.value.toUpperCase():a.data.datasetcode==r.datasetCode&&"dataset.change.column"==a.eventtype&&(f=a.data.column,k(_)))});var x=function(t,a,n,r,l){var o=(t.index,"");o+="  <h3 class='yucca-dataset-population-pyramid-tooltip-header'>"+t.value+"</h3>",o+="<div class='yucca-dataset-population-pyramid-tooltip'>",o+="  <table><tbody>";for(var s=0;s<e.chartData.length;s++)for(var i=e.chartData[s],d=0;d<i.values.length;d++){var c=i.values[d];if(c.label==t.value){var u="";i.key==t.data.key&&(u="font-weight:  bold; color: "+i.color+";"),o+="  <tr style='"+u+"'>",o+="      <td><span class='yucca-dataset-population-pyramid-tooltip-label'>"+c.key+"</span></td>",o+="      <td><span class='yucca-dataset-population-pyramid-tooltip-value'>"+c.valueLabel+"</span></td>",o+="  </tr>"}}return o+="  </tbody></table>",o+="</div>"};e.options={chart:{type:y,height:parseInt(m),margin:{left:64},x:function(e){return e.label},y:function(e){return e.value},showValues:!0,valueFormat:function(e){return parseInt(e)},duration:500,stacked:w,xAxis:{showMaxMin:!1},yAxis:{axisLabelDistance:-10,tickFormat:function(e){return Math.abs(e)}},tooltip:{contentGenerator:x},legend:{maxKeyLength:50}}};var k=function(t){try{e.chartData=[{key:d[0],color:u[0],values:[]},{key:d[1],color:u[1],values:[]}],e.tableData=[];var a={},n={};if(null!=p)for(var r=0;r<p.length;r++)a[p[r]]=0,n[p[r]]=0;for(var r=0;r<t.length;r++){var l=t[r];"undefined"==typeof a[l[g]]&&(a[l[g]]=0,n[l[g]]=0),console.log("d",l),console.log("valueColumn",f),console.log("d[valueColumn]",f,l[f]);var o=isNaN(l[f])?0:parseInt(l[f]);l[i]==c[0]?"count"==h?a[l[g]]--:"sum"==h&&(a[l[g]]-=parseInt(o)):l[i]==c[1]&&("count"==h?n[l[g]]++:"sum"==h&&(n[l[g]]+=parseInt(o)))}for(var s in a)if(a.hasOwnProperty(s)){var m=s;null!=v&&"undefined"!=typeof v[s]&&null!=v[s]&&(m=v[s]),e.chartData[0].values.push({label:m,value:a[s],valueLabel:-1*a[s]}),e.chartData[1].values.push({label:m,value:n[s],valueLabel:n[s]}),e.tableData.push([s,-1*a[s],n[s]])}var y=D(e.chartData[0].values),b=d3.select("#"+e.widgetId+"-fake").insert("svg").append("text").text(y);e.options.chart.margin.left=b.node().getComputedTextLength(),console.log("maxLabel",y,b.node().getComputedTextLength()),d3.select("#"+e.widgetId+"-fake").remove(),console.log("chartData",e.chartData),console.log("tableData",e.tableData)}catch(w){console.error("groupData",w)}},D=function(e){var t="";if(e)for(var a=0;a<e.length;a++)e[a].label.length>t.length&&(t=e[a].label);return t};e.isLoading=!0;var _=[];t.getDataEntities(r.datasetCode,o,s,0,1,null).then(function(a){console.log("firstData",a),t.getMultipleDataEnties(r.datasetCode,o,s,"internalId%20desc",a.data.d.__count).then(function(t){console.log("data",t);for(var a=0;a<t.length;a++)_=_.concat(t[a].data.d.results);console.log("allData",_),e.isLoading=!1,k(_)})}),console.log("attrs",r),e.widgetTitle=r.widgetTitle,e.widgetIntro=a.attrs.safe(r.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_population_pyramid.html",'<div class="yucca-widget yucca-dataset-population-pyramid" id="{{widgetId}}>\n    <header class="yucca-dataset-population-pyramid-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div id="{{widgetId}}-fake"></div>    <div class="yucca-dataset-population-pyramid-content">\n        <section class="yucca-dataset-population-pyramid-chart" ng-show="panel==\'chart\'">\n           <div ng-show="isLoading" class="yucca-dataset-pyramid-data-loading" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px" ><p>Loading&hellip;</p>\n             <div class="yucca-widget-spinner"> <div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n        \t<nvd3 options="options" data="chartData" ></nvd3>\n        </section>\n        <section class="yucca-dataset-population-pyramid-data"  ng-show="panel==\'data\'">\n           <div ng-show="isLoading" class="yucca-dataset-pyramid-data-loading" style="min-height: {{chartHeight}}px;min-width: {{chartWidth}}px" ><p>Loading&hellip;</p>\n             <div class="yucca-widget-spinner"> <div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <table class="yucca-dataset-population-pyramid-table" ng-show="!isLoading" >\n               <thead >\n                  <tr>\n                      <th>{{tableData.title}}</th>\n                      <th>F</th>\n                      <th>M</th>\n                  </tr>\n               </thead>\n               <tbody>\n                   <tr ng-repeat="row in tableData track by $index">\n                     <td ng-repeat="data in row track by $index">\n                         <span>{{data}}</span>\n                     </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-dataset-population-pyramid-toolbar">\n            <a href ng-click="panel=\'chart\'" ng-class="{active: panel == \'chart\'}">Chart</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaStreamLastValue",["metadataService","dataService","$yuccaHelpers","$interval","$window",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_last_value.html",link:function(l,o,s){var i=!0;r.onblur=function(){console.log(">onblur"),i=!1},r.onfocus=function(){console.log(">onfocus"),i=!0},l.debug="true"===s.debug;var d=s.userToken;l.debugMessages=[],l.showLastUpdate="true"===a.attrs.safe(s.showLastUpdate,!1);var c=a.attrs.safe(s.chartType,"lineChart"),u=a.attrs.num(s.chartHeight,null,null,60),g=a.attrs.num(s.chartWidth,null,null,200),p=a.attrs.safe(s.chartColor,"#0050ef");console.log("chartColor",p);var v=l.$eval(s.labels);"undefined"!=typeof v&&null!=v&&0!=v.length||(v=null);var f=l.$eval(s.components);"undefined"!=typeof f&&null!=f&&0!=f.length||(f=null);var h=function(e,t,a,n,r){var l=(e.index,"");return l="lineChart"==c?e.point.tooltip:e.data.tooltip};l.stream={};var m=new Array;l.lastupdate=new Date,l.options={chart:{type:c,width:g,height:u,interpolate:"basis",showXAxis:!1,showYAxis:!1,showLegend:!1,margin:{top:0,right:6,bottom:25,left:6},x:function(e){return e.x},tooltip:{contentGenerator:h},duration:250}};var y=function(e,t){return{x:parseFloat(e.getTime()),y:parseFloat(t),tooltip:"<h3 class='yucca-stream-tweet-stats-tooltip-header'>"+a.utils.formatStreamDate(e.getTime(),!0)+"</h3><p>Value :<strong>"+t+"</strong></p>"}},b=!1,w=function(e){b=!0;var t=JSON.parse(e.body),a=t.values[0];l.lastupdate=a.time;for(var n=0;n<l.stream.components.length;n++){var r=l.stream.components[n];for(var o in a.components)if(a.components.hasOwnProperty(o)&&o==r.name){l.stream.components[n].lastValue=a.components[o],l.stream.components[n].lastUpdate=a.time,l.stream.components[n].chartData[0].values.push(y(new Date(a.time),a.components[o])),l.stream.components[n].chartData[0].values.length>50&&l.stream.components[n].chartData[0].values.shift();var s=x(l.stream.components[n].chartData[0].values);l.stream.components[n].minXValue=s[0],l.stream.components[n].maxXValue=s[1],l.stream.components[n].delta=k(l.stream.components[n].chartData[0].values)}}},x=function(e){var t=null,a=null;if("undefined"!=typeof e&&null!=e&&e.length>0)for(var n=0;n<e.length;n++)(null==t||t>e[n].x)&&(t=e[n].x),(null==a||a<e[n].x)&&(a=e[n].x);return[t,a]},k=function(e){var t=null;return"undefined"!=typeof e&&null!=e&&(t=e.length>1?parseFloat(e[e.length-1].y)-parseFloat(e[e.length-2].y):0,t=t.toPrecision(2)),t};void 0!=typeof s.tenantCode&&null!=s.tenantCode&&void 0!=typeof s.streamCode&&null!=s.streamCode&&void 0!=typeof s.smartobjectCode&&null!=s.smartobjectCode?e.getStreamMetadata(s.tenantCode,s.streamCode,s.smartobjectCode,d).success(function(e){if(l.stream.name=e.name,null==f)l.stream.components=e.stream.components,m=e.stream.components;else{l.stream.components=[];for(var n=0;n<e.stream.components.length;n++)for(var r=0;r<f.length;r++)if(f[r]==e.stream.components[n].name){l.stream.components.push(e.stream.components[n]),m.push(e.stream.components[n]);break}}for(var n=0;n<l.stream.components.length;n++)if(l.stream.components[n].chartData=[{key:"data",values:[],color:p}],null!=v)try{l.stream.components[n].label=v[n]}catch(o){l.stream.components[n].label=l.stream.components[n].name,console.error("Component's label not valid")}else l.stream.components[n].label=l.stream.components[n].name;"undefined"!=typeof e.dataset&&null!=e.dataset&&"undefined"!=typeof e.dataset.code&&null!=e.dataset.code&&t.getMeasures(e.dataset.code,d,null,0,20,"time%20desc").success(function(n){return function(r){if(console.debug("getMeasures",n,r),null!=r.d.results&&r.d.results.length>0){r.d.results.reverse();for(var o=0;o<l.stream.components.length;o++){var s=l.stream.components[o];m[o].chartDataValues=new Array;for(var i=0;i<r.d.results.length;i++)null!=r.d.results[i][s.name]&&(0==i&&(l.stream.components[o].lastValue=r.d.results[i][s.name],l.stream.components[o].lastUpdate=a.utils.mongoDate2string(r.d.results[i].time)),m[o].chartDataValues.push(y(a.utils.mongoDate2millis(r.d.results[i].time),r.d.results[i][s.name])));var c=x(m[o].chartDataValues);l.stream.components[o].minXValue=c[0],l.stream.components[o].maxXValue=c[1],l.stream.components[o].delta=k(m[o].chartDataValues)}t.getLastValue(e.tenantCode,e.stream.code,e.stream.smartobject.code,d,w,e.code),b=!0}}}(e.code)),t.getLastValue(e.tenantCode,e.stream.code,e.stream.smartobject.code,d,w,e.code)}).error(function(e){console.log("error",e),l.debugMessages.push("Stream not found: "+l.stream)}):l.debugMessages.push("Invalid stream definition: tenantCode: "+s.tenantCode+" - streamCode: "+s.streamCode+" - smartobjectCode: "+s.smartobjectCode),console.debug("attrs",s),l.widgetTitle=a.attrs.safe(s.widgetTitle,null),l.widgetIntro=a.attrs.safe(s.widgetIntro,null),n(function(){if(b&&i){b=!1;for(var e=0;e<m.length;e++)"undefined"!=typeof m[e].chartDataValues&&(l.stream.components[e].chartData[0].values=m[e].chartDataValues.slice())}},1e3)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/stream_last_value.html",'<div class="yucca-widget yucca-stream-last-value">\n    <header class="yucca-stream-last-value-header" ng-show="widgetTitle!=null"> \n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-last-value-content">\n        <section class="yucca-stream-last-value-data">\n           <div class="yucca-stream-last-value-panel " ng-repeat-start="component in stream.components track by $index"> \n               <div class="yucca-stream-last-value-component-name"><span title="Phenomenon: {{component.phenomenon}}">{{component.label}}</span></div>\n               <div class="yucca-stream-last-value-component-panel"> \n                   <div class="yucca-stream-last-value-component-value" title="Exact value: {{component.lastValue}} - Updated at: {{component.lastUpdate|date:\'dd/MM/yyyy  H:mm\'}}">{{component.lastValue|format_big_number}}</div>\n                   <div class="yucca-stream-last-value-component-value-info"> \n                       <div class="yucca-stream-last-value-component-trend" ng-show="component.delta!=null" title="Value trend">\n\t\t\t\t\t        <span class="trend-up" ng-show="component.delta>0">&plus;</span>\n\t\t\t\t\t        <span class="trend-down" ng-show="component.delta<0"></span>\n\t\t\t\t\t        <span class="trend-stable" ng-show="component.delta==0"></span>\n\t\t\t\t\t        {{component.delta}}\n                       </div>\n                       <div class="yucca-stream-last-component-measureunit">{{component.measureunit}}</span> </div>\n                   </div>\n               </div>\n               <div class="yucca-stream-last-value-component-chart" ng-show="component.chartData[0].values.length>1"><nvd3 options="options" data="component.chartData"></nvd3></div>\n               <div class="yucca-stream-last-value-component-chart-x-xAxis" ng-show="component.chartData[0].values.length>1">\n                   <div class="min-value"><span class="value-hour">{{component.minXValue|date:"H:mm"}}</span><span class="value-date">{{component.minXValue|date:"dd MMM yyyy"}}</span></div>\n                   <div class="max-value"><span class="value-hour">{{component.maxXValue|date:"H:mm"}}</span><span class="value-date">{{component.maxXValue|date:"dd MMM yyyy"}}</span></div>\n               </div>\n           </div>\n           <div class="yucca-stream-last-value-panel-separator " ng-repeat-end ng-hide="$index<stream.components.length"></div>\n        </section>\n        <section class="yucca-stream-last-value-lastupdate-bar" ng-show="showLastUpdate">\n            Updated at: {{lastupdate|date:"dd/MM/yyyy  H:mm"}}\n        </section>\n    </div>\n    <footer>\n        <a href="http://www.smartdatanet.it/" target="_blank" title="Powered by smartdatanet.it">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaStreamMonitor",["metadataService","dataService","$yuccaHelpers","$interval","$window",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_monitor.html",link:function(l,o,s){var i=!0;r.onblur=function(){console.log(">onblur"),i=!1},r.onfocus=function(){console.log(">onfocus"),i=!0};var d=s.filter;l.debug="true"===s.debug;var c=s.userToken;l.panel=a.attrs.safe(s.landingPanel,"chart"),l.debugMessages=[],l.showLastUpdate="true"===a.attrs.safe(s.showLastUpdate,!1);var u=a.attrs.safe(s.chartType,"lineChart"),g=a.attrs.num(s.chartHeight,null,null,300),p=a.attrs.num(s.chartWidth,null,null,400),v=l.$eval(s.chartColors);"undefined"!=typeof v&&null!=v&&0!=v.length||(v=Constants.LINE_CHART_COLORS);var f=l.$eval(s.labels);"undefined"!=typeof f&&null!=f&&0!=f.length||(f=null);var f=l.$eval(s.labels);"undefined"!=typeof f&&null!=f&&0!=f.length||(f=null);var h=l.$eval(s.components);"undefined"!=typeof h&&null!=h&&0!=h.length||(h=null),l.stream={},l.lastupdate=new Date,l.options={chart:{type:u,width:p,height:g,useInteractiveGuideline:!0,margin:{top:2,right:2,bottom:2,left:2},x:function(e){return e.x},xAxis:{tickFormat:function(e){return a.utils.formatDateFromMillis(e)}},duration:250}},l.stream.tableDataValues=[],l.stream.chartData=[];var m=new Array,y=function(e,t){var a={x:parseFloat(e.getTime()),y:parseFloat(t)};return a},b=!1,w=function(e){b=!0;var t=JSON.parse(e.body),n=t.values[0];l.lastupdate=n.time,l.stream.tableDataValues.push([a.utils.formatDateFromMillis(new Date(n.time))]);for(var r=0;r<l.stream.components.length;r++){var o=l.stream.components[r];for(var s in n.components)if(n.components.hasOwnProperty(s)&&s==o.name){l.stream.components[r].lastValue=n.components[s],l.stream.components[r].lastUpdate=n.time;for(var i=0;i<m.length;i++)if(m[i].name==o.name){m[i].values.push(y(new Date(n.time),n.components[s])),m[i].values.length>200&&m[i].values.shift();var d=x(m[i].values);l.stream.components[r].minXValue=d[0],l.stream.components[r].maxXValue=d[1];break}l.stream.tableDataValues[l.stream.tableDataValues.length-1].push(n.components[s])}}l.stream.tableDataValues.length>20&&l.stream.tableDataValues.shift()},x=function(e){var t=null,a=null;if("undefined"!=typeof e&&null!=e&&e.length>0)for(var n=0;n<e.length;n++)(null==t||t>e[n].x)&&(t=e[n].x),(null==a||a<e[n].x)&&(a=e[n].x);return[t,a]};void 0!=typeof s.tenantCode&&null!=s.tenantCode&&void 0!=typeof s.streamCode&&null!=s.streamCode&&void 0!=typeof s.smartobjectCode&&null!=s.smartobjectCode?e.getStreamMetadata(s.tenantCode,s.streamCode,s.smartobjectCode,c).success(function(e){console.log("metadata",e),l.stream.name=e.name;var n=0;if(null==h)l.stream.components=e.stream.components;else{l.stream.components=[];for(var r=0;r<e.stream.components.length;r++)for(var o=0;o<h.length;o++)if(h[o]==e.stream.components[r].name){l.stream.components.push(e.stream.components[r]);break}}for(var r=0;r<l.stream.components.length;r++)if(null!=f&&r<f.length)try{l.stream.components[r].label=f[r]}catch(s){l.stream.components[r].label=l.stream.components[r].name,console.error("Component's label not valid")}else l.stream.components[r].label=l.stream.components[r].name;for(var i=0;i<l.stream.components.length;i++){var u=l.stream.components[i];n<v.length?n++:n=0,m.push({name:u.name,key:u.label,values:[],color:v[n]}),l.stream.chartData.push({name:u.name,key:u.label,values:[],color:v[n]})}"undefined"!=typeof e.dataset&&null!=e.dataset&&"undefined"!=typeof e.dataset.code&&null!=e.dataset.code&&t.getMeasures(e.dataset.code,c,d,0,20,"time%20desc").success(function(n){return function(r){if(console.debug("getMeasures",n,r),null!=r.d.results&&r.d.results.length>0){r.d.results.reverse(),l.stream.tableDataValues=[];for(var o=0;o<r.d.results.length;o++){l.stream.tableDataValues[o]=[a.utils.mongoDate2string(r.d.results[o].time)];for(var s=0;s<l.stream.components.length;s++)"undefined"!=typeof r.d.results[o][l.stream.components[s].name]&&null!=r.d.results[o][l.stream.components[s].name]?l.stream.tableDataValues[o].push(r.d.results[o][l.stream.components[s].name]):l.stream.tableDataValues[o].push("-")}for(var s=0;s<l.stream.components.length;s++){var i=l.stream.components[s];m[s].values=[];for(var o=0;o<r.d.results.length;o++)null!=r.d.results[o][i.name]&&(0==o&&(l.stream.components[s].lastValue=r.d.results[o][i.name],l.stream.components[s].lastUpdate=a.utils.mongoDate2string(r.d.results[o].time)),m[s].values.push(y(a.utils.mongoDate2millis(r.d.results[o].time),r.d.results[o][i.name])));var d=x(m[s].values);l.stream.components[s].minXValue=d[0],l.stream.components[s].maxXValue=d[1]}console.log("..",l.stream),b=!0,t.getLastValue(e.tenantCode,e.stream.code,e.stream.smartobject.code,c,w,e.code)}}}(e.code)),t.getLastValue(e.tenantCode,e.stream.code,e.stream.smartobject.code,c,w,e.code)}).error(function(e){console.log("error",e),l.debugMessages.push("Stream not found: "+l.stream)}):l.debugMessages.push("Invalid stream definition: tenantCode: "+s.tenantCode+" - streamCode: "+s.streamCode+" - smartobjectCode: "+s.smartobjectCode),console.debug("attrs",s),l.widgetTitle=a.attrs.safe(s.widgetTitle,null),l.widgetIntro=a.attrs.safe(s.widgetIntro,null),n(function(){if(b&&i){b=!1;for(var e=0;e<m.length;e++)l.stream.chartData[e].values=m[e].values.slice()}},1e3)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/stream_monitor.html",'<div class="yucca-widget yucca-stream-monitor">\n    <header class="yucca-stream-monitor-header" ng-show="widgetTitle!=null"> \n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-monitor-content">\n        <section class="yucca-stream-monitor-chart"  ng-show="panel==\'chart\'">\n            <nvd3 options="options" data="stream.chartData"></nvd3>\n            <div class="yucca-stream-monitor-chart-x-xAxis" ng-show="stream.chartData.length>0">\n            \t<div class="min-value"><span class="value-hour">{{stream.components[0].minXValue|date:"H:mm"}}</span><span class="value-date">{{stream.components[0].minXValue|date:"dd MMM yyyy"}}</span></div>\n               <div class="max-value"><span class="value-hour">{{stream.components[0].maxXValue|date:"H:mm"}}</span><span class="value-date">{{stream.components[0].maxXValue|date:"dd MMM yyyy"}}</span></div>\n            </div>\n        </section>\n        <section class="yucca-stream-monitor-data" ng-show="panel==\'data\'">\n           <table class="yucca-stream-monitor-data-table">\n               <thead>\n                   <tr><th>Time</th><th ng-repeat="component in stream.components track by $index">{{component.label}}</th></tr>\n               </thead>\n               <tbody>\n                   <tr ng-repeat="row in stream.tableDataValues track by $index">\n                     <td ng-repeat="data in row track by $index">\n                         <span class="yucca-stream-monitor-data-table">{{data}}</span> \n                     </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-stream-monitor-lastupdate-bar" ng-show="showLastUpdate">\n            Updated at: {{lastupdate|date:"dd/MM/yyyy  H:mm"}}\n        </section>\n        <section class="yucca-stream-monitor-toolbar">\n            <a href ng-click="panel=\'chart\'" ng-class="{active: panel == \'chart\'}">Chart</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaStreamMultistreamMap",["metadataService","dataService","$yuccaHelpers",function(e,t,a){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_multistream_map.html",link:function(t,n,r){t.debug="true"===r.debug;var l=r.userToken;t.panel=a.attrs.safe(r.landingPanel,"map"),t.debugMessages=[];var o=t.$eval(r.streams);t.streams={};var s=r.tenantCode,i=r.domain,d=r.searchQuery,c=null;console.log("attr.opendata",r.opendata),"undefined"!=typeof r.opendata&&(c="true"===r.opendata),void 0!=typeof o&&null!=o&&o.length>0||e.findMetadata(s,i,d,c,l).success(function(e){console.log("metadataList",e)}).error(function(){t.debugMessages.push("No data found: tenant="+s+", domain="+i+", search_query="+d+", opendata="+c)}),console.debug("attrs",r),t.widgetTitle=r.widgetTitle,t.widgetIntro=a.attrs.safe(r.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/stream_multistream_map.html",'<div class="yucca-widget yucca-stream-multistream-map">\n    <header class="yucca-stream-multistream-map-header">\n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-multistream-map-content">\n        <section class="yucca-stream-multistream-map-data">\n           <table class="yucca-stream-multistream-map-table">\n               <tbody ng-repeat="stream in streams track by $index" >\n                   <tr>\n                     <td class="yucca-stream-multistream-map-stream-row" colspan="100%">\n                         <span class="yucca-stream-multistream-map-component">{{stream.name}}</span>\n                     </td>\n                   </tr>\n                   <tr ng-repeat="component in stream.components track by $index">\n                     <td class="yucca-stream-multistream-map-component-name"><span title="Phenomenon: {{component.phenomenon}}">{{component.name}}</span></td>\n                     <td class="yucca-stream-multistream-map-component-bullet"><span class="yucca-stream-multistream-map-bullet bullet-{{component.bulletLevel}}" title="{{component.bulletsLevel}}"></span></td>\n                     <td class="yucca-stream-multistream-map-component-value" title="Updated at: {{component.lastUpdate|date:\'MM/dd/yyyy  H:mm\'}}"><span>{{component.lastValue}}</span> <span class="yucca-stream-multistream-component-measureunit">{{component.measureunit}}</span> </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-stream-multistream-map-lastupdate-bar">\n            Updated at: {{lastupdate|date:"MM/dd/yyyy  H:mm"}}\n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaStreamMultistreamStats",["metadataService","dataService","$yuccaHelpers","leafletData",function(e,t,a,n){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_multistream_stats.html",link:function(r,l,o){r.xAxisTickFormatFunction=function(){return function(e){return d3.time.format("%H:%M:%S")(new Date(e))}},r.panel=a.attrs.safe(o.landingPanel,"map");var s=function(e){return parseInt(e)},i=function(e){return e.hour},d=null,c=null,u=40,g=80;r.mapId="map"+(new Date).getTime();var p=function(){for(var e in r.allData)if(r.allData[e].hasOwnProperty("tableData")){var t=r.allData[e].tableData[1];(null==d||t<d)&&(d=t),(null==c||t>c)&&(c=t)}console.log("min max",d,c)};r.refreshMarker=function(){console.log("scope.allData",r.allData),r.mapData.markerstyles=[];var e=r.allData[r.currentTimeStats];if(console.log("allData",r.allData),!a.utils.isEmpty(e)){console.log("dataAtTime",e);for(var t=0;t<r.allData.datasetsCode.length;t++){var n=parseFloat(e.tableData[t+1]).toFixed(1);n="NaN"===n?0:n,console.log("data",n);var l=(n-d)/(c-d),o=parseInt(u+(g-u)*l),s=r.allData.datasetsCode[t];r.mapData.markerstyles.push(".marker"+s+"{font-size: "+o/2.2+"px; line-height:"+o+"px; border-color:"+b(n,1)+"; background-color:"+b(n,.5)+";}");var i={type:"div",iconSize:[o,o],className:"marker marker"+s,popupAnchor:[0,0],html:n};r.mapData.markers["m_"+s].icon=i}}};var v=a.attrs.num(o.chartHeight,100,null,300),f=a.attrs.safe(o.chartType,"lineChart"),h=(r.$eval(o.chartColors),function(e,t,a,n,r){console.log("key",e);var l=(e.index,"");return l="lineChart"==f?e.point.tooltip:e.data.tooltip});r.options={chart:{type:f,height:v,margin:{top:24,right:24,bottom:24,left:36},interpolate:"basis",x:function(e){return e.x},y:function(e){return e.y},showValues:!0,showLegend:!1,valueFormat:s,duration:500,showXAxis:!0,xAxis:{axisLabel:"Time"+a.odata.timeGroup2resultKey(D)},yAxis:{axisLabel:"",axisLabelDistance:-10},tooltip:{contentGenerator:h}}},r.maxStats=23,r.allData={},r.mapData={markers:{},markerstyles:[]};var m=[];r.currentTimeStats=5;r.allData.tableHeader=["Time"],
r.allData.datasetsCode=[];var y=["#009100","#9ade00","#edd400","#f57900","#cc0000"],b=function(e,t){var n=y[2];if(c-d!=0){var r=(e-d)/(c-d),l=parseInt(r*y.length);l>=y.length&&(l=y.length-1),n=y[l]}return"undefined"==typeof n&&(n=y[2]),"rgba("+a.utils.hex2Rgb(n)+","+t+")"},w=function(e,t){r.allData.datasetsCode.push(e.code),r.allData.tableHeader.push(e.code);for(var l=0;l<t.data.length;l++){var o=t.data[l],s=i(t.data[l]);r.allData[s]&&null!=r.allData[s]||(r.allData[s]={},r.allData[s].tableData=[],r.allData[s].tableData.push(o.hour)),r.allData[s].tableData.push(o.value_sts)}if(!a.utils.isEmpty(e.stream)&&!a.utils.isEmpty(e.stream.smartobject.latitude)){var d={lat:parseFloat(e.stream.smartobject.latitude),lng:parseFloat(e.stream.smartobject.longitude),message:e.code},c={type:"div",className:"marker marker"+e.code,popupAnchor:[0,0],html:"-"};d.icon=c,r.mapData.markers["m_"+e.code]=d,r.mapData.markerstyles.push(".marker"+e.code+"{border-radius: 100%;width:30px; height:30px;border:solid 2px red}"),m.push([d.lat,d.lng]),n.getMap().then(function(e){e.invalidateSize(),e.fitBounds(m,{padding:[32,32]})})}},x=a.odata.decodeDateFilter(o),k=x.timeFilter,D=a.attrs.safe(o.timeGroupBy,a.odata.extractTimeGroupFilter(x.minDateMillis,x.maxDateMillis)),_=r.$eval(o.datasets),C=o.userToken;if(_&&null!=_&&_.length>0)for(var I=0;I<_.length;I++){var M=_[I][0],L=_[I][1];e.getDatasetMetadata(M,L).success(function(e){var a=e,n=Object.keys(e).length;n>0&&a&&null!=a&&t.getMeasuresStats(a.dataset.code,C,D,"avg,value",k,null,null,"year,month,dayofmonth,hour").success(function(e){console.log("response",e);var t={key:a.code,metadata:a,data:e.d.results};w(a,t),p(),r.refreshMarker()}).error(function(e){console.error("getDatasetMetadata: error",e)})})}console.log("attrs",o),r.widgetTitle=o.widgetTitle,r.widgetIntro=a.attrs.safe(o.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/stream_multistream_stats.html",'<div class="yucca-widget yucca-stream-multistream-stats">\n    <header class="yucca-stream-multistream-stats-header">\n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-multistream-stats-content">\n        <section class="yucca-stream-multistream-stats-map" ng-show="panel==\'map\'">\n           <style>.marker{border-radius: 100%;border:solid 4px;background-color: white; text-align: center;padding-top: -8px;}</style>\n           <style ng-repeat="style in mapData.markerstyles track by $index">{{style}}</style>\n           <leaflet id="{{mapId}}" width="100%" height="300px" markers="mapData.markers"></leaflet>\n           <div class="range-panel"><div class="range-min">0</div><div class="range-container">\n                <div class="range-value">{{currentTimeStats}} h</div>\n                <input type="range" name="points" min="0" max="{{maxStats}}"                     ng-model="currentTimeStats" ng-change="refreshMarker()" class="range-input"></div>\n               <div class="range-max">{{maxStats}}</div>\n           </div> \n        </section>\n        <section class="yucca-stream-multistream-stats-data" ng-show="panel==\'data\'" >\n           <table class="yucca-stream-multistream-stats-table">\n               <thead>\n                   <tr><th ng-repeat="titles in allData.tableHeader track by $index">{{titles}}</th></tr>\n               </thead>\n               <tbody>\n                   <tr ng-repeat="(key, value) in allData track by $index">\n                     <td ng-repeat="data in value.tableData track by $index">{{data}}</td>\n                   </tr>\n               </tbody>\n           </table>\n           <div class="yucca-stream-multistream-stats-component" ng-repeat="(key, value) in lastMessage.values[0].components">               <div class="yucca-stream-multistream-stats-component-key">{{key}}</div>\n               <div class="yucca-stream-multistream-stats-component-value">{{value}}</div>\n               <div class="yucca-stream-multistream-stats-component-measure-unit">{{componentsMap[key].measureUnit}}</div>\n           </div>\n        </section>\n        <section class="yucca-stream-multistream-stats-data" ng-hide="allData!=null">\n           No data\n        </section>\n        <section class="yucca-stream-multistream-stats-total-count">\n            Total: {{totalCount}}\n        </section>\n        <section class="yucca-stream-multistream-stats-toolbar">\n            <a href ng-click="panel=\'map\'" ng-class="{active: panel == \'map\'}">Map</a> | <a href ng-click="panel=\'data\'" ng-class="{active: panel == \'data\'}">Data</a> \n        </section>\n    </div>\n    <footer>\n        <div class="credits-intro">powered by</div>\n        <a href="http://www.smartdataplatform.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaStreamMultistreamValue",["metadataService","dataService","$yuccaHelpers",function(e,t,a){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_multistream_value.html",link:function(n,r,l){n.debug="true"===l.debug;var o=l.userToken;n.debugMessages=[];var s=n.$eval(l.streams);n.streams={},n.lastupdate=new Date;var i=function(e){var t="",a=parseFloat(e.lastValue);if(null!=a){var t="ok";("-"!=e.minWarning&&a<e.minWarning||"-"!=e.maxWarning&&a>e.maxWarning)&&(t="warning"),("-"!=e.minCritical&&a<e.minCritical||"-"!=e.maxCritical&&a>e.maxCritical)&&(t="critical")}return t},d=function(e,t){var a=JSON.parse(e.body);void 0!=typeof t&&null!=t||(t=e.headers.destination.replace("/topic/output.",""));var r=a.values[0];n.lastupdate=r.time;for(var l=0;l<n.streams[t].components.length;l++){var o=n.streams[t].components[l];for(var s in r.components)r.components.hasOwnProperty(s)&&s==o.name&&(n.streams[t].components[l].lastValue=r.components[s],n.streams[t].components[l].bulletLevel=i(n.streams[t].components[l]))}};if(void 0!=typeof s&&null!=s&&s.length>0)for(var c=0;c<s.length;c++){var u=s[c];e.getStreamMetadata(u.tenantCode,u.streamCode,u.smartobjectCode,o).success(function(e){var r={};r.name=e.name,r.components=[];for(var l=0;l<s.length;l++)if(s[l].tenantCode==e.tenantCode&&s[l].streamCode==e.stream.code&&s[l].smartobjectCode==e.stream.smartobject.code)for(var c=0;c<s[l].components.length;c++)for(var u=0;u<e.stream.components.length;u++)if(e.stream.components[u].name==s[l].components[c].name){var g={};g.name=e.stream.components[u].name,g.phenomenon=e.stream.components[u].phenomenon,g.measureunit=e.stream.components[u].measureunit,g.label=a.attrs.safe(s[l].components[c].label,g.name),g.minWarning=a.attrs.safe(s[l].components[c].minWarning,"-"),g.minCritical=a.attrs.safe(s[l].components[c].minCritical,"-"),g.maxWarning=a.attrs.safe(s[l].components[c].maxWarning,"-"),g.maxCritical=a.attrs.safe(s[l].components[c].maxCritical,"-"),g.bulletsLevel="Min Critical: "+g.minCritical+" \r Min Warning: "+g.minWarning+" \rMax Warning: "+g.maxWarning+" \rMax Critical: "+g.maxCritical,r.components.push(g)}n.streams[e.code]=r,"undefined"!=typeof e.dataset&&null!=e.dataset&&"undefined"!=typeof e.dataset.code&&null!=e.dataset.code?(console.debug("load past data"),t.getMeasures(e.dataset.code,o,null,0,1,"time%20desc").success(function(r){return function(l){if(console.debug("getMeasures",r,l),null!=l.d.results&&l.d.results.length>0){for(var s=0;s<n.streams[r].components.length;s++){var c=n.streams[r].components[s];null!=l.d.results[0][c.name]&&(n.streams[r].components[s].lastValue=l.d.results[0][c.name],n.streams[r].components[s].lastUpdate=a.utils.mongoDate2string(l.d.results[0].time),n.streams[r].components[s].bulletLevel=i(n.streams[r].components[s]))}t.getLastValue(e.tenantCode,e.stream.code,e.stream.smartobject.code,o,d,e.code)}}}(e.code))):t.getLastValue(e.tenantCode,e.stream.code,e.stream.smartobject.code,o,d,e.code)}).error(function(){n.debugMessages.push("Stream not found: "+u)})}else n.debugMessages.push("Invalid streams definition: "+s+" - streams must be an array like this [{'tenantCode':'...', 'streamCode':'...', 'smartobjectCode':'...', components: [{component:'',min:'',max:''}], ...");console.debug("attrs",l),n.widgetTitle=l.widgetTitle,n.widgetIntro=a.attrs.safe(l.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/stream_multistream_value.html",'<div class="yucca-widget yucca-stream-multistream-value">\n    <header class="yucca-stream-multistream-value-header">\n        {{widgetTitle}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-multistream-value-content">\n        <section class="yucca-stream-multistream-value-data">\n           <table class="yucca-stream-multistream-value-table">\n               <tbody ng-repeat="stream in streams track by $index" >\n                   <tr>\n                     <td class="yucca-stream-multistream-value-stream-row" colspan="100%">\n                         <span class="yucca-stream-multistream-value-component">{{stream.name}}</span>\n                     </td>\n                   </tr>\n                   <tr ng-repeat="component in stream.components track by $index">\n                     <td class="yucca-stream-multistream-value-component-name"><span title="Phenomenon: {{component.phenomenon}}">{{component.label}}</span></td>\n                     <td class="yucca-stream-multistream-value-component-bullet"><span class="yucca-stream-multistream-value-bullet bullet-{{component.bulletLevel}}" title="{{component.bulletsLevel}}"></span></td>\n                     <td class="yucca-stream-multistream-value-component-value" title="Updated at: {{component.lastUpdate|date:\'MM/dd/yyyy  H:mm\'}}"><span>{{component.lastValue}}</span> <span class="yucca-stream-multistream-component-measureunit">{{component.measureunit}}</span> </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-stream-multistream-value-lastupdate-bar">\n            Updated at: {{lastupdate|date:"MM/dd/yyyy  H:mm"}}\n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaStreamTweetStats",["metadataService","dataService","$yuccaHelpers",function(e,t,a){"use strict";return{restrict:"E",scope:{},templateUrl:"template/stream_tweet_stats.html",link:function(n,r,l){var o=a.attrs.num(l.chartHeight,100,null,300),s=a.attrs.safe(l.chartType,"lineChart"),i=n.$eval(l.chartColors);n.panel=a.attrs.safe(l.landingPanel,"chart"),"undefined"!=typeof i&&null!=i&&0!=i.length||(i=Constants.LINE_CHART_COLORS);var d=function(e){return parseInt(e)},c=function(e,t,a,n,r){console.log("key",e);var l=(e.index,"");return l="lineChart"==s?e.point.tooltip:e.data.tooltip};n.options={chart:{type:s,height:o,margin:{top:24,right:24,bottom:24,left:36},interpolate:"basis",x:function(e){return e.x},y:function(e){return e.y},showValues:!0,showLegend:!1,valueFormat:d,duration:500,showXAxis:!0,xAxis:{axisLabel:"Time"+a.odata.timeGroup2resultKey(v)},yAxis:{axisLabel:"",axisLabelDistance:-10},tooltip:{contentGenerator:c}}};var u=l.userToken,g=a.odata.decodeDateFilter(l),p=g.timeFilter,v=a.attrs.safe(l.timeGroupBy,a.odata.extractTimeGroupFilter(g.minDateMillis,g.maxDateMillis));n.xAxisLabel=a.odata.timeGroupLabel(v),n.statisticData=[],n.chartData=[],n.statisticData.push({label:"Tweets",value:"-"}),n.statisticData.push({label:"Unique Author",value:"-"}),n.statisticData.push({label:"Tweet/Hour",value:"-"}),n.statisticData.push({label:"Tweet/Author",value:"-"});var f=function(){n.statisticData[0].value>0&&n.statisticData[1].value>0?n.statisticData[3].value=(parseInt(n.statisticData[0].value)/parseInt(n.statisticData[1].value)).toFixed(2):n.statisticData[3].value="-"};n.lastTweets=[],n.mostRetweeted=[],e.getStreamMetadata(l.tenantCode,l.streamCode,l.smartobjectCode).success(function(e){console.log("metadata",e),n.metadata=e,null!=e.dataset.code&&(t.getSocialFeeds(e.dataset.code,u,p,null,10,"time desc").success(function(e){console.log("data",e);for(var t=0;t<e.d.results.length;t++)n.lastTweets.push(a.render.completeTweet(e.d.results[t],a.utils.mongoDate2string(e.d.results[t].createdAt)));n.statisticData[0].value=e.d.__count,f()}),t.getSocialFeeds(e.dataset.code,u,p,null,10,"retweetCount desc").success(function(e){console.log("data",e);for(var t=0;t<e.d.results.length;t++)n.mostRetweeted.push(a.render.completeTweet(e.d.results[t],a.utils.mongoDate2string(e.d.results[t].createdAt)))}),t.getSocialFeedsStats(e.dataset.code,u,v,"sum,tweetid",p,null,null,"year,month,dayofmonth,hour").success(function(e){console.log("statisticData",e);for(var t=[],r=0,l=0;l<e.d.results.length;l++){var o=e.d.results[l],s=a.odata.timeGroup2resultKey(v),d="<h3 class='yucca-stream-tweet-stats-tooltip-header'>";d+=a.utils.lZero(o.dayofmonth)+"/"+a.utils.lZero(o.month)+"/"+o.year,d+="</h3>",d+="<p>Tweet :<strong>"+o.count+"</strong></p>";var c={x:parseFloat(o[s]),y:parseFloat(o.count),tooltip:d};r<i.length&&(c.color=i[r],r++),t.push(c)}t.sort(function(e,t){return e.x-t.x}),n.chartData.push({key:"tweetData",values:t})}),t.getSocialFeedsStats(e.dataset.code,u,"iduser","first,tweetid",p,null,1,null).success(function(e){console.log("statisticData author",e),n.statisticData[1].value=e.d.__count,f()}),t.getSocialFeedsStats(e.dataset.code,u,"hour","sum,tweetid",p,null,1e3,null).success(function(e){if(console.log("statisticData tweet/hour",e),parseInt(e.d.__count)>0){for(var t=0,a=0;a<e.d.results.length;a++)t+=parseInt(e.d.results[a].count);n.statisticData[2].value=(t/e.d.__count).toFixed(2)}}))}),console.log("attrs",l),n.widgetTitle=l.widgetTitle,n.widgetIntro=a.attrs.safe(l.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/stream_tweet_stats.html",'<div class="yucca-widget yucca-stream-tweet-stats">\n    <header class="yucca-stream-tweet-stats-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-stream-tweet-stats-content">\n        <section class="yucca-stream-tweet-stats-chart" ng-show="panel==\'chart\'"">\n            <nvd3 options="options" data="chartData"></nvd3>\n            <div class="yucca-stream-tweet-stats-xaxis-label">{{xAxisLabel}}</div>        </section>\n        <section class="yucca-stream-tweet-stats-data"  ng-show="panel==\'chart\'">\n           <h4>Statistics</h4>\n           <table class="yucca-stream-tweet-stats-table">\n               <tbody>\n                   <tr >\n                     <td ng-repeat="data in statisticData track by $index">\n                         <span class="yucca-stream-tweet-stats-value">{{data.value}}</span><span class="yucca-stream-tweet-stats-label"> {{data.label}}</span>\n                     </td>\n                   </tr>\n               </tbody>\n           </table>\n        </section>\n        <section class="yucca-stream-tweet-stats-last-tweet" ng-show="panel==\'lastTweet\'" >\n           <h4>Last tweets</h4>\n           <div class="yucca-stream-tweet-stats-last-tweet-content">\n           \t<div ng-repeat="tweet in lastTweets track by $index" class="yucca-stream-tweet-stats-tweet">\n           \t\t<div class="tweet-message">\n           \t\t\t<div class="tweet-profile-image"><a href="{{tweet.twitterUserLink}}" target="_blank" title="View user on twitter">\n\t\t\t\t\t\t\t<img src="https://twitter.com/{{tweet.userScreenName}}/profile_image?size=normal" />\n\t\t\t\t\t\t</a></div>\n           \t\t\t<div class="tweet-author"><a href="{{tweet.twitterUserLink}}" target="_blank" title="View user on twitter">{{tweet.userScreenName}}</a>\n                           <a href="{{tweet.twitterLink}}" target="_blank" title="View on twitter" class="tweet-twitter-link"></a>\n                       </div>\n           \t\t\t<div class="tweet-text" ng-bind-html="tweet.getTextPretty"></div>\n           \t\t</div>\n           \t\t<div class="tweet-info">\n\t\t           \t\t<div class="tweet-statistic-icons">\n           \t\t\t\t<span class="tweet-retweet-icon">{{tweet.retweetCount}}</span>\n           \t\t\t\t<span  class="tweet-favorite-icon">{{tweet.favoriteCount}}</span>\n           \t\t\t</div>\n           \t\t\t<div class="tweet-date">{{tweet.createdAtFormatted}}</div>\n           \t\t</div>\n               </div>\n           </div>\n        </section>\n        <section class="yucca-stream-tweet-stats-most-retweet" ng-show="panel==\'mostRetweet\'" >\n           <h4>Most retweeted</h4>\n           <div class="yucca-stream-tweet-stats-most-retweet-content">\n           \t<div ng-repeat="tweet in mostRetweeted track by $index" class="yucca-stream-tweet-stats-tweet">\n           \t\t<div class="tweet-message">\n           \t\t\t<div class="tweet-profile-image"><a href="{{tweet.twitterUserLink}}" target="_blank" title="View user on twitter">\n\t\t\t\t\t\t\t<img src="https://twitter.com/{{tweet.userScreenName}}/profile_image?size=normal" />\n\t\t\t\t\t\t</a></div>\n           \t\t\t<div class="tweet-author"><a href="{{tweet.twitterUserLink}}" target="_blank" title="View user on twitter">{{tweet.userScreenName}}</a>\n                           <a href="{{tweet.twitterLink}}" target="_blank" title="View on twitter" class="tweet-twitter-link"></a>\n                       </div>\n           \t\t\t<div class="tweet-text" ng-bind-html="tweet.getTextPretty"></div>\n           \t\t</div>\n           \t\t<div class="tweet-info">\n\t\t           \t\t<div class="tweet-statistic-icons">\n           \t\t\t\t<span class="tweet-retweet-icon">{{tweet.retweetCount}}</span>\n           \t\t\t\t<span  class="tweet-favorite-icon">{{tweet.favoriteCount}}</span>\n           \t\t\t</div>\n           \t\t\t<div class="tweet-date">{{tweet.createdAtFormatted}}</div>\n           \t\t</div>\n               </div>\n           </div>\n        </section>\n        <section class="yucca-stream-tweet-stats-toolbar">\n            <a href ng-click="panel=\'chart\'" ng-class="{active: panel == \'chart\'}">Statistics</a> | <a href ng-click="panel=\'lastTweet\'" ng-class="{active: panel == \'lastTweet\'}">Last Tweet</a> | <a href ng-click="panel=\'mostRetweet\'" ng-class="{active: panel == \'mostRetweet\'}">Most Retweet</a> \n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("widgetHeader",function(){"use strict";return{restrict:"E",scope:{widgetTitle:"@",widgetSubtitle:"@"},template:'<header ng-if="widgetTitle || widgetSubtitle" class="yucca-widget-header">{{widgetTitle}} <small>{{widgetSubtitle}}</small></header>'}}),yuccaWidgetsModule.directive("widgetFooter",function(){"use strict";return{restrict:"E",scope:{widgetFooterText:"@"},template:'<footer class="yucca-widget-footer"><div class="yucca-credits"><div class="yucca-widget-footer-text">{{footerText}}</div><div class="yucca-credits-intro">powered by</div>        <a href="http://www.smartdatanet.it/" target="_blank">\n        SmartDataPlatform.it</a></div></footer>'}}),yuccaWidgetsModule.directive("wrap",function(){return{restrict:"E",tranclude:!0,template:'<div  style="background-color: red ; padding: 1em;" ></div>'}}),yuccaWidgetsModule.directive("widget",function(){"use strict";return{restrict:"E",template:"<div><header></header><wrap><div>Ciao</div></wrap><footer></footer></div>"}}),yuccaWidgetsModule.directive("one",function(e){return{template:"<div>I am one</div>",link:function(t,a,n){console.log("one",n,t.filter),t.ciao="ciao",t.ciao=function(t){e.$broadcast("saluto"," da ale "+t)}}}}),yuccaWidgetsModule.directive("two",function(e){return angular.extend({},e[0],{template:'<div>I am two {{ciao}} {{filter}} <a href ng-click="ciao(filter)">saluta</a></div>',link:function(e,t,a){console.log("two",a,e.filter),e.filter=a.filter}})}),yuccaWidgetsModule.directive("ngYuccaDatasetChoroplethMapChart",["metadataService","dataService","$yuccaHelpers","$http","$timeout","$compile","$rootScope",function(e,t,a,n,r,l,o){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_choropleth_map_chart.html",link:function(e,n,l){function s(e){return H(e)}function i(t){console.log("onAreaClick",t),console.log("groupByColumn",M),null!=R&&(R.properties.selected=!1),t.properties.selected=!t.properties.selected,R=t,a.utils.isTouchDevice?B(t):O();var n=a.event.createEvent(e.widgetId,d,"dataset.filter.text",{column:M.key,value:t.properties[E[A].key]},c);n.eventControlId=c,o.$broadcast("yucca-widget-event",n)}var d="YuccaControlMapChart";e.widgetId=a.attrs.safe(l.widgetId,d+(new Date).getTime());var c=a.attrs.safe(l.eventControlId,"EventControl-"+e.widgetId),u=new Array;e.widgetTitle=a.attrs.safe(l.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(l.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(l.widgetIntro,null),e.debug="true"===l.debug,e.debugMessages=[];var g=l.usertoken,p=l.filter,v=l.orderby,f=(a.attrs.num(l.top,1,1e3,1e3),a.attrs.num(l.top,null,null,1),a.attrs.safe(l.datasetcode,null));null==f&&e.debugMessages.push("Invalid dataset code");var h=a.attrs.safe(l.euroValue,!1),m=a.attrs.safe(l.decimalValue,2),y=a.attrs.safe(l.formatBigNumber,!1);e.isEuroValue=function(){return"true"==h};var b,w,x,k=("true"===l.skipZeroValues,e.$eval(l.rangeColors)),D=a.attrs.safe(l.mainChartColor,"#00bbf0"),_=a.attrs.safe(l.groupedQuery,!1),C=(e.$eval(l.chartLegend),a.attrs.num(l.widgetWidth,null,null,null)),I=a.attrs.num(l.widgetHeight,null,null,null);r(function(){console.log("elem",n),C||(C=n[0].offsetWidth),I||(I=n[0].offsetHeight,I<1&&(I=300)),b=d3.select("#"+e.widgetId+" svg").attr("width",C).attr("height",I),w=b.append("g"),x=w.append("g").classed("map-layer",!0),Y()});var M=e.$eval(l.groupByColumn);null==M&&e.debugMessages.push("Invalid group by column");var L=e.$eval(l.valueColumn),T=a.attrs.safe(l.borderColor,"#fff"),$=a.attrs.safe(l.noDataColor,"#eee");e.controlMapMapId="controlMap"+(new Date).getTime();var E=e.$eval(l.geojsons);E&&E.length&&0!=E.lenght||(E=[{}]);for(var S=a.attrs.safe(l.geoprojection,"mercator"),V=0;V<E.length;V++){var w=E[V];w.url||(w.url="lib/yucca-angular-widgets/dist/data/piemonte_province_geojson.json"),w.key||(w.key="code"),w.render||(w.render={}),w.render.line||(w.render.line={}),w.render.line.weight||(w.render.line.weight=1),w.render.line.opacity||(w.render.line.opacity=1),w.render.line.dashcolor||(w.render.line.dashcolor="#0e232e"),w.render.line.dasharray||(w.render.line.dasharray=1),w.render.areas||(w.render.areas={}),w.render.areas.fillopacity||(w.render.areas.fillopacity=.7)}e.geojson=null;e.isLoading=!0;var A=0,N=a.event.readWidgetEventAttr(l);console.log("eventConfig",N);var F={};e.$on("yucca-widget-event",function(t,n){console.log("yucca-widget-event",n),void 0==typeof n||null==n||n.sourceId==e.widgetId||a.event.ignoreEvent(n,N)||("dataset.change.value_column"==n.eventtype?(L.key=n.data.key,L.label=n.data.label,_?loadDataGrouped():j()):"dataset.filter.text"==n.eventtype&&(F[n.sourceId]=n.data,p=a.event.updateTextFilter(l.Filter,F,z),_?loadDataGrouped():Y()))});e.geojson=null;e.tableData=[],e.isLoading=!0;var W=function(){d3.json(E[A].url,function(t,n){for(var r in n.features)n.features[r].properties.selected=!1;var l=a.geo.fitGeojson(n,C,I,S),l=a.geo.fitGeojson(n,C,I,S);if(P[0].values.length>0){console.log("data[0]",P[0]);for(var o=0;o<P[0].values.length;o++){var d=P[0].values[o];console.debug("d",d);for(var r=0;r<n.features.length;r++)d.key.toUpperCase()==n.features[r].properties[E[A].key].toUpperCase()&&(n.features[r].properties.label=P[0].label,n.features[r].properties.value=d.value)}}x.selectAll("path").data(n.features).enter().append("path").attr("d",l).attr("vector-effect","non-scaling-stroke").style("fill",s).style("stroke",T).on("mouseover",B).on("mouseout",O).on("click",i),e.isLoading=!1})},H=function(e){var t=$;if(e.properties.value){t=u[0].color(e.properties.value);for(var a=0;a<u.length-1;a++)e.properties.value>=u[a].max&&e.properties.value<u[a+1].max&&(t=u[a].color(e.properties.value));e.properties.value>=u[u.length-1].max&&(t=u[u.length-1].color(e.properties.value))}return t};e.info={show:!0},e.updateInfo=function(t,a){r(function(){e.info.show=t,e.info.content=a},100)};var B=function(t){var n=a.d3color.darker(H(t),.3);d3.select(this).style("fill",n),e.updateInfo(!0,t.properties.name+(t.properties.label?" - "+t.properties.label:"")+(t.properties.value?": "+a.render.safeNumber(t.properties.value,m,e.isEuroValue(),y):": no data"));var r=a.event.createEvent(e.widgetId,d,"dataset.highlight.group_by_column",{key:t.properties[E[A].key],color:n},c);o.$broadcast("yucca-widget-event",r)},O=function(t){x.selectAll("path").style("fill",function(e){return H(e)}),e.updateInfo(!1,"");var n=a.event.createEvent(e.widgetId,d,"dataset.de_highlight.group_by_column",{key:t.properties[E[A].key]},c);o.$broadcast("yucca-widget-event",n)};e.filter={};var P,R=null,U=null,z={},Y=function(){console.log("map - loadData",f),e.isLoading=!0,U=null,t.getDataEntities(f,g,p,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var o in r)r.hasOwnProperty(o)&&"__metadata"!=o&&(z[o]=typeof r[o]);console.log("columnDataTypeMap ",z)}t.getMultipleDataEnties(l.datasetcode,g,p,v,n).then(function(e){console.info("discretebarchart:loadData",e),U=e,j()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},j=function(){if(console.log("prepareData",U),null!=U){e.isLoading=!0;for(var t=new Array,n=0;n<U.length;n++)t=t.concat(U[n].data.d.results);if(P=a.data.aggregationSeriesKeyValue(t,[L],M.key,null,l.mainChartColor),console.log("discrete mapData",P),k)for(var r=d3.min(P[0].values,function(e){return e.value}),o=0;o<k.length;o++){var s={max:k[o].limit,color:d3.scale.linear().domain([r,k[o].limit]).clamp(!0).range(a.d3color.getRange(k[o].color))};r=k[o].limit,u.push(s)}else{var i=d3.max(P[0].values,function(e){return e.value});u.push({max:i,color:d3.scale.linear().domain([d3.min(P[0].values,function(e){return e.value}),i]).clamp(!0).range(a.d3color.getRange(D))})}W(),console.log("colors",u),e.isLoading=!1}e.isLoading=!1};console.log("attrs",l),e.MAP_PIEDMONT_CENTER={lat:45.3522366,lng:7.515388499999972,zoom:7}}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_choropleth_map_chart.html",'<div class="yucca-widget  yucca-control-map-chart" id="{{widgetId}}" >\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-discretebar-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <svg ng-show="!isLoading"></svg>\n           <div class="info-panel" ng-show="info.show"><span>{{info.content}}</span></div>          </section>\n        <section class="yucca-widget-debug" ng-show="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetCollapsibletreeChart",["metadataService","dataService","$yuccaHelpers","$timeout","$compile","$rootScope",function(e,t,a,n,r,l){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_collapsibletree_chart.html",link:function(e,n,r){console.log("elem",n);var o="YuccaBasicDatasetCollapsibletreeChart";e.widgetId=a.attrs.safe(r.widgetId,o+(new Date).getTime());var s=a.attrs.safe(r.eventControlId,"EventControl");e.widgetTitle=a.attrs.safe(r.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(r.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(r.widgetIntro,null),e.debug="true"===r.debug,e.debugMessages=[];var i=r.usertoken,d=r.filter,c=r.orderby,u=(a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1),a.attrs.safe(r.datasetcode,null));null==u&&e.debugMessages.push("Invalid dataset code");var g=a.attrs.safe(r.euroValue,!1),p=a.attrs.safe(r.decimalValue,2),v=a.attrs.safe(r.formatBigNumber,!1);e.isEuroValue=function(){return"true"==g};e.$eval(r.chartColors),a.attrs.safe(r.mainChartColor,"#00bbf0");e.chartWidth=a.attrs.num(r.widgetWidth,100,null,n[0].offsetParent.clientWidth),e.chartHeight=a.attrs.num(r.widgetHeight,300,null,n[0].offsetParent.clientHeight);var f=a.attrs.safe(r.rootLabel,"");e.rowDepth=a.attrs.safe(r.rowDepth,160);var h=e.$eval(r.treeColumns),m=e.$eval(r.valueColumn);e.valueNotColored=a.attrs.safe(r.valueNotColored,!1),e.hideValues=a.attrs.safe(r.hideValues,!1),e.rowHeight=a.attrs.safe(r.rowHeight,32),e.radius=r.radius,e.startClosed=a.attrs.safe(r.startClosed,!1),e.nodeOffsetX=a.attrs.safe(r.nodeOffsetX,0);var y=a.event.readWidgetEventAttr(r);console.log("eventConfig",y);var b={};e.$on("yucca-collapsibletree-event",function(t,n){if(console.log("yucca-collapsibletree-event fuori",n),n.sourceId==e.widgetId){n.data.datasetcode=u;var n=a.event.createEvent(e.widgetId,o,n.eventtype,n.data);n.eventControlId=s,console.log("event",n),l.$broadcast("yucca-widget-event",n)}}),e.$on("yucca-widget-event",function(t,n){if(console.log("yucca-widget-event",n),void 0!=typeof n&&null!=n&&n.sourceId!=e.widgetId&&void 0!=typeof n&&null!=n&&n.sourceId!=e.widgetId&&!a.event.ignoreEvent(n,y))if("dataset.change.value_column"==n.eventtype)m=n.data,D();else if("dataset.filter.text"==n.eventtype)b[n.sourceId]=n.data,d=a.event.updateTextFilter(r.Filter,b,x),k();else if("dataset.filter.odata"==n.eventtype)d="",n.data.filter&&""!=n.data.filter?(r.filter&&!n.data.override&&(d="("+r.filter+") and "),d+="("+n.data.filter+")"):d=r.filter,k();else if(n.data.datasetcode==u&&"dataset.browse"==n.eventtype){var o=n.data.path;l.$broadcast("yucca-widget-event-"+e.widgetId,{type:"browse",path:o,eventControlId:s})}});var w=null,x={},k=function(){e.isLoading=!0,w=null,t.getDataEntities(r.datasetcode,i,d,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var l=a.data.d.results[0];for(var o in l)l.hasOwnProperty(o)&&"__metadata"!=o&&(x[o]=typeof l[o]);console.log("columnDataTypeMap ",x)}t.getMultipleDataEnties(r.datasetcode,i,d,c,n).then(function(e){console.info("collapsibletreechart:loadData",e),w=e,D()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},D=function(){console.log("prepareData",w);if(e.isLoading=!0,null!=w){for(var t=new Array,n=0;n<w.length;n++)t=t.concat(w[n].data.d.results);var l={decimalValue:p,isEuro:e.isEuroValue(),formatBigNumber:v};e.collapsibletreeData=a.data.aggregationTree(f,t,h,m,null,l),console.log("tree fuori",e.collapsibletreeData);for(var o=a.render.safeColors(e.collapsibletreeData.children.length,e.$eval(r.chartColors),r.mainChartColor),n=0;n<e.collapsibletreeData.children.length;n++)_(e.collapsibletreeData.children[n],o[n]);console.log("chartData",e.collapsibletreeData)}e.isLoading=!1},_=function(e,t){if(e.color=t,e.children&&e.children.length>0)for(var a=0;a<e.children.length;a++)_(e.children[a],t);
};k(),console.log("attrs",r)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_collapsibletree_chart.html",'<div class="yucca-widget yucca-dataset-collapsibletree-chart" id="{{widgetId}}">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-collapsibletree-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-collapsibletree-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-dataset-collapsibletree-chart-chart" >\n        \t\t<div ><collapsible-tree data="collapsibletreeData" columns="treeColumns" selected="{{treeSelected}}" hide_values = {{hideValues}} value_not_colored={{valueNotColored}} width="{{chartWidth}}"                   height="{{chartHeight}}" widget_id="{{widgetId}}" row_height="{{rowHeight}}" row_depth="{{rowDepth}}" radius="{{radius}}" \t\t\t\t   start_closed="{{startClosed}}" node_offset_x="{{nodeOffsetX}}" ></collapsible-tree></div>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetCollapsibletreeboxesChart",["metadataService","dataService","$yuccaHelpers","$timeout","$compile","$rootScope",function(e,t,a,n,r,l){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_collapsibletreeboxes_chart.html",link:function(e,n,r){console.log("elem",n);var o="YuccaBasicDatasetCollapsibletreeChart";e.widgetId=a.attrs.safe(r.widgetId,o+(new Date).getTime());var s=a.attrs.safe(r.eventControlId,"EventControl");e.widgetTitle=a.attrs.safe(r.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(r.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(r.widgetIntro,null),e.debug="true"===r.debug,e.debugMessages=[];var i=r.usertoken,d=r.filter,c=r.orderby,u=(a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1),a.attrs.safe(r.datasetcode,null));null==u&&e.debugMessages.push("Invalid dataset code");var g=a.attrs.safe(r.euroValue,!1),p=a.attrs.safe(r.decimalValue,2),v=a.attrs.safe(r.formatBigNumber,!1);e.isEuroValue=function(){return"true"==g};e.$eval(r.chartColors),a.attrs.safe(r.mainChartColor,"#00bbf0");e.chartWidth=a.attrs.num(r.widgetWidth,100,null,n[0].offsetParent.clientWidth),e.chartHeight=a.attrs.num(r.widgetHeight,300,null,n[0].offsetParent.clientHeight);var f=a.attrs.safe(r.rootLabel,"");e.rowDepth=a.attrs.safe(r.rowDepth,120),e.boxShadow=a.attrs.safe(r.boxShadow,!1),e.hideValues=a.attrs.safe(r.hideValues,!1),e.boxRadius=a.attrs.safe(r.boxRadius,6);var h=e.$eval(r.treeColumns),m=e.$eval(r.valueColumn);e.hideValues=a.attrs.safe(r.hideValues,!1);var y=a.event.readWidgetEventAttr(r);console.log("eventConfig",y);var b={};e.$on("yucca-collapsibletree-event",function(t,n){if(console.log("yucca-collapsibletree-event fuori",n),n.sourceId==e.widgetId){n.data.datasetcode=u;var n=a.event.createEvent(e.widgetId,o,n.eventtype,n.data);n.eventControlId=s,console.log("event",n),l.$broadcast("yucca-widget-event",n)}}),e.$on("yucca-widget-event",function(t,n){if(console.log("yucca-widget-event",n),void 0!=typeof n&&null!=n&&n.sourceId!=e.widgetId&&void 0!=typeof n&&null!=n&&n.sourceId!=e.widgetId&&!a.event.ignoreEvent(n,y))if("dataset.change.value_column"==n.eventtype)m=n.data,D();else if("dataset.filter.text"==n.eventtype)b[n.sourceId]=n.data,d=a.event.updateTextFilter(r.Filter,b,x),k();else if("dataset.filter.odata"==n.eventtype)d="",n.data.filter&&""!=n.data.filter?(r.filter&&!n.data.override&&(d="("+r.filter+") and "),d+="("+n.data.filter+")"):d=r.filter,k();else if(n.data.datasetcode==u&&"dataset.browse"==n.eventtype){var o=n.data.path;l.$broadcast("yucca-widget-event-"+e.widgetId,{type:"browse",path:o,eventControlId:s})}});var w=null,x={},k=function(){e.isLoading=!0,w=null,t.getDataEntities(r.datasetcode,i,d,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var l=a.data.d.results[0];for(var o in l)l.hasOwnProperty(o)&&"__metadata"!=o&&(x[o]=typeof l[o]);console.log("columnDataTypeMap ",x)}t.getMultipleDataEnties(r.datasetcode,i,d,c,n).then(function(e){console.info("collapsibletreechart:loadData",e),w=e,D()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},D=function(){console.log("prepareData",w);if(e.isLoading=!0,null!=w){for(var t=new Array,n=0;n<w.length;n++)t=t.concat(w[n].data.d.results);var l={decimalValue:p,isEuro:e.isEuroValue(),formatBigNumber:v};e.collapsibletreeData=a.data.aggregationTree(f,t,h,m,null,l),console.log("tree fuori",e.collapsibletreeData);for(var o=a.render.safeColors(e.collapsibletreeData.children.length,e.$eval(r.chartColors),r.mainChartColor),n=0;n<e.collapsibletreeData.children.length;n++)_(e.collapsibletreeData.children[n],o[n]);console.log("chartData",e.collapsibletreeData)}e.isLoading=!1},_=function(e,t){if(e.color=t,e.children&&e.children.length>0)for(var a=0;a<e.children.length;a++)_(e.children[a],t)};k(),console.log("attrs",r)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_collapsibletreeboxes_chart.html",'<div class="yucca-widget yucca-dataset-collapsibletree-chart" id="{{widgetId}}">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-collapsibletree-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-collapsibletree-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-dataset-collapsibletree-chart-chart" >\n        \t\t<div ><collapsible-tree-boxes data="collapsibletreeData" columns="treeColumns" hide_values ="{{hideValues}}" box_radius="{{boxRadius}}"\t\t\t\t\twidth="{{chartWidth}}" height="{{chartHeight}}" widget_id="{{widgetId}}" row_depth="{{rowDepth}}" box_shadow="boxShadow"></collapsible-tree-boxes></div>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetDataexplorerTable",["metadataService","dataService","$yuccaHelpers","$timeout","$compile",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_dataexplorer_chart.html",link:function(r,l,o){console.log("elem",l);var s="YuccaBasicDatasetDataExplorerdataexplorerChart";r.widgetId=a.attrs.safe(o.widgetId,s+(new Date).getTime()),r.widgetTitle=a.attrs.safe(o.widgetTitle,null),r.widgetSubtitle=a.attrs.safe(o.widgetSubtitle,null),r.widgetIntro=a.attrs.safe(o.widgetIntro,null),r.debug="true"===o.debug,r.debugMessages=[];var i=o.usertoken,d=o.filter,c=o.orderby,u=(a.attrs.num(o.top,1,1e3,1e3),a.attrs.num(o.skip,null,null,1),a.attrs.safe(o.tenantcode,null)),g=a.attrs.safe(o.datasetcode,null);null==g&&r.debugMessages.push("Invalid dataset code");var p=o.maxRow,v=o.dataexplorerColumns?r.$eval(o.dataexplorerColumns):null,f={datasetVersion:{skip:{table:!0,detail:!0}},idDataset:{skip:{table:!0,detail:!0}},internalId:{skip:{table:!0,detail:!0}},__metadata:{skip:{table:!0,detail:!0}}},h="true"===o.showDetail,m=a.attrs.safe(o.hellip,null);r.tableData=[];var y=null;r.totalResult=0;var b=function(){r.tableData=[],r.isLoading=!0,t.getDataEntities(o.datasetcode,i,d,0,1,null).then(function(e){console.log("loadData",e);var a=e.data.d.__count>1e4?1e4:e.data.d.__count;t.getMultipleDataEnties(o.datasetcode,i,d,c,a).then(function(e){r.isLoading=!1,console.info("dataexplorer:loadData",e),y=e,D()},function(e){r.isLoading=!1,console.error("Load data error",e),r.debugMessages.push("Load data error "+e)})},function(e){r.isLoading=!1,console.error("Load data error",e),r.debugMessages.push("Load data error "+e)})};if(null!=v){for(var w=0;w<v.length;w++)!v[w].skip||v[w].skip.table||v[w].skip.detail?v[w].skip||(v[w].skip={table:!1,detail:!1}):v[w].skip={table:!0,detail:!0},f[v[w].name]=v[w];b()}else e.getDatasetMetadata(u,g,i).then(function(e){if(console.log("metadata",e),e&&e.data&&e.data.dataset){for(var t=0;t<e.data.dataset.columns.length;t++)f[e.data.dataset.columns[t].name]={name:e.data.dataset.columns[t].name,label:e.data.dataset.columns[t].alias,datatype:e.data.dataset.columns[t].datatype,skip:{table:!1,detail:!1}};console.log("columnMap",f)}b()},function(e){console.log("error",e),b()});o.filteredColumns?r.$eval(o.filteredColumns):null;r.pagination={current:1},r.pagination.pagesize=a.attrs.safe(o.pageSize,10);var x=a.event.readWidgetEventAttr(o);console.log("eventConfig",x),r.$on("yucca-widget-event",function(e,t){console.log("yucca-widget-event",t),n(function(){if(!(void 0==typeof t||null==t||t.sourceId==r.widgetId||a.event.ignoreEvent(t,x)||t.data.datasetcode&&t.data.datasetcode!=g))if("dataset.filter.text"==t.eventtype)filterMap[t.sourceId]=t.data,d=a.event.updateTextFilter(o.Filter,filterMap,columnDataTypeMap),b();else if("dataset.filter.odata"==t.eventtype)d="",t.data.filter&&""!=t.data.filter?(o.filter&&!t.data.override&&(d="("+o.filter+") and "),d+="("+t.data.filter+")"):d=o.filter,b();else if("dataset.highlight.group_by_column"==t.eventtype){if(r.tableData&&t.data.groupByColumn&&t.data.groupByColumn.key){for(var e=-1,n=0;n<r.tableHeader.length;n++)if(t.data.groupByColumn.key==r.tableHeader[n].key){e=n;break}if(e>=0)for(var n=0;n<r.tableData.data.length;n++)r.tableData.data[n].cols[e]==t.data.key&&(r.tableData.data[n].highlight="color: "+t.data.color+"; font-weight: bold; background-color: "+a.render.hex2RgbaColor(t.data.color,10))}}else if("dataset.de_highlight.group_by_column"==t.eventtype&&r.tableData&&t.data.groupByColumn&&t.data.groupByColumn.key){for(var e=-1,n=0;n<r.tableHeader.length;n++)if(t.data.groupByColumn.key==r.tableHeader[n].key){e=n;break}if(e>=0)for(var n=0;n<r.tableData.data.length;n++)r.tableData.data[n].cols[e]==t.data.key&&(r.tableData.data[n].highlight=null)}})}),r.numberOfPages=function(){if(r.tableData&&r.tableData.data)return Math.ceil(r.tableData.data.length/r.pagination.pagesize)};var k=function(e){return!(!e||!e.table&&!e.detail)&&!!(e.table&&e.detail||!e.table&&!e.detail)},D=function(){if(console.log("prepareTable - header",y),null!=y){r.isLoading=!0;for(var e=new Array,t=0;t<y.length;t++)e=e.concat(y[t].data.d.results);var n=new Array;r.tableHeader=new Array,r.totalResult=y[0].data.d.results.length,console.log("odataResult",y);for(var l=0;l<e.length;l++){var o={highlight:null,cols:{}};for(var s in e[l])if(e[l].hasOwnProperty(s)){var i=f[s];k(i.skip)||(0!=l||i.skip&&i.skip.table||r.tableHeader.push({key:s,label:i.label}),o.cols[s]={label:i.label,table:!i.skip.table,detail:!i.skip.detail},"dateTime"==i.datatype?o.cols[s].val=a.render.safeDate(e[l][s],i.dateOptions):"string"==i.datatype?(o.cols[s].val=e[l][s],i.hellip?o.cols[s].hellip=i.hellip:m&&(o.cols[s].hellip=m)):o.cols[s].val=a.render.safeNumber(e[l][s],i.decimalValue,i.euroValue,i.formatBigNumber))}if(n.push(o),null!=p&&l>p)break}}r.isLoading=!1,console.log("tableHeader",r.tableHeader),console.log("filteredData",n),r.tableData={data:n},console.log("dataexplorer tableData",r.tableData)};console.log("attrs",o);var _={reverse:!0};r.sortTable=function(e){_.predicate=e,_.reverse=!_.reverse,r.tableData.data=r.tableData.data.sort(C)};var C=function(e,t){var a=0;return a=_.reverse?e.cols[_.predicate].val>t.cols[_.predicate].val?-1:1:e.cols[_.predicate].val<t.cols[_.predicate].val?-1:1};r.detail=null,r.showDetail=function(e){h&&(r.detail=e)},r.hideDetail=function(){r.detail=null}}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_dataexplorer_chart.html",'<div class="yucca-widget yucca-dataset-dataexplorer" id="{{widgetId}}">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-table-content">\n        <section>\n         <div ng-if="isLoading" class="yucca-dataset-dataexplorer-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n         </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n           <div class="yucca-widget-dataexplorer-table-container">            <div> \t  \t\t  <table id = "Table" ng-if="!isLoading"  class="yucca-widget-table" ng-if="!isLoading">\n                <thead >\n                  <tr>\n                    <th ng-repeat="col in tableHeader track by $index">                      <a href ng-click="sortTable(col.key)">{{col.label}}                      </a></th>\n                  </tr>\n               </thead>\n               <tbody>\n                  <tr ng-repeat="row in tableData.data | startFrom:(pagination.current-1)*pagination.pagesize | limitTo:pagination.pagesize" class="yucca-dataset-dataexplorer-table-row" style="{{row.highlight}}">\n                     <td ng-repeat="col in row.cols track by $index" ng-click="showDetail(row.cols)" ng-if="col.table">                       <span ng-if="!col.hellip">{{col.val}}</span>                       <span ng-if="col.hellip" title="{{col.val}}" class="nowrap">{{col.val|string_ellipse:hellip}}</span> \t\t\t\t\t  </td>\n                  </tr>\n               </tbody>\n            </table>\n   \t     <div class="yucca-widget-dataexplorer-pagination" ng-if="!isLoading" >\n               <div class="yucca-widget-dataexplorer-pagination-total">Total <strong>{{tableData.data.length}}</strong></div>                <a href ng-if="pagination.current>1" ng-click="pagination.current=pagination.current-1" title="Previous" class="yucca-widget-dataexplorer-pagination-prev">&lt;</a>                   {{pagination.current}}/{{numberOfPages()}}\n\t\t\t     <a href ng-if="pagination.current < tableData.data.length/pagination.pagesize - 1" ng-click="pagination.current=pagination.current+1" title="Next"  class="yucca-widget-dataexplorer-pagination-prev">&gt;</a>   \t      </div>\n   \t    </div>\n           <div class="yucca-widget-table-detail-panel" ng-if="detail"><a class="yucca-widget-table-close" href ng-click="hideDetail()">&times</a>         \t  <div ng-repeat="(key, val) in detail track by $index" ng-if="val.detail" class="yucca-widget-table-detail-panel-row">                 <label>{{val.label}}</label><span>{{val.val}}</span>             </div>            </div>          </div>        </section>\n   \t <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n   \t </section>\n    </div>\n<div>\n</div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetDiscretebarChart",["metadataService","dataService","$yuccaHelpers","$rootScope","$timeout",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_discretebar_chart.html",link:function(e,l,o){console.debug("elem",l);var s="YuccaBasicDatasetDiscretebarChart";e.widgetId=a.attrs.safe(o.widgetId,s+(new Date).getTime());var i=a.attrs.safe(o.eventControlId,"EventControl-"+e.widgetId);e.widgetTitle=a.attrs.safe(o.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(o.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(o.widgetIntro,null),e.debug="true"===o.debug,e.debugMessages=[];var d=o.usertoken,c=o.filter,u=o.orderby,g=(a.attrs.num(o.top,1,1e3,1e3),a.attrs.num(o.top,null,null,1),a.attrs.safe(o.datasetcode,null));null==g&&e.debugMessages.push("Invalid dataset code");var p=a.attrs.safe(o.euroValue,!1),v=a.attrs.safe(o.decimalValue,2),f=a.attrs.safe(o.formatBigNumber,!1);e.isEuroValue=function(){return"true"==p};var h=("true"===o.skipZeroValues,e.$eval(o.chartColors)),m=(a.attrs.safe(o.mainChartColor,"#00bbf0"),a.attrs.safe(o.groupedQuery,!1));e.chartWidth=a.attrs.num(o.widgetWidth,null,null,null),e.chartHeight=a.attrs.num(o.widgetHeight,null,null,null),r(function(){var t=angular.element(document.querySelector("#"+e.widgetId+" .yucca-widget-chart-content"));e.options.chart.height=t[0].offsetHeight});var y=e.$eval(o.groupByColumn);null==y&&e.debugMessages.push("Invalid group by column");var b=e.$eval(o.valueColumn),w=e.$eval(o.axis);"undefined"==typeof w&&(w={hide:!1,label:""});var x=e.$eval(o.yAxis);"undefined"==typeof x&&(x={hide:!1,label:""}),e.options={chart:{type:"discreteBarChart",duration:500,x:function(e){return e.label},y:function(e){return e.value},valueFormat:function(t){return a.render.safeNumber(t,v,e.isEuroValue(),f)},showValues:"false"!==o.showValues,reduceXTicks:"true"==o.reduceXTicks,discretebar:{dispatch:{elementMouseout:function(t){var r=t.data;r.groupByColumn=y,r.valueColumn=b;var l=a.event.createEvent(e.widgetId,s,"dataset.de_highlight.group_by_column",r);l.eventControlId=i,n.$broadcast("yucca-widget-event",l)},elementMouseover:function(t){var r=t.data;r.groupByColumn=y,r.valueColumn=b;var l=a.event.createEvent(e.widgetId,s,"dataset.highlight.group_by_column",r);l.eventControlId=i,n.$broadcast("yucca-widget-event",l)}}}}},x.hide?e.options.chart.showYAxis=!1:(e.options.chart.showYAxis=!0,e.options.chart.yAxis={tickFormat:function(t){return a.render.safeNumber(t,v,e.isEuroValue(),f)},rotateLabels:x.rotateLabels?x.rotateLabels:0,axisLabel:x.label?x.label:""}),w.hide?e.options.chart.showXAxis=!1:(e.options.chart.showXAxis=!0,e.options.chart.reduceXTicks="true"==o.reduceXTicks,e.options.chart.xAxis={axisLabel:w.label?w.label:"",rotateLabels:w.rotateLabels?w.rotateLabels:0}),console.log("yAxisAttr",x),console.log("scope.options",e.options);var k=e.$eval(o.chartLegend);if(k&&k.show){var D={margin:k.position};e.options.chart.legend=D,e.options.chart.showLegend=!0}else e.options.chart.showLegend=!1;e.chartData=new Array;var _=a.event.readWidgetEventAttr(o);console.log("eventConfig",_);var C={};e.$on("yucca-widget-event",function(t,n){console.log("yucca-widget-event",n),void 0==typeof n||null==n||n.sourceId==e.widgetId||a.event.ignoreEvent(n,_)||("dataset.change.group_by_column"==n.eventtype?(y=n.data,m?$():T()):"dataset.change.value_column"==n.eventtype?(b.key=n.data.key,b.label=n.data.label,m?$():T()):"dataset.filter.text"==n.eventtype?(C[n.sourceId]=n.data,c=a.event.updateTextFilter(o.filter,C,M),m?$():L()):"dataset.filter.odata"==n.eventtype&&(c="",n.data.filter&&""!=n.data.filter?(o.filter&&!n.data.override&&(c="("+o.filter+") and "),c+="("+n.data.filter+")"):c=o.filter,m?$():L()))});var I=null,M={},L=function(){e.isLoading=!0,I=null,t.getDataEntities(o.datasetcode,d,c,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var l in r)r.hasOwnProperty(l)&&"__metadata"!=l&&(M[l]=typeof r[l]);console.log("columnDataTypeMap ",M)}t.getMultipleDataEnties(o.datasetcode,d,c,u,n).then(function(e){console.info("discretebarchart:loadData",e),I=e,T()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},T=function(){if(console.log("prepareData",I),null!=I){e.isLoading=!0;for(var t=new Array,n=0;n<I.length;n++)t=t.concat(I[n].data.d.results);e.chartData=a.data.aggregationSeriesKeyValue(t,[b],y.key,h,o.mainChartColor),console.log("discrete chartData",e.chartData)}e.isLoading=!1};e.downloadData=function(){if(e.chartData){console.log("downloadData",e.chartData);var t=a.csv.prepareSeriesKeyValue(y.label,e.chartData);a.csv.downloadCSV(t,"data.csv")}};var $=function(){e.isLoading=!0,I=null;var n=y.key,r=b.countingMode+","+b.key;t.getDataEntitiesStats(o.datasetcode,d,n,r,c,0,1e3,null).then(function(t){if(console.log("loadDataGrouped",t),null!=t){e.isLoading=!0;var n={key:b.key+"_sts",label:b.label,countingMode:b.countingMode};e.chartData=a.data.aggregationSeriesKeyValue(t.data.d.results,[n],y.key,h,o.mainChartColor),console.log("discrete chartData",e.chartData),e.isLoading=!1}},function(t){e.isLoading=!1,console.error("loadDataGrouped error",t),e.debugMessages.push("Load data error "+t)})};m?$():L(),console.log("attrs",o)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_discretebar_chart.html",'<div class="yucca-widget yucca-dataset-discretebar-chart" id="{{widgetId}}" style="height: {{chartHeight}}px;width: {{chartWidth}}px;">\n    <div class="yucca-widget-download-csv" ng-if="!isLoading"><a href ng-click="downloadData()">Data</a></div>\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-discretebar-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-widget-chart" >\n\t\t\t\t<div><nvd3 options="options" data="chartData" ></nvd3></div>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetDrilldowndataexplorerChart",["metadataService","dataService","$yuccaHelpers","$timeout","$compile","$rootScope",function(e,t,a,n,r,l){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_drilldowndataexplorer_chart.html",link:function(e,n,r){console.log("elem",n);var o="YuccaBasicDatasetDrilldowndataexplorerChart";e.widgetId=a.attrs.safe(r.widgetId,o+(new Date).getTime());var s=a.attrs.safe(r.eventControlId,"EventControl");e.widgetTitle=a.attrs.safe(r.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(r.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(r.widgetIntro,null),e.debug="true"===r.debug,e.debugMessages=[];var i=r.usertoken,d=r.filter,c=r.orderby,u=(a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1),a.attrs.safe(r.datasetcode,null));null==u&&e.debugMessages.push("Invalid dataset code");var g=a.attrs.safe(r.euroValue,!1);a.attrs.safe(r.decimalValue,2),a.attrs.safe(r.formatBigNumber,!1);e.isEuroValue=function(){return"true"==g};var p=("true"===r.skipZeroValues,a.attrs.safe(r.countingMode,"count"));"false"!==r.showLegend,e.$eval(r.chartColors),a.attrs.safe(r.mainChartColor,"#00bbf0");e.chartWidth=a.attrs.num(r.widgetWidth,100,null,n[0].offsetParent.clientWidth-24),e.chartHeight=a.attrs.num(r.widgetHeight,300,null,n[0].offsetParent.clientHeight);var v=a.attrs.safe(r.rootLabel,"");e.treeColumns=e.$eval(r.treeColumns),"Array"!=typeof e.treeColumns&&e.debugMessages.push("Invalid tree columns");var f=e.$eval(r.valueColumns);e.valueColumns=f;var h=a.attrs.safe(r.valueColumn,null);null==h&&"sum"==p&&e.debugMessages.push("To sum value you must enter a valid valueColum");var m={};e.$on("yucca-drilldowndataexplorer-event",function(t,n){if(console.log("yucca-drilldowndataexplorer-event fuori",n),n.sourceId==e.widgetId){n.data.datasetcode=u;var n=a.event.createEvent(e.widgetId,o,n.eventtype,n.data);n.eventControlId=s,console.log("event",n),l.$broadcast("yucca-widget-event",n)}}),e.$on("yucca-widget-event",function(t,n){if(console.log("treeee yucca-widget-event",n),void 0!=typeof n&&null!=n&&n.sourceId!=e.widgetId&&(!n.data.datasetcode||n.data.datasetcode==u))if("dataset.change.value_column"==n.eventtype)h=n.data.value,x();else if("dataset.filter.text"==n.eventtype)m[n.sourceId]=n.data,d=a.event.updateTextFilter(r.Filter,m,b),w();else if("dataset.filter.odata"==n.eventtype)d="",n.data.filter&&""!=n.data.filter?(r.filter&&!n.data.override&&(d="("+r.filter+") and "),d+="("+n.data.filter+")"):d=r.filter,w();else if(n.data.datasetcode==u&&"dataset.browse"==n.eventtype){e.path=n.data.path;var o=n.data.path;l.$broadcast("yucca-widget-event-"+e.widgetId,{type:"browse",path:o,eventControlId:s})}}),e.path=[v];var y=null,b={},w=function(){e.isLoading=!0,y=null,t.getDataEntities(r.datasetcode,i,d,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var l=a.data.d.results[0];for(var o in l)l.hasOwnProperty(o)&&"__metadata"!=o&&(b[o]=typeof l[o]);console.log("columnDataTypeMap ",b)}t.getMultipleDataEnties(r.datasetcode,i,d,c,n).then(function(e){console.info("drilldowndataexplorerchart:loadData",e),y=e,x()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},x=function(){console.log("prepareData",y);if(e.isLoading=!0,null!=y){for(var t=new Array,n=0;n<y.length;n++)t=t.concat(y[n].data.d.results);e.drilldowndataexplorerData=a.data.aggregationTreeDrill(v,t,e.treeColumns,f),e.drilldowndataexplorerData=a.data.recursiveTree(e.drilldowndataexplorerData,e.treeColumns,f,e.treeColumns.length);for(var l=new Array,n=0;n<e.drilldowndataexplorerData.children.length;n++)l.push(e.drilldowndataexplorerData.children[n]);e.tableData=l,console.log("tree fuori",e.drilldowndataexplorerData);for(var o=a.render.safeColors(e.drilldowndataexplorerData.children.length,e.$eval(r.chartColors),r.mainChartColor),n=0;n<e.drilldowndataexplorerData.children.length;n++)e.drilldowndataexplorerData.children[n].color=o[n];console.log("chartData",e.drilldowndataexplorerData)}e.isLoading=!1},k=function(){if(e.drilldowndataexplorerData&&null!=e.drilldowndataexplorerData){for(var t=e.drilldowndataexplorerData.children,a=0;a<e.path.length;a++)if(t)for(var n=0;n<t.length;n++)t[n].name==e.path[a]&&t[n].children&&(t=t[n].children);console.log("childrens",t),console.log("childrens",t)}e.tableData=new Array;for(var n=0;n<t.length;n++)e.tableData.push(t[n]);console.log("navigable tableData",e.tableData)};e.drillUp=function(){if(e.path.length>1){e.path.pop(),k();var t=a.event.createEvent(e.widgetId,o,"dataset.browse",{path:e.path});t.eventControlId=s,l.$broadcast("yucca-widget-event",t)}},e.drillDown=function(t){e.path.push(t),k();var n=a.event.createEvent(e.widgetId,o,"dataset.browse",{path:e.path});n.eventControlId=s,l.$broadcast("yucca-widget-event",n)},w(),console.log("attrs",r)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_drilldowndataexplorer_chart.html",'<div class="yucca-widget yucca-dataset-drilldowndataexplorer-chart" id="{{widgetId}}">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-drilldowndataexplorer-chart-content">\n        <section>\n         <div ng-if="isLoading" class="yucca-dataset-drilldowndataexplorer-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n         </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n           <div class="yucca-dataset-dataexplorer-breadcrumbs" >              <span class="yucca-dataset-dataexplorer-breadcrumbs-item" ng-repeat="p in path track by $index">                 <span ng-if="!$last">{{p}} {{$last ? "": "&rarr;"}} </span><a ng-click="drillUp()" href ng-if="$last">{{p}}</a>              </span>           </div>\n\t\t\t<table ng-if="!isLoading"  class="yucca-dataset-dataexplorer-table" ng-if="!isLoading">\n             <tbody>\n                   <th ng-repeat="element in treeColumns " class="yucca-dataset-dataexplorer-key-column">{{element}} </th>                   <th ng-repeat="valueElement in valueColumns " class="yucca-dataset-dataexplorer-value-column">{{valueElement.key}} </th>                 <tr ng-repeat="row in tableData " class="yucca-dataset-dataexplorer-table-row" style="{{row.highlight}}">\n                   <td ng-repeat="element in treeColumns " class="yucca-dataset-dataexplorer-key-column"><a href ng-click="drillDown(row.name)" ng-if="row.children">{{row[element].substr(0,20)}} </a><span ng-if="row.children == null">{{row[element].substr(0,20)}} </span></td>                   <td ng-repeat="valueElement in valueColumns " class="yucca-dataset-dataexplorer-value-column"><a href ng-click="drillDown(row.name)" ng-if="row.children">{{row[valueElement.key]}} </a><span ng-if="row.children == null">{{row[valueElement.key]}} </span></td>                 </tr>\n             </tbody>\n         </table>\n        </section>\n   \t <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n   \t </section>\n    </div>\n<div>\n</div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetForcedirectedChart",["metadataService","dataService","$yuccaHelpers","$timeout","$compile","$rootScope",function(e,t,a,n,r,l){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_forcedirected_chart.html",link:function(e,r,l){console.log("elem",r);var o="YuccaBasicDatasetForcedirectedChart";e.widgetId=a.attrs.safe(l.widgetId,o+(new Date).getTime());a.attrs.safe(l.eventControlId,"EventControl");e.widgetTitle=a.attrs.safe(l.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(l.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(l.widgetIntro,null),e.debug="true"===l.debug,e.debugMessages=[];var s=l.usertoken,i=l.filter,d=l.orderby,c=(a.attrs.num(l.top,1,1e3,1e3),a.attrs.num(l.top,null,null,1),a.attrs.safe(l.datasetcode,null));null==c&&e.debugMessages.push("Invalid dataset code");var u=a.attrs.safe(l.euroValue,!1);a.attrs.safe(l.decimalValue,2),a.attrs.safe(l.formatBigNumber,!1);e.isEuroValue=function(){return"true"==u};"true"===l.skipZeroValues,a.attrs.safe(l.countingMode,"count"),"false"!==l.showLegend,e.$eval(l.chartColors),a.attrs.safe(l.mainChartColor,"#00bbf0");e.chartWidth=a.attrs.num(l.widgetWidth,100,null,r[0].offsetParent.clientWidth),e.chartHeight=a.attrs.num(l.widgetHeight,300,null,r[0].offsetParent.clientHeight),n(function(){e.chartWidth=a.attrs.num(l.widgetWidth,100,null,r[0].offsetParent.clientWidth),
e.chartHeight=a.attrs.num(l.widgetHeight,300,null,r[0].offsetParent.clientHeight),console.log("chartWidth",e.chartWidth);var t=angular.element(document.querySelector("#"+e.widgetId+" .yucca-dataset-forcedirected-chart-chart"));console.log("width",t[0].offsetWidth),e.forcedirectedWidth=t[0].offsetWidth,e.forcedirectedHeight=e.chartHeight}),e.nodeTypes=e.$eval(l.nodeTypes),e.linkLine=a.attrs.safe(l.linkLine,null);var g=e.$eval(l.relations),p={},v=a.event.readWidgetEventAttr(l);e.$on("yucca-widget-event",function(t,n){console.log("yucca-widget-event",n),void 0==typeof n||null==n||n.sourceId==e.widgetId||a.event.ignoreEvent(n,v)||n.data.datasetcode&&n.data.datasetcode!=c||("dataset.change.value_column"==n.eventtype?(valueColumn=n.data.value,y()):"dataset.filter.text"==n.eventtype?(p[n.sourceId]=n.data,i=a.event.updateTextFilter(l.Filter,p,h),m()):"dataset.filter.odata"==n.eventtype&&(i="",n.data.filter&&""!=n.data.filter?(l.filter&&!n.data.override&&(i="("+l.filter+") and "),i+="("+n.data.filter+")"):i=l.filter,m()))});var f=null,h={},m=function(){e.isLoading=!0,f=null,t.getDataEntities(l.datasetcode,s,i,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var o in r)r.hasOwnProperty(o)&&"__metadata"!=o&&(h[o]=typeof r[o]);console.log("columnDataTypeMap ",h)}t.getMultipleDataEnties(l.datasetcode,s,i,d,n).then(function(e){console.info("forcedirectedchart:loadData",e),f=e,y()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},y=function(){console.log("prepareData",f);if(e.isLoading=!0,null!=f){for(var t=new Array,n=0;n<f.length;n++)t=t.concat(f[n].data.d.results);var r=a.render.safeColors(g.length,e.$eval(l.chartColors),l.mainChartColor);e.forcedirectedLinks=a.data.aggregationForcedirected(t,g,r),console.log("forcedirected fuori",e.forcedirectedLinks),console.log("chartData",e.forcedirectedLinks)}e.isLoading=!1};m(),console.log("attrs",l)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_forcedirected_chart.html",'<div class="yucca-widget yucca-dataset-forcedirected-chart" id="{{widgetId}}">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-forcedirected-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-forcedirected-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-dataset-forcedirected-chart-chart" >\n        \t    <forcedirected-chart links="forcedirectedLinks" node_types={{nodeTypes}} width="{{chartWidth}}" link_line="{{linkLine}}" height="{{chartHeight}}"  widgetId="{{widgetId}}" />       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetFunnelChart",["metadataService","dataService","$yuccaHelpers","$rootScope","$timeout",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_funnel_chart.html",link:function(e,n,l){console.log("elem",n);var o="YuccaBasicDatasetFunnelChart";e.widgetId=a.attrs.safe(l.widgetId,o+(new Date).getTime()),e.widgetTitle=a.attrs.safe(l.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(l.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(l.widgetIntro,null),e.debug="true"===l.debug,e.debugMessages=[];var s=l.usertoken,i=l.filter,d=l.orderby,c=(a.attrs.num(l.top,1,1e3,1e3),a.attrs.num(l.top,null,null,1),a.attrs.safe(l.datasetcode,null));null==c&&e.debugMessages.push("Invalid dataset code");var u=a.attrs.safe(l.euroValue,!1),g=a.attrs.safe(l.decimalValue,2),p=a.attrs.safe(l.formatBigNumber,!1),v=a.attrs.safe(l.showValues,!1);e.mouth=a.attrs.safe(l.mouth,!1),e.isEuroValue=function(){return"true"==u};var f=e.$eval(l.chartColors),h=a.attrs.safe(l.mainChartColor,"#00bbf0"),m=a.attrs.safe(l.groupedQuery,!1);e.chartWidth=a.attrs.num(l.widgetWidth,null,null,null),e.chartHeight=a.attrs.num(l.widgetHeight,null,null,null),r(function(){e.chartWidth||(e.chartWidth=n[0].offsetWidth),e.chartWidth<1&&(e.chartWidth=300),e.chartHeight||(e.chartHeight=n[0].offsetHeight,e.chartHeight<1&&(e.chartHeight=300))});var y=e.$eval(l.groupByColumn);null==y&&e.debugMessages.push("Invalid group by column");var b=e.$eval(l.valueColumn),w=e.$eval(l.chartLegend);if(w&&w.show){({margin:w.position})}e.chartData=new Array,e.colors=new Array;var x=a.event.readWidgetEventAttr(l);console.log("eventConfig",x);var k={};e.$on("yucca-widget-event",function(t,n){console.log("yucca-widget-event",n),void 0==typeof n||null==n||n.sourceId==e.widgetId||a.event.ignoreEvent(n,x)||("dataset.change.group_by_column"==n.eventtype?(y=n.data,m?M():I()):"dataset.change.value_column"==n.eventtype?(b.key=n.data.key,b.label=n.data.label,m?M():I()):"dataset.filter.text"==n.eventtype?(k[n.sourceId]=n.data,i=a.event.updateTextFilter(l.Filter,k,_),m?M():C()):"dataset.filter.odata"==n.eventtype&&(i="",n.data.filter&&""!=n.data.filter?(l.filter&&!n.data.override&&(i="("+l.filter+") and "),i+="("+n.data.filter+")"):i=l.filter,m?M():C()))});var D=null,_={},C=function(){e.isLoading=!0,D=null,t.getDataEntities(l.datasetcode,s,i,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var o in r)r.hasOwnProperty(o)&&"__metadata"!=o&&(_[o]=typeof r[o]);console.log("columnDataTypeMap ",_)}t.getMultipleDataEnties(l.datasetcode,s,i,d,n).then(function(e){console.info("funnelchart:loadData",e),D=e,I()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},I=function(){if(console.log("prepareData",D),null!=D){e.isLoading=!0;for(var t=new Array,n=0;n<D.length;n++)t=t.concat(D[n].data.d.results);e.chartData=a.data.aggregationKeyValue(t,b,y.key,e.$eval(l.chartColors),l.mainChartColor);for(var n=0;n<e.chartData.length;n++)v&&(e.chartData[n].label=e.chartData[n].label+" - "+a.render.safeNumber(e.chartData[n].value,g,e.isEuroValue(),p));e.chartData=e.chartData.sort(function(e,t){return e.value<t.value?1:e.value>t.value?-1:0}),console.log("funnel chartData",e.chartData),e.colors=a.render.safeColors(e.chartData.length,f,h,.3),console.log("funnel colors ",e.colors)}e.isLoading=!1};e.downloadData=function(){if(e.chartData){console.log("downloadData",e.chartData);var t=a.csv.prepareKeyValue(y.label,b.label,e.chartData);a.csv.downloadCSV(t,"data.csv")}};var M=function(){e.isLoading=!0,D=null;var n=y.key,r=b.countingMode+","+b.key;t.getDataEntitiesStats(l.datasetcode,s,n,r,i,0,1e3,null).then(function(t){if(console.log("loadDataGrouped",t),null!=t){e.isLoading=!0;var n={key:b.key+"_sts",label:b.label,countingMode:b.countingMode};e.chartData=a.data.aggregationSeriesKeyValue(t.data.d.results,[n],y.key,f,l.mainChartColor),console.log("funnel chartData",e.chartData);for(var r=0;r<e.chartData.length;r++)v&&(e.chartData[r].label=e.chartData[r].label+" "+a.render.safeNumber(e.chartData[r].value,g,e.isEuroValue(),p));e.colors=a.render.safeColors(e.chartData.length,f,h,.3),console.log("funnel colors ",e.colors),e.isLoading=!1}},function(t){e.isLoading=!1,console.error("loadDataGrouped error",t),e.debugMessages.push("Load data error "+t)})};m?M():C(),console.log("scope.colors",e.colors),console.log("attrs",l)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_funnel_chart.html",'<div class="yucca-widget yucca-dataset-funnel-chart" id="{{widgetId}}" style="height: {{chartHeight}}px;width: {{chartWidth}}px;">\n    <div class="yucca-widget-download-csv" ng-if="!isLoading"><a href ng-click="downloadData()">Data</a></div>\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-funnel-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-widget-chart" >\n\t\t\t\t<div><funnel-chart data="chartData" colors="colors" mouth="mouth" width="{{chartWidth}}" height="{{chartHeight}}"></funnel-chart></div>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetHorizontalmultibarChart",["metadataService","dataService","$yuccaHelpers","$rootScope","$timeout",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_horizontalmultibar_chart.html",link:function(e,l,o){console.debug("elem",l);var s="YuccaBasicDatasetHorizontalmultibarChart";e.widgetId=a.attrs.safe(o.widgetId,s+(new Date).getTime());var i=a.attrs.safe(o.eventControlId,"EventControl-"+e.widgetId);e.widgetTitle=a.attrs.safe(o.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(o.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(o.widgetIntro,null),e.debug="true"===o.debug,e.debugMessages=[];var d=o.usertoken,c=o.filter,u=o.orderby,g=(a.attrs.num(o.top,1,1e3,1e3),a.attrs.num(o.top,null,null,1),a.attrs.safe(o.datasetcode,null));null==g&&e.debugMessages.push("Invalid dataset code");var p=a.attrs.safe(o.euroValue,!1),v=a.attrs.safe(o.decimalValue,2),f=a.attrs.safe(o.formatBigNumber,!1);e.isEuroValue=function(){return"true"==p};var h=("true"===o.skipZeroValues,e.$eval(o.chartColors)),m=(a.attrs.safe(o.mainChartColor,"#00bbf0"),a.attrs.safe(o.groupedQuery,!1)),y=e.$eval(o.serieColumns),b=null!=y;console.log("serieColumns",y);var w=e.$eval(o.valueColumn);b||null!=w||e.debugMessages.push("Insert valueColumn");var x=e.$eval(o.valueColumns);e.chartWidth=a.attrs.num(o.widgetWidth,null,null,null),e.chartHeight=a.attrs.num(o.widgetHeight,null,null,null),r(function(){var t=angular.element(document.querySelector("#"+e.widgetId+" .yucca-widget-chart-content"));e.options.chart.height=t[0].offsetHeight});var k=e.$eval(o.groupByColumn);null==k&&e.debugMessages.push("Invalid group by column");var w=e.$eval(o.valueColumn),D=e.$eval(D),_=e.$eval(o.axis);"undefined"==typeof _&&(_={hide:!1,label:""});var C=e.$eval(o.yAxis);"undefined"==typeof C&&(C={hide:!1,label:""}),e.options={chart:{type:"multiBarHorizontalChart",duration:500,x:function(e){return e.label},y:function(e){return e.value},valueFormat:function(t){return a.render.safeNumber(t<0?-1*t:t,v,e.isEuroValue(),f)},showValues:"false"!==o.showValues,reduceXTicks:"true"==o.reduceXTicks,multibar:{dispatch:{elementMouseout:function(t){var r=t.data;r.groupByColumn=k,r.valueColumn=w;var l=a.event.createEvent(e.widgetId,s,"dataset.de_highlight.group_by_column",r);l.eventControlId=i,n.$broadcast("yucca-widget-event",l)},elementMouseover:function(t){var r=t.data;r.groupByColumn=k,r.valueColumn=w;var l=a.event.createEvent(e.widgetId,s,"dataset.highlight.group_by_column",r);l.eventControlId=i,n.$broadcast("yucca-widget-event",l)}}}}},"true"==o.stacked&&(e.options.chart.stacked=!0),C.hide?e.options.chart.showXAxis=!1:(e.options.chart.showXAxis=!0,e.options.chart.xAxis={rotateLabels:C.rotateLabels?C.rotateLabels:0,axisLabel:C.label?C.label:""}),_.hide?e.options.chart.showYAxis=!1:(e.options.chart.showYAxis=!0,e.options.chart.yAxis={tickFormat:function(t){return a.render.safeNumber(t<0?-1*t:t,v,e.isEuroValue(),f)},axisLabel:_.label?_.label:"",rotateLabels:_.rotateLabels?_.rotateLabels:0}),console.log("yAxisAttr",C.hide),console.log("scope.options",e.options);var I=e.$eval(o.chartLegend);if(I&&I.show){var M={margin:I.position};e.options.chart.legend=M,e.options.chart.showLegend=!0}else e.options.chart.showLegend=!1;e.chartData=new Array;var L=a.event.readWidgetEventAttr(o);console.log("eventConfig",L);var T={};e.$on("yucca-widget-event",function(t,n){console.debug("yucca-widget-event",n),void 0==typeof n||null==n||n.sourceId==e.widgetId||a.event.ignoreEvent(n,L)||("dataset.change.group_by_column"==n.eventtype?(k=n.data,m?A():V()):"dataset.filter.text"==n.eventtype?(T[n.sourceId]=n.data,c=a.event.updateTextFilter(o.filter,T,E),m?A():S()):"dataset.filter.odata"==n.eventtype&&(c="",n.data.filter&&""!=n.data.filter?(o.filter&&!n.data.override&&(c="("+o.filter+") and "),c+="("+n.data.filter+")"):c=o.filter,m?A():S()))});var $=null,E={},S=function(){e.isLoading=!0,$=null,t.getDataEntities(o.datasetcode,d,c,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var l in r)r.hasOwnProperty(l)&&"__metadata"!=l&&(E[l]=typeof r[l]);console.log("columnDataTypeMap ",E)}t.getMultipleDataEnties(o.datasetcode,d,c,u,n).then(function(e){console.info("horizontalmultibarchart:loadData",e),$=e,V()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},V=function(){if(console.log("prepareData",$),null!=$){e.isLoading=!0;for(var t=new Array,n=0;n<$.length;n++)t=t.concat($[n].data.d.results);if(b){for(var r=a.data.aggregationSeriesKeyValue(t,y,k.key,h,o.mainChartColor),l=0;l<r.length;l++)if(r[l].side&&"L"==r[l].side)for(var s=0;s<r[l].values.length;s++)r[l].values[s].value*=-1;e.chartData=r}else{for(var r=a.data.aggregationValuesValueKey(t,x,w,k,h,o.mainChartColor),l=0;l<r.length;l++)if(console.log("chartData",r[l]),r[l].side&&"L"==r[l].side)for(var s=0;s<r[l].values.length;s++)r[l].values[s].value*=-1;e.chartData=r}console.log("horizontalmultibar chartData",e.chartData)}e.isLoading=!1};e.downloadData=function(){if(e.chartData){console.log("downloadData",e.chartData);var t=a.csv.prepareSeriesKeyValue(k.label,e.chartData);a.csv.downloadCSV(t,"data.csv")}};var A=function(){e.isLoading=!0,$=null;var n=k.key,r=w.countingMode+","+w.key;t.getDataEntitiesStats(o.datasetcode,d,n,r,c,0,1e3,null).then(function(t){if(console.log("loadDataGrouped",t),null!=t){e.isLoading=!0;var n={key:w.key+"_sts",label:w.label,countingMode:w.countingMode};e.chartData=a.data.aggregationSeriesKeyValue(t.data.d.results,[n],k.key,h,o.mainChartColor),console.log("horizontalmultibar chartData",e.chartData),e.isLoading=!1}},function(t){e.isLoading=!1,console.error("loadDataGrouped error",t),e.debugMessages.push("Load data error "+t)})};m?A():S(),console.log("attrs",o)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_horizontalmultibar_chart.html",'<div class="yucca-widget yucca-dataset-horizontalmultibar-chart" id="{{widgetId}}" style="height: {{chartHeight}}px;width: {{chartWidth}}px;">\n    <div class="yucca-widget-download-csv" ng-if="!isLoading"><a href ng-click="downloadData()">Data</a></div>\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-horizontalmultibar-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-widget-chart" >\n\t\t\t\t<div><nvd3 options="options" data="chartData" ></nvd3></div>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetLineChart",["metadataService","dataService","$yuccaHelpers","$timeout","$compile",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_line_chart.html",link:function(e,r,l){console.log("elem",r);var o="YuccaBasicDatasetLineChart";e.widgetId=a.attrs.safe(l.widgetId,o+(new Date).getTime()),e.widgetTitle=a.attrs.safe(l.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(l.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(l.widgetIntro,null),e.debug="true"===l.debug,e.debugMessages=[];var s=l.usertoken,i=l.filter,d=l.orderby,c=(a.attrs.num(l.top,1,1e3,1e3),a.attrs.num(l.top,null,null,1),a.attrs.safe(l.datasetcode,null));null==c&&e.debugMessages.push("Invalid dataset code");var u=a.attrs.safe(l.euroValue,!1),g=a.attrs.safe(l.decimalValue,2),p=a.attrs.safe(l.formatBigNumber,!1);e.isEuroValue=function(){return"true"==u};var v=("true"===l.skipZeroValues,a.attrs.safe(l.mainChartColor,"#00bbf0"),a.attrs.safe(l.groupedQuery,!1));e.chartWidth=a.attrs.num(l.widgetWidth,null,null,null),e.chartHeight=a.attrs.num(l.widgetHeight,null,null,null),n(function(){var t=angular.element(document.querySelector("#"+e.widgetId+" .yucca-widget-chart-content"));e.options.chart.height=t[0].offsetHeight});var f=e.$eval(l.timeColumn);null==f&&e.debugMessages.push("Invalid group by column");var h=e.$eval(l.serieColumns);null==h&&e.debugMessages.push("Insert serieColumns"),console.log("linechart - serieColumns",h);var m=e.$eval(l.axis);"undefined"==typeof m&&(m={hide:!1,label:""});var y=e.$eval(l.yAxis);"undefined"==typeof y&&(y={hide:!1,label:""}),e.options={chart:{type:"lineChart",duration:500,x:function(e){return e.x},y:function(e){return e.y},useInteractiveGuideline:!0,valueFormat:function(t){return a.render.safeNumber(t,g,e.isEuroValue(),p)},showValues:"false"!==l.showValues,yAxis:{tickFormat:function(t){return a.render.safeNumber(t,g,e.isEuroValue(),p)},rotateLabels:y.rotateLabels?y.rotateLabels:0,axisLabel:y.label?y.label:""},xAxis:{axisLabel:m.label?m.label:"",rotateLabels:m.rotateLabels?m.rotateLabels:0},showXAxis:!m.hide,showYAxis:!y.hide,reduceXTicks:"true"==l.reduceXTicks}};var b=e.$eval(l.chartLegend);if(b&&b.show){var w={margin:b.position};e.options.chart.legend=w,e.options.chart.showLegend=!0}else e.options.chart.showLegend=!1;e.chartData=new Array;var x=a.event.readWidgetEventAttr(l);console.log("eventConfig",x);var k={};e.$on("yucca-widget-event",function(t,n){console.log("yucca-widget-event",n),void 0==typeof n||null==n||n.sourceId==e.widgetId||a.event.ignoreEvent(n,x)||("dataset.change.group_by_column"==n.eventtype?(f=n.data,v?M():I()):"dataset.filter.text"==n.eventtype?(k[n.sourceId]=n.data,i=a.event.updateTextFilter(l.Filter,k,_),v?M():C()):"dataset.filter.odata"==n.eventtype&&(i="",n.data.filter&&""!=n.data.filter?(l.filter&&!n.data.override&&(i="("+l.filter+") and "),i+="("+n.data.filter+")"):i=l.filter,v?M():C()))});var D=null,_={},C=function(){e.isLoading=!0,D=null,t.getDataEntities(l.datasetcode,s,i,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var o in r)r.hasOwnProperty(o)&&"__metadata"!=o&&(_[o]=typeof r[o]);console.log("columnDataTypeMap ",_)}t.getMultipleDataEnties(l.datasetcode,s,i,d,n).then(function(e){console.info("linechart:loadData",e),D=e,I()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},I=function(){console.log("prepareData",D),e.chartData=new Array;var t=new Array;if(null!=D){for(var n=0;n<D.length;n++)t=t.concat(D[n].data.d.results);var r=a.render.safeColors(h.length,e.$eval(l.chartColors),l.mainChartColor);console.log("colors",r),e.isLoading=!0,e.chartData=a.data.aggregationSeriesXY(t,f,h,r),console.log("chartData line",e.chartData)}e.isLoading=!1};e.downloadData=function(){if(e.chartData){console.log("downloadData",e.chartData);var t=a.csv.prepareSeriesXY(f.label,e.chartData);a.csv.downloadCSV(t,"data.csv")}};var M=function(){e.isLoading=!0,D=null;var n=groupByColumn.key,r=valueColumn.countingMode+","+valueColumn.key;t.getDataEntitiesStats(l.datasetcode,s,n,r,i,0,1e3,null).then(function(t){if(console.log("loadDataGrouped",t),null!=t){e.isLoading=!0;var n={key:valueColumn.key+"_sts",label:valueColumn.label,countingMode:valueColumn.countingMode};e.chartData=a.data.aggregationSeriesKeyValue(t.data.d.results,[n],groupByColumn.key,chartColors,l.mainChartColor),console.log("discrete chartData",e.chartData),e.isLoading=!1}},function(t){e.isLoading=!1,console.error("loadDataGrouped error",t),e.debugMessages.push("Load data error "+t)})};v?M():C(),console.log("attrs",l)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_line_chart.html",'<div class="yucca-widget yucca-dataset-line-chart" id="{{widgetId}}" style="height: {{chartHeight}}px;width: {{chartWidth}}px;">\n    <div class="yucca-widget-download-csv" ng-if="!isLoading"><a href ng-click="downloadData()">Data</a></div>\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-line-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-widget-chart" >\n\t\t\t\t<div><nvd3 options="options" data="chartData" ></nvd3></div>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetMultiChart",["metadataService","dataService","$yuccaHelpers","$rootScope","$timeout",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_multi_chart.html",link:function(e,n,l){console.debug("elemmulti",n);var o="YuccaBasicMultiChart";e.widgetId=a.attrs.safe(l.widgetId,o+(new Date).getTime()),e.widgetTitle=a.attrs.safe(l.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(l.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(l.widgetIntro,null),e.debug="true"===l.debug,e.debugMessages=[];var s=l.usertoken,i=l.filter,d=l.orderby,c=(a.attrs.num(l.top,1,1e3,1e3),a.attrs.num(l.top,null,null,1),a.attrs.safe(l.datasetcode,null));null==c&&e.debugMessages.push("Invalid dataset code");var u=a.attrs.safe(l.euroValue,!1),g=a.attrs.safe(l.decimalValue,2),p=a.attrs.safe(l.formatBigNumber,!1);e.isEuroValue=function(){return"true"==u};var v=("true"===l.skipZeroValues,e.$eval(l.chartColors)),f=(a.attrs.safe(l.mainChartColor,"#00bbf0"),a.attrs.safe(l.groupedQuery,!1));e.chartWidth=a.attrs.num(l.widgetWidth,null,null,null),e.chartHeight=a.attrs.num(l.widgetHeight,null,null,null),r(function(){var t=angular.element(document.querySelector("#"+e.widgetId+" .yucca-widget-chart-content"));e.options.chart.height=t[0].offsetHeight});var h=e.$eval(l.groupByColumn);null==h&&e.debugMessages.push("Invalid group by column");var m=e.$eval(l.valueColumn),y=e.$eval(l.axis);"undefined"==typeof y&&(y={show:!1,label:""});var b=e.$eval(l.yAxis);"undefined"==typeof b&&(b={show:!1,label:""});var w=e.$eval(l.serieStyles);console.log("serieStyles",w);var x=e.$eval(l.serieColumns);null==x&&e.debugMessages.push("Insert serieColumns"),console.log("serieColumns",x),e.options={chart:{type:"multiChart",duration:500,valueFormat:function(t){return a.render.safeNumber(t,g,e.isEuroValue(),p)},yAxis1:{tickFormat:function(t){return a.render.safeNumber(t,g,e.isEuroValue(),p)},rotateLabels:b.rotateLabels?b.rotateLabels:0,axisLabel:b.label?b.label:""},xAxis:{axisLabel:y.label?y.label:"",rotateLabels:y.rotateLabels?y.rotateLabels:0},yAxis2:{tickFormat:function(t){return a.render.safeNumber(t,g,e.isEuroValue(),p)},axisLabel:b.label?b.label:""},reduceXTicks:"true"==l.reduceXTicks}};var k=e.$eval(l.chartLegend);if(k&&k.show){var D={margin:k.position};e.options.chart.legend=D,e.options.chart.showLegend=!0}else e.options.chart.showLegend=!1;e.chartData=new Array;var _=a.event.readWidgetEventAttr(l);console.log("eventConfig",_);var C={};e.$on("yucca-widget-event",function(t,n){console.log("yucca-widget-event",n),void 0==typeof n||null==n||n.sourceId==e.widgetId||a.event.ignoreEvent(n,_)||("dataset.change.group_by_column"==n.eventtype?(h=n.data,f?$():T()):"dataset.change.value_column"==n.eventtype?(m.key=n.data.key,m.label=n.data.label,f?$():T()):"dataset.filter.text"==n.eventtype?(C[n.sourceId]=n.data,i=a.event.updateTextFilter(l.Filter,C,M),f?$():L()):"dataset.filter.odata"==n.eventtype&&(i="",n.data.filter&&""!=n.data.filter?(l.filter&&!n.data.override&&(i="("+l.filter+") and "),i+="("+n.data.filter+")"):i=l.filter,f?$():L()))});var I=null,M={},L=function(){e.isLoading=!0,I=null,t.getDataEntities(l.datasetcode,s,i,0,1,null).then(function(a){console.log("loadData multichart",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var o in r)r.hasOwnProperty(o)&&"__metadata"!=o&&(M[o]=typeof r[o]);console.log("columnDataTypeMap ",M)}t.getMultipleDataEnties(l.datasetcode,s,i,d,n).then(function(e){console.info("multichart:loadData",e),I=e,T()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},T=function(){if(console.log("prepareData",I),null!=I){e.isLoading=!0;for(var t=new Array,n=0;n<I.length;n++)t=t.concat(I[n].data.d.results);console.log("allData multichart",t),e.chartData=a.data.aggregationSeriesXY(t,h,x,v,l.mainChartColor),console.log("multi chartData",e.chartData)}e.isLoading=!1};e.downloadData=function(){if(e.chartData){console.log("downloadData",e.chartData);var t=a.csv.prepareSeriesXY(h.label,e.chartData);a.csv.downloadCSV(t,"data.csv")}};var $=function(){e.isLoading=!0,I=null;var n=h.key,r=m.countingMode+","+m.key;t.getDataEntitiesStats(l.datasetcode,s,n,r,i,0,1e3,null).then(function(t){if(console.log("loadDataGrouped",t),null!=t){e.isLoading=!0;var n={key:m.key+"_sts",label:m.label,countingMode:m.countingMode};e.chartData=a.data.aggregationSeriesKeyValue(t.data.d.results,[n],h.key,v,l.mainChartColor),console.log("discrete chartData",e.chartData),e.isLoading=!1}},function(t){e.isLoading=!1,console.error("loadDataGrouped error",t),e.debugMessages.push("Load data error "+t)})};f?$():L(),console.log("attrs",l)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_multi_chart.html",'<div class="yucca-widget yucca-dataset-discretebar-chart" id="{{widgetId}}" style="height: {{chartHeight}}px;width: {{chartWidth}}px;">\n    <div class="yucca-widget-download-csv" ng-if="!isLoading"><a href ng-click="downloadData()">Data</a></div>\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-discretebar-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-widget-chart" >\n\t\t\t\t<div><nvd3 options="options" data="chartData" ></nvd3></div>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetMultibarChart",["metadataService","dataService","$yuccaHelpers","$rootScope","$timeout",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_multibar_chart.html",link:function(e,l,o){console.debug("elemmulti",l);var s="YuccaBasicMultibarChart";e.widgetId=a.attrs.safe(o.widgetId,s+(new Date).getTime());var i=a.attrs.safe(o.eventControlId,"EventControl");e.widgetTitle=a.attrs.safe(o.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(o.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(o.widgetIntro,null),e.debug="true"===o.debug,e.debugMessages=[];var d=o.usertoken,c=o.filter,u=o.orderby,g=(a.attrs.num(o.top,1,1e3,1e3),a.attrs.num(o.top,null,null,1),a.attrs.safe(o.datasetcode,null));null==g&&e.debugMessages.push("Invalid dataset code");var p=a.attrs.safe(o.euroValue,!1),v=a.attrs.safe(o.decimalValue,2),f=a.attrs.safe(o.formatBigNumber,!1);e.isEuroValue=function(){return"true"==p};var h=("true"===o.skipZeroValues,e.$eval(o.chartColors)),m=(a.attrs.safe(o.mainChartColor,"#00bbf0"),"horizontal"==o.chartDirection?"multiBarHorizontalChart":"multiBarChart"),y=a.attrs.safe(o.groupedQuery,!1);e.chartWidth=a.attrs.num(o.widgetWidth,null,null,null),e.chartHeight=a.attrs.num(o.widgetHeight,null,null,null),r(function(){var t=angular.element(document.querySelector("#"+e.widgetId+" .yucca-widget-chart-content"));e.options.chart.height=t[0].offsetHeight});var b=e.$eval(o.groupByColumn);null==b&&e.debugMessages.push("Invalid group by column");var w=e.$eval(o.seriesDescriptionColumn),x=e.$eval(o.axis);"undefined"==typeof x&&(x={hide:!1,label:""}),console.log("xAxisAttr",x);var k=e.$eval(o.yAxis);"undefined"==typeof k&&(k={hide:!1,label:""});var D=e.$eval(o.serieColumns);null==D&&e.debugMessages.push("Insert serieColumns");var _="true"===o.seriesFromValues;console.log("serieColumns",D);var C=function(t){var n=t.data.description?t.data.description:t.value,r="";r+="<table>",r+="<thead>",r+="<tr><td colspan='3'><strong class='x-value'>"+n+"</strong></td></tr>",r+="</thead>",r+="<tbody>";var l="",o=e.isEuroValue(),s=v,i=f;!_&&D[t.index]&&(console.log("serieColumns[d.index]",D[t.index]),D[t.index].text_after&&(l=" "+D[t.index].text_after+" "),D[t.index].euro_value&&(o=D[t.index].euro_value),D[t.index].decimal_value&&(s=D[t.index].decimal_value),
D[t.index].format_big_number&&(i=D[t.index].format_big_number),console.log("isEuro",o),console.log("decimal",s),console.log("bigNumber",i));for(var d in t.series){var c=t.series[d],u=c.color,g=c.key,p=c.value;r+="<tr>",r+="   <td class='legend-color-guide'>",r+="      <div style='background-color: "+u+";'></div>",r+="   </td>",r+="   <td class='key'>"+g+"</td>",r+="   <td class='value'>"+a.render.safeNumber(p,s,o,i)+l+"</td>",r+="</tr>"}return r+="</tbody>",r+="</table>"};e.options={chart:{type:m,duration:500,x:function(e){return e.label},y:function(e){return e.value},showValues:"false"!==o.showValues,wrapLabels:!0,tooltip:{contentGenerator:C},yAxis:{tickFormat:function(t){return a.render.safeNumber(t,v,e.isEuroValue(),f)},axisLabel:k.label?k.label:"",rotateLabels:k.rotateLabels?k.rotateLabels:0},xAxis:{axisLabel:x.label?x.label:"",rotateLabels:x.rotateLabels?x.rotateLabels:0},showXAxis:!x.hide,showYAxis:!k.hide,reduceXTicks:"true"==o.reduceXTicks,multibar1:{dispatch:{elementMouseout:function(t){var r=t.data;r.groupByColumn=b,r.valueColumn=valueColumn;var l=a.event.createEvent(e.widgetId,s,"dataset.de_highlight.group_by_column",r);l.eventControlId=i,n.$broadcast("yucca-widget-event",l)},elementMouseover:function(t){console.log(t.data);var r=t.data;r.groupByColumn=b,r.valueColumn=valueColumn;var l=a.event.createEvent(e.widgetId,s,"dataset.highlight.group_by_column",r);l.eventControlId=i,n.$broadcast("yucca-widget-event",l)}}}}},"true"==o.stacked&&(e.options.chart.stacked=!0);var I=e.$eval(o.chartLegend);if(I&&I.show){var M={margin:I.position};e.options.chart.legend=M,e.options.chart.showLegend=!0}else e.options.chart.showLegend=!1;e.chartData=new Array;var L=a.event.readWidgetEventAttr(o);console.log("eventConfig",L);var T={};e.$on("yucca-widget-event",function(t,n){console.log("yucca-widget-event",n),void 0==typeof n||null==n||n.sourceId==e.widgetId||a.event.ignoreEvent(n,L)||("dataset.change.group_by_column"==n.eventtype?(b=n.data,y?A():V()):"dataset.change.value_column"==n.eventtype?(valueColumn.key=n.data.key,valueColumn.label=n.data.label,y?A():V()):"dataset.filter.text"==n.eventtype?(T[n.sourceId]=n.data,c=a.event.updateTextFilter(o.filter,T,E),y?A():S()):"dataset.filter.odata"==n.eventtype&&(c="",n.data.filter&&""!=n.data.filter?(o.filter&&!n.data.override&&(c="("+o.filter+") and "),c+="("+n.data.filter+")"):c=o.filter,y?A():S()))});var $=null,E={},S=function(){e.isLoading=!0,$=null,t.getDataEntities(o.datasetcode,d,c,0,1,u).then(function(a){console.log("loadData multichart",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var l in r)r.hasOwnProperty(l)&&"__metadata"!=l&&(E[l]=typeof r[l]);console.log("columnDataTypeMap ",E)}t.getMultipleDataEnties(o.datasetcode,d,c,u,n).then(function(e){console.info("multichart:loadData",e),$=e,V()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},V=function(){if(console.log("prepareData",$),null!=$){e.isLoading=!0;for(var t=new Array,n=0;n<$.length;n++)t=t.concat($[n].data.d.results);console.log("allData multichart",t);var r;if(r=_?a.data.aggregationSeriesKeyValue(t,D,b.key,h,o.mainChartColor,w):a.data.aggregationSeriesValueKey(t,D,b.key,h,o.mainChartColor),"multiBarHorizontalChart"==m){var l=N(r[0].values),s=d3.select("#"+e.widgetId+"-fake").insert("svg").append("text").text(l);e.options.chart.margin||(e.options.chart.margin={}),e.options.chart.margin.left=s.node().getComputedTextLength(),console.log("maxLabel",l,s.node().getComputedTextLength()),d3.select("#"+e.widgetId+"-fake").remove()}e.chartData=r,console.log("multibarchartData",e.chartData)}e.isLoading=!1};e.downloadData=function(){if(e.chartData){console.log("downloadData",e.chartData);var t=a.csv.prepareSeriesKeyValue(b.label,e.chartData);a.csv.downloadCSV(t,"data.csv")}};var A=function(){e.isLoading=!0,$=null;var n=b.key,r=valueColumn.countingMode+","+valueColumn.key;t.getDataEntitiesStats(o.datasetcode,d,n,r,c,0,1e3,null).then(function(t){if(console.log("loadDataGrouped",t),null!=t){e.isLoading=!0;var n={key:valueColumn.key+"_sts",label:valueColumn.label,countingMode:valueColumn.countingMode};e.chartData=a.data.aggregationSeriesKeyValue(t.data.d.results,[n],b.key,h,o.mainChartColor),console.log("discrete chartData",e.chartData),e.isLoading=!1}},function(t){e.isLoading=!1,console.error("loadDataGrouped error",t),e.debugMessages.push("Load data error "+t)})},N=function(e){var t="";if(e)for(var a=0;a<e.length;a++)e[a].label.length>t.length&&(t=e[a].label);return t};y?A():S(),console.log("attrs",o)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_multibar_chart.html",'<div class="yucca-widget yucca-dataset-discretebar-chart" id="{{widgetId}}" style="height: {{chartHeight}}px;width: {{chartWidth}}px;">\n    <div class="yucca-widget-download-csv" ng-if="!isLoading"><a href ng-click="downloadData()">Data</a></div>\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-discretebar-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div id="{{widgetId}}-fake"></div>           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-widget-chart" >\n\t\t\t\t<div><nvd3 options="options" data="chartData" ></nvd3></div>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetNavigableexplorerTable",["metadataService","dataService","$yuccaHelpers","$timeout","$rootScope",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_navigableexplorer_table.html",link:function(e,l,o){console.log("elem",l);var s="YuccaBasicDatasetNavigableexplorerTable";e.widgetId=a.attrs.safe(o.widgetId,s+(new Date).getTime());var i=a.attrs.safe(o.eventControlId,"EventControl");e.widgetTitle=a.attrs.safe(o.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(o.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(o.widgetIntro,null),e.debug="true"===o.debug,e.debugMessages=[];var d=o.usertoken,c=o.filter,u=o.orderby,g=(a.attrs.num(o.top,1,1e3,1e3),a.attrs.num(o.top,null,null,1),a.attrs.safe(o.datasetcode,null));null==g&&e.debugMessages.push("Invalid dataset code");var p=a.attrs.safe(o.euroValue,!1),v=a.attrs.safe(o.decimalValue,2),f=a.attrs.safe(o.formatBigNumber,!1);e.isEuroValue=function(){return"true"==p};var h=a.attrs.safe(o.euroValue2,!1),m=a.attrs.safe(o.decimalValue2,2),y=a.attrs.safe(o.formatBigNumber2,!1);e.isEuroValue2=function(){return"true"==h};var b=("true"===o.skipZeroValues,a.attrs.safe(o.rootLabel,"-"));e.treeColumns=e.$eval(o.treeColumns),"Array"!=typeof e.treeColumns&&e.debugMessages.push("Invalid tree columns"),e.valueColumn=e.$eval(o.valueColumn),e.valueColumn2=e.$eval(o.valueColumn2);var w=a.event.readWidgetEventAttr(o);console.log("eventConfig",w);var x={};e.$on("yucca-widget-event",function(t,r){console.log("yucca-widget-event",r),n(function(){void 0!=typeof r&&null!=r&&r.sourceId!=e.widgetId&&(void 0==typeof r||null==r||r.sourceId==e.widgetId||a.event.ignoreEvent(r,w)||("dataset.change.value_column"==r.eventtype?(e.valueColumn=r.data,C()):"dataset.browse"==r.eventtype?(e.path=r.data.path,M()):"dataset.filter.text"==r.eventtype?(x[r.sourceId]=r.data,c=a.event.updateTextFilter(o.Filter,x,columnDataTypeMap),D()):"dataset.filter.odata"==r.eventtype&&(c="",r.data.filter&&""!=r.data.filter?(o.filter&&!r.data.override&&(c="("+o.filter+") and "),c+="("+r.data.filter+")"):c=o.filter,D())))})}),e.tableData=[];var k=null;e.totalResult=0;var D=function(){e.tableData=[],e.isLoading=!0,t.getDataEntities(o.datasetcode,d,c,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;t.getMultipleDataEnties(o.datasetcode,d,c,u,n).then(function(t){e.isLoading=!1,console.info("navigableexplorer:loadData",t),k=t,C()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})};e.path=[b];var _=null,C=function(){if(console.log("prepareData",k),e.isLoading=!0,null!=k){e.tableHeader=new Array,e.isLoading=!0;for(var t=new Array,n=0;n<k.length;n++)t=t.concat(k[n].data.d.results);_=a.data.aggregationTree(b,t,e.treeColumns,e.valueColumn,e.valueColumn2),console.log("navigable explorer fuori",_),M(0)}e.isLoading=!1},I=function(e,t,a){var n=0;if(t.children)for(var r=0;r<t.children.length;r++){if(t.children[r].children)return I(t.children[r].name,t.children[r],a);n+=2==a?t.children[r].value2:t.children[r].value}else n=2==a?t.value2:t.value;return n},M=function(){if(_&&null!=_){for(var t=_.children,n=0;n<e.path.length;n++)if(t)for(var r=0;r<t.length;r++)t[r].name==e.path[n]&&t[r].children&&(t=t[r].children);console.log("childrens",t);for(var r=0;r<t.length;r++)t[r].total=I(t[r].name,t[r],1),e.valueColumn2&&(t[r].total2=I(t[r].name,t[r],2));console.log("childrens",t)}e.tableData=new Array;for(var r=0;r<t.length;r++)t[r].total=a.render.safeNumber(t[r].total,v,e.isEuroValue(),f),t[r].total2&&(t[r].total2=a.render.safeNumber(t[r].total2,m,e.isEuroValue2(),y)),e.tableData.push(t[r]);console.log("navigable tableData",e.tableData)};e.drillUp=function(){if(e.path.length>1){e.path.pop(),M();var t=a.event.createEvent(e.widgetId,s,"dataset.browse",{path:e.path,datasetcode:g});t.eventControlId=i,r.$broadcast("yucca-widget-event",t)}},e.drillDown=function(t){e.path.push(t),M();var n=a.event.createEvent(e.widgetId,s,"dataset.browse",{path:e.path,datasetcode:g});n.eventControlId=i,r.$broadcast("yucca-widget-event",n)},D(),console.log("attrs",o)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_navigableexplorer_table.html",'<div class="yucca-widget yucca-dataset-dataexplorer" id="{{widgetId}}">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-dataexplorer-content">\n        <section>\n         <div ng-if="isLoading" class="yucca-dataset-dataexplorer-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n         </div>\n           <div class="yucca-dataset-dataexplorer-breadcrumbs" >              <span class="yucca-dataset-dataexplorer-breadcrumbs-item" ng-repeat="p in path track by $index">                 <span ng-if="!$last">{{p}} {{$last ? "": "&rarr;"}} </span><a ng-click="drillUp()" href ng-if="$last">{{p}}</a>              </span>           </div>\n\t\t\t<table ng-if="!isLoading"  class="yucca-dataset-dataexplorer-table" ng-if="!isLoading">\n\t\t\t  <thead><tr><th>{{treeColumns[path.length-1].label}}</th><th>{{valueColumn.label}}</th><th ng-if="valueColumn2">{{valueColumn2.label}}</th></tr></thead>             <tbody>\n                 <tr ng-repeat="row in tableData " class="yucca-dataset-dataexplorer-table-row" style="{{row.highlight}}">\n                   <td class="yucca-dataset-dataexplorer-key-column"><a href ng-click="drillDown(row.name)" ng-if="row.children">{{row.name}}</a><span ng-if="row.value">{{row.name}}</span></td>                   <td class="yucca-dataset-dataexplorer-value-column">{{row.total}}</td>                   <td class="yucca-dataset-dataexplorer-value-column2" ng-if="valueColumn2">{{row.total2}}</td>                 </tr>\n             </tbody>\n         </table>\n        </section>\n   \t <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n   \t </section>\n    </div>\n<div>\n</div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetPieChart",["metadataService","dataService","$yuccaHelpers","$rootScope","$timeout",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_pie_chart.html",link:function(e,l,o){console.log("elem",l);var s="YuccaBasicDatasetPieChart";e.widgetId=a.attrs.safe(o.widgetId,s+(new Date).getTime());var i=a.attrs.safe(o.eventControlId,"EventControl");e.widgetTitle=a.attrs.safe(o.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(o.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(o.widgetIntro,null),e.debug="true"===o.debug,e.debugMessages=[];var d=o.usertoken,c=o.filter,u=o.orderby,g=(a.attrs.num(o.top,1,1e3,1e3),a.attrs.num(o.top,null,null,1),a.attrs.safe(o.datasetcode,null));null==g&&e.debugMessages.push("Invalid dataset code");var p=a.attrs.safe(o.euroValue,!1),v=a.attrs.safe(o.decimalValue,2),f=a.attrs.safe(o.formatBigNumber,!1);e.isEuroValue=function(){return"true"==p};var h=a.attrs.safe(o.labelType,"key");o.showValues&&"false"===o.showValues&&(h="none");var m=e.$eval(o.chartColors),y=(a.attrs.safe(o.mainChartColor,"#00bbf0"),a.attrs.safe(o.groupedQuery,!1));e.chartWidth=a.attrs.num(o.widgettWidth,null,null,null),e.chartHeight=a.attrs.num(o.widgetHeight,null,null,null),r(function(){var t=angular.element(document.querySelector("#"+e.widgetId+" .yucca-widget-chart-content"));console.log("height",t[0].offsetHeight),e.options.chart.height=t[0].offsetHeight});var b=e.$eval(o.groupByColumn);null==b&&e.debugMessages.push("Invalid group by column");var w=e.$eval(o.valueColumn);e.options={chart:{type:"pieChart",duration:500,x:function(e){return e.key},y:function(e){return e.value},showLegend:"false"!==o.showLegend,showLabels:"false"!==o.showLabels,labelType:h,labelSunbeamLayout:"false"!==o.labelSunbeamLayout,valueFormat:function(t){return"value"==h?a.render.safeNumber(t,v,e.isEuroValue(),f):t},tooltip:{valueFormatter:function(t){return a.render.safeNumber(t,v,e.isEuroValue(),f)}},pie:{dispatch:{elementMouseout:function(t){var r=t.data;r.groupByColumn=b,r.valueColumn=w;var l=a.event.createEvent(e.widgetId,s,"dataset.de_highlight.group_by_column",r);l.eventControlId=i,n.$broadcast("yucca-widget-event",l)},elementMouseover:function(t){console.log("e",t);var r=t.data;r.groupByColumn=b,r.valueColumn=w,r.color=a.utils.rgb2Hex(t.color),console.log("rgb",r.color);var l=a.event.createEvent(e.widgetId,s,"dataset.highlight.group_by_column",r);l.eventControlId=i,n.$broadcast("yucca-widget-event",l)}}}}},o.labelThreshold&&(e.options.chart.labelThreshold=o.labelThreshold),console.log("attr.render",o.render);var x=e.$eval(o.render);console.log("render",x),x&&(x.donut===!0?(e.options.chart.donut=!0,"undefined"!=typeof x.donutRatio?e.options.chart.donutRatio=x.donutRatio:delete e.options.chart.donutRatio):(delete e.options.chart.donut,delete e.options.chart.donutRatio),x.halfPie?(x.rotation||(x.rotation=1),e.options.chart.startAngle=function(e){return e.startAngle/2-x.rotation*Math.PI/2},e.options.chart.endAngle=function(e){return e.endAngle/2-x.rotation*Math.PI/2}):(x.section||x.rotation)&&("undefined"==typeof x.section&&(x.section=1),"undefined"==typeof x.rotation&&(x.rotation=0),e.options.chart.startAngle=function(e){return e.startAngle/x.section-x.rotation*Math.PI/10},e.options.chart.endAngle=function(e){return e.endAngle/x.section-x.rotation*Math.PI/10}),"undefined"!=typeof x.cornerRadius?e.options.chart.cornerRadius=x.cornerRadius:delete e.options.chart.cornerRadius);var k=e.$eval(o.chartLegend);if(k&&k.show){var D={margin:k.position};e.options.chart.legend=D,e.options.chart.showLegend=!0}else e.options.chart.showLegend=!1;e.chartData=new Array;var _=a.event.readWidgetEventAttr(o);console.log("eventConfig",_);var C={};e.$on("yucca-widget-event",function(t,n){console.log("yucca-widget-event",n),void 0==typeof n||null==n||n.sourceId==e.widgetId||a.event.ignoreEvent(n,_)||("dataset.change.group_by_column"==n.eventtype?(b=n.data,y?$():T()):"dataset.change.value_column"==n.eventtype?(w.key=n.data.key,w.label=n.data.label,y?$():T()):"dataset.filter.text"==n.eventtype?(C[n.sourceId]=n.data,c=a.event.updateTextFilter(o.Filter,C,M),y?$():L()):"dataset.filter.odata"==n.eventtype&&(c="",n.data.filter&&""!=n.data.filter?(o.filter&&!n.data.override&&(c="("+o.filter+") and "),c+="("+n.data.filter+")"):c=o.filter,y?$():L()))});var I=null,M={},L=function(){e.isLoading=!0,I=null,t.getDataEntities(o.datasetcode,d,c,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var l in r)r.hasOwnProperty(l)&&"__metadata"!=l&&(M[l]=typeof r[l]);console.log("columnDataTypeMap ",M)}t.getMultipleDataEnties(o.datasetcode,d,c,u,n).then(function(e){console.info("piechart:loadData",e),I=e,T()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},T=function(){if(console.log("prepareData",I),null!=I){e.isLoading=!0;for(var t=new Array,n=0;n<I.length;n++)t=t.concat(I[n].data.d.results);e.chartData=a.data.aggregationKeyValue(t,w,b.key,e.$eval(o.chartColors),o.mainChartColor),console.log("pie chartData",e.chartData)}e.isLoading=!1};e.downloadData=function(){if(e.chartData){console.log("downloadData",e.chartData);var t=a.csv.prepareKeyValue(b.label,w.label,e.chartData);a.csv.downloadCSV(t,"data.csv")}};var $=function(){e.isLoading=!0,I=null;var n=b.key,r=w.countingMode+","+w.key;t.getDataEntitiesStats(o.datasetcode,d,n,r,c,0,1e3,null).then(function(t){if(console.log("loadDataGrouped",t),null!=t){e.isLoading=!0;var n={key:w.key+"_sts",label:w.label,countingMode:w.countingMode};e.chartData=a.data.aggregationSeriesKeyValue(t.data.d.results,[n],b.key,m,o.mainChartColor),console.log("discrete chartData",e.chartData),e.isLoading=!1}},function(t){e.isLoading=!1,console.error("loadDataGrouped error",t),e.debugMessages.push("Load data error "+t)})};y?$():L(),console.log("attrs",o)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_pie_chart.html",'<div class="yucca-widget yucca-dataset-pie-chart" id="{{widgetId}}" style="height: {{chartHeight}}px;width: {{chartWidth}}px;">\n    <div class="yucca-widget-download-csv" ng-if="!isLoading"><a href ng-click="downloadData()">Data</a></div>\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-pie-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-widget-chart" >\n\t\t\t\t<div><nvd3 options="options" data="chartData" ></nvd3></div>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetSankeyChart",["metadataService","dataService","$yuccaHelpers","$timeout","$compile","$rootScope",function(e,t,a,n,r,l){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_sankey_chart.html",link:function(e,r,l){console.log("elem",r);var o="YuccaBasicDatasetSankeyChart";e.widgetId=a.attrs.safe(l.widgetId,o+(new Date).getTime());a.attrs.safe(l.eventControlId,"EventControl");e.widgetTitle=a.attrs.safe(l.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(l.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(l.widgetIntro,null),e.debug="true"===l.debug,e.debugMessages=[];var s=l.usertoken,i=l.filter,d=l.orderby,c=(a.attrs.num(l.top,1,1e3,1e3),a.attrs.num(l.top,null,null,1),a.attrs.safe(l.datasetcode,null));null==c&&e.debugMessages.push("Invalid dataset code");var u=a.attrs.safe(l.euroValue,!1),g=a.attrs.safe(l.decimalValue,2),p=a.attrs.safe(l.formatBigNumber,!1);e.isEuroValue=function(){return"true"==u},e.numberFormat={euro:"true"==u,decimal:g,bigNumber:p};var v=("true"===l.skipZeroValues,"false"!==l.showLegend,e.$eval(l.chartColors),a.attrs.safe(l.mainChartColor,"#00bbf0"));n(function(){console.log("chartWidth",e.chartWidth);var t=angular.element(document.querySelector("#"+e.widgetId+" .yucca-dataset-sankey-chart-content"));e.chartHeight=a.attrs.num(l.widgetHeight,300,null,r[0].offsetParent.clientHeight),e.chartWidth=t[0].offsetWidth,console.log("width",t[0].offsetWidth),e.sankeyWidth=t[0].offsetWidth,e.sankeyHeight=e.chartHeight});var f=(a.attrs.safe(l.rootLabel,""),e.$eval(l.nodeColumns)),h=e.$eval(l.nodeRender),m=e.$eval(l.valueColumn),y=a.event.readWidgetEventAttr(l);console.log("eventConfig",y);var b={};e.$on("yucca-widget-event",function(t,n){console.log("yucca-widget-event",n),void 0!=typeof n&&null!=n&&n.sourceId!=e.widgetId&&(void 0==typeof n||null==n||n.sourceId==e.widgetId||a.event.ignoreEvent(n,y)||("dataset.change.value_column"==n.eventtype?(m=n.data,D()):"dataset.filter.text"==n.eventtype?(b[n.sourceId]=n.data,i=a.event.updateTextFilter(l.Filter,b,x),k()):"dataset.filter.odata"==n.eventtype&&(i="",n.data.filter&&""!=n.data.filter?(l.filter&&!n.data.override&&(i="("+l.filter+") and "),i+="("+n.data.filter+")"):i=l.filter,k())))});var w=null,x={},k=function(){e.isLoading=!0,w=null,t.getDataEntities(l.datasetcode,s,i,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var o in r)r.hasOwnProperty(o)&&"__metadata"!=o&&(x[o]=typeof r[o]);console.log("columnDataTypeMap ",x)}t.getMultipleDataEnties(l.datasetcode,s,i,d,n).then(function(e){console.info("sankeychart:loadData",e),w=e,D()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},D=function(){console.log("prepareData",w);if(e.isLoading=!0,null!=w){for(var t=new Array,n=0;n<w.length;n++)t=t.concat(w[n].data.d.results);e.sankeyData=a.data.aggregationNodesLinks(t,f,m.key,m.countingMode,h,v),console.log("sankey fuori",e.sankeyData),console.log("chartData",e.sankeyData)}e.isLoading=!1};k(),console.log("attrs",l)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_sankey_chart.html",'<div class="yucca-widget yucca-dataset-sankey-chart" id="{{widgetId}}" style="height: {{chartHeight}}px;width: {{chartWidth}}px;">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-sankey-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-sankey-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-dataset-sankey-chart-chart" >\n        \t    <sankey-chart data="sankeyData"  number_format="numberFormat" width="{{sankeyWidth}}" height="{{sankeyHeight}}"  widgetId="{{widgetId}}"></sankey-chart>\n\t\t\t\t<div><nvd3 options="options" data="chartData" ></nvd3></div>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetSingledata",["metadataService","dataService","$yuccaHelpers","$timeout","$compile",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_singledata_chart.html",link:function(e,r,l){console.log("elem",r);var o="YuccaBasicDatasetSingledataChart";e.widgetId=a.attrs.safe(l.widgetId,o+(new Date).getTime()),e.widgetTitle=a.attrs.safe(l.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(l.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(l.widgetIntro,null),e.debug="true"===l.debug,e.debugMessages=[];var s=l.usertoken,i=l.filter,d=(l.orderby,a.attrs.num(l.top,1,1e3,1e3),a.attrs.num(l.skip,null,null,1),a.attrs.safe(l.datasetcode,null));null==d&&e.debugMessages.push("Invalid dataset code");var c=a.attrs.safe(l.euroValue,!1),u=a.attrs.safe(l.decimalValue,2),g=a.attrs.safe(l.formatBigNumber,!1);e.isEuroValue=function(){return"true"==c};var p=e.$eval(l.valueColumn);e.hideLabel=l.hideLabel&&"true"==l.hideLabel,console.log("hideLabel ",e.hideLabel),e.textafter=a.attrs.safe(l.textAfter,null),console.log("singledata valuecolumn",p);var v=e.$eval(l.growAnimation),f=a.event.readWidgetEventAttr(l);console.log("eventConfig",f),e.$on("yucca-widget-event",function(t,r){console.log("yucca-widget-event",r),n(function(){void 0==typeof r||null==r||r.sourceId==e.widgetId||a.event.ignoreEvent(r,f)||r.data.datasetcode&&r.data.datasetcode!=d||("dataset.filter.text"==r.eventtype?(filterMap[r.sourceId]=r.data,i=a.event.updateTextFilter(l.Filter,filterMap,columnDataTypeMap),w()):"dataset.filter.odata"==r.eventtype&&(i="",r.data.filter&&""!=r.data.filter?(l.filter&&!r.data.override&&(i="("+l.filter+") and "),i+="("+r.data.filter+")"):i=l.filter,w()))})}),e.label=p.label,e.value="";var h,m=1,y=0,b=function(){n(function(){y+=m,e.value=a.render.safeNumber(y,u,c,g),m>0&&y<h||m<0&&y>h?b():e.value=a.render.safeNumber(h,u,c,g)},1)},w=function(){e.tableData=[],e.isLoading=!0,t.getDataEntities(l.datasetcode,s,i,0,1,null).then(function(t){console.log("loadData",t),h=t.data.d.results[0][p.key],h=1*h,isNaN(parseFloat(h))?e.value=h:v?(m=parseInt(h/100),e.value=0,b()):e.value=a.render.safeNumber(h,u,c,g),e.isLoading=!1},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})};w(),console.log("attrs",l)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_singledata_chart.html",'<div class="yucca-widget yucca-dataset-singledata" id="{{widgetId}}">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-content">\n       <section>\n         <div ng-if="isLoading" class="yucca-dataset-dataexplorer-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n         </div>\n         <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n           <p>{{infoMessage}}</p>\n         </div>\n\t\t  <div ng-if="!isLoading"  class="yucca-widget-singledata-content" ng-if="!isLoading">\n             <div ng-if="!hideLabel" class="yucca-widget-singledata-label" >{{label}}</div>\n             <div class="yucca-widget-singledata-value" >{{value}}</div>\n             <div class="yucca-widget-singledata-textafter" >{{textafter}}</div>\n         </div>\n       </section>\n   \t <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n   \t </section>\n    </div>\n<div>\n</div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetSinglepercentageChart",["metadataService","dataService","$yuccaHelpers","$timeout","$compile","$http","$sce","$location",function(e,t,a,n,r,l,o,s){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_singlepercentage_chart.html",link:function(e,r,i){console.log("elem ok",r);for(var d=document.getElementsByTagName("script"),c=s.absUrl().split("#")[0]+"lib/yucca-angular-widgets/dist/img/svg/",u=0;u<d.length;u++)if(d[u].src.indexOf("yucca-angular-widgets")>0){c=d[u].src.substring(0,d[u].src.indexOf("yucca-angular-widgets"))+"yucca-angular-widgets/dist/img/svg/";break}console.log("svgBaseUrl",c);var g={rectangle:{type:"basic",tag:"rect",attrs:{x:"1",y:"1","stroke-width":"1"}},ellipse:{type:"basic",tag:"ellipse",attrs:{x:"1",y:"1","stroke-width":"1"}},circle:{type:"basic",tag:"circle",attrs:{x:"1",y:"1","stroke-width":"1"}},star:{type:"polygon",tag:"polygon",attrs:{x:"1",y:"1","stroke-width":"1",points:"119,0 148,86 238,86 166,140 192,226 119,175 46,226 72,140 0,86 90,86"}},hexagon:{type:"polygon",tag:"polygon",attrs:{x:"1",y:"1","stroke-width":"1",points:"108,1 216,62.5 216,187.5 108,250 1,187.6 1,62.5"}},yucca_domain_agriculture:{type:"custom",url:c+"yucca/domain/AGRICULTURE.svg",attrs:{}},yucca_domain_culture:{type:"custom",url:c+"yucca/domain/CULTURE.svg",attrs:{}},yucca_domain_economy:{type:"custom",url:c+"yucca/domain/ECONOMY.svg",attrs:{}},yucca_domain_employment_training:{type:"custom",url:c+"yucca/domain/EMPLOYMENT_TRAINING.svg",attrs:{}},yucca_domain_energy:{type:"custom",url:c+"yucca/domain/ENERGY.svg",attrs:{}},yucca_domain_environment:{type:"custom",url:c+"yucca/domain/ENVIRONMENT.svg",attrs:{}},yucca_domain_government:{type:"custom",url:c+"yucca/domain/GOVERNMENT.svg",attrs:{}},yucca_domain_health:{type:"custom",url:c+"yucca/domain/HEALTH.svg",attrs:{}},yucca_domain_population:{type:"custom",url:c+"yucca/domain/POPULATION.svg",attrs:{}},yucca_domain_production:{type:"custom",url:c+"yucca/domain/PRODUCTION.svg",attrs:{}},yucca_domain_school:{type:"custom",url:c+"yucca/domain/SCHOOL.svg",attrs:{}},yucca_domain_science_technology:{type:"custom",url:c+"yucca/domain/SCIENCE_TECHNOLOGY.svg",attrs:{}},yucca_domain_security:{type:"custom",url:c+"yucca/domain/SECURITY.svg",attrs:{}},yucca_domain_smart_community:{type:"custom",url:c+"yucca/domain/SMART_COMMUNITY.svg",attrs:{}},yucca_domain_territory:{type:"custom",url:c+"yucca/domain/TERRITORY.svg",attrs:{}},yucca_domain_tourism_sport:{type:"custom",url:c+"yucca/domain/TOURISM_SPORT.svg",attrs:{}},yucca_domain_transport:{type:"custom",url:c+"yucca/domain/TRANSPORT.svg",attrs:{}},yucca_domain_trade:{type:"custom",url:c+"yucca/domain/TRADE.svg",attrs:{}},common_cloud:{type:"custom",url:c+"common/cloud.svg",attrs:{"stroke-width":20}},common_comment:{type:"custom",url:c+"common/comment.svg",attrs:{"stroke-width":20}},common_female:{type:"custom",url:c+"common/female.svg",attrs:{"stroke-width":20}},common_industry:{type:"custom",url:c+"common/industry.svg",attrs:{"stroke-width":20}},common_leaf:{type:"custom",url:c+"common/leaf.svg",attrs:{"stroke-width":20}},common_male:{type:"custom",url:c+"common/male.svg",attrs:{"stroke-width":20}},common_mars:{type:"custom",url:c+"common/mars.svg",
attrs:{"stroke-width":20}},common_pagelines:{type:"custom",url:c+"common/pagelines.svg",attrs:{"stroke-width":20}},common_paw:{type:"custom",url:c+"common/paw.svg",attrs:{"stroke-width":20}},common_subway:{type:"custom",url:c+"common/subway.svg",attrs:{"stroke-width":20}},common_train:{type:"custom",url:c+"common/train.svg",attrs:{"stroke-width":20}},common_tree:{type:"custom",url:c+"common/tree.svg",attrs:{"stroke-width":20}},common_trophy:{type:"custom",url:c+"common/trophy.svg",attrs:{"stroke-width":20}},common_truck:{type:"custom",url:c+"common/truck.svg",attrs:{"stroke-width":20}},common_umbrella:{type:"custom",url:c+"common/umbrella.svg",attrs:{"stroke-width":20}},common_plane:{type:"custom",url:c+"common/plane.svg",attrs:{"stroke-width":20}},common_rocket:{type:"custom",url:c+"common/rocket.svg",attrs:{"stroke-width":20}},common_heart:{type:"custom",url:c+"common/heart.svg",attrs:{"stroke-width":20}},common_child:{type:"custom",url:c+"common/child.svg",attrs:{"stroke-width":20}},common_venus:{type:"custom",url:c+"common/venus.svg",attrs:{"stroke-width":20}},meteo_cloud:{type:"custom",url:c+"meteo/cloud.svg",attrs:{}},meteo_cloud_flash:{type:"custom",url:c+"meteo/cloud_flash.svg",attrs:{}},meteo_cloud_flash_alt:{type:"custom",url:c+"meteo/cloud_flash_alt.svg",attrs:{}},meteo_cloud_flash_inv:{type:"custom",url:c+"meteo/cloud_flash_inv.svg",attrs:{}},meteo_cloud_inv:{type:"custom",url:c+"meteo/cloud_inv.svg",attrs:{}},meteo_cloud_moon:{type:"custom",url:c+"meteo/cloud_moon.svg",attrs:{}},meteo_cloud_moon_inv:{type:"custom",url:c+"meteo/cloud_moon_inv.svg",attrs:{}},meteo_clouds:{type:"custom",url:c+"meteo/clouds.svg",attrs:{}},meteo_clouds_flash:{type:"custom",url:c+"meteo/clouds_flash.svg",attrs:{}},meteo_clouds_flash_alt:{type:"custom",url:c+"meteo/clouds_flash_alt.svg",attrs:{}},meteo_clouds_flash_inv:{type:"custom",url:c+"meteo/clouds_flash_inv.svg",attrs:{}},meteo_clouds_inv:{type:"custom",url:c+"meteo/clouds_inv.svg",attrs:{}},meteo_cloud_sun:{type:"custom",url:c+"meteo/cloud_sun.svg",attrs:{}},meteo_cloud_sun_inv:{type:"custom",url:c+"meteo/cloud_sun_inv.svg",attrs:{}},meteo_compass:{type:"custom",url:c+"meteo/compass.svg",attrs:{}},meteo_drizzle:{type:"custom",url:c+"meteo/drizzle.svg",attrs:{}},meteo_drizzle_inv:{type:"custom",url:c+"meteo/drizzle_inv.svg",attrs:{}},meteo_eclipse:{type:"custom",url:c+"meteo/eclipse.svg",attrs:{}},meteo_fog:{type:"custom",url:c+"meteo/fog.svg",attrs:{}},meteo_fog_cloud:{type:"custom",url:c+"meteo/fog_cloud.svg",attrs:{}},meteo_fog_moon:{type:"custom",url:c+"meteo/fog_moon.svg",attrs:{}},meteo_fog_sun:{type:"custom",url:c+"meteo/fog_sun.svg",attrs:{}},meteo_hail:{type:"custom",url:c+"meteo/hail.svg",attrs:{}},meteo_hail_inv:{type:"custom",url:c+"meteo/hail_inv.svg",attrs:{}},meteo_mist:{type:"custom",url:c+"meteo/mist.svg",attrs:{}},meteo_moon:{type:"custom",url:c+"meteo/moon.svg",attrs:{}},meteo_moon_inv:{type:"custom",url:c+"meteo/moon_inv.svg",attrs:{}},meteo_rain:{type:"custom",url:c+"meteo/rain.svg",attrs:{}},meteo_rain_inv:{type:"custom",url:c+"meteo/rain_inv.svg",attrs:{}},meteo_snow:{type:"custom",url:c+"meteo/snow.svg",attrs:{}},meteo_snow_alt:{type:"custom",url:c+"meteo/snow_alt.svg",attrs:{}},meteo_snowflake:{type:"custom",url:c+"meteo/snowflake.svg",attrs:{}},meteo_snow_heavy:{type:"custom",url:c+"meteo/snow_heavy.svg",attrs:{}},meteo_snow_heavy_inv:{type:"custom",url:c+"meteo/snow_heavy_inv.svg",attrs:{}},meteo_snow_inv:{type:"custom",url:c+"meteo/snow_inv.svg",attrs:{}},meteo_sun:{type:"custom",url:c+"meteo/sun.svg",attrs:{}},meteo_sun_inv:{type:"custom",url:c+"meteo/sun_inv.svg",attrs:{}},meteo_sunrise:{type:"custom",url:c+"meteo/sunrise.svg",attrs:{}},meteo_temperature:{type:"custom",url:c+"meteo/temperature.svg",attrs:{}},meteo_wind:{type:"custom",url:c+"meteo/wind.svg",attrs:{}},meteo_windy:{type:"custom",url:c+"meteo/windy.svg",attrs:{}},meteo_windy_inv:{type:"custom",url:c+"meteo/windy_inv.svg",attrs:{}},meteo_windy_rain:{type:"custom",url:c+"meteo/windy_rain.svg",attrs:{}},meteo_windy_rain_inv:{type:"custom",url:c+"meteo/windy_rain_inv.svg",attrs:{}}},p="YuccaBasicDatasetSinglepercentageChart";e.widgetId=a.attrs.safe(i.widgetId,p+(new Date).getTime()),e.widgetTitle=a.attrs.safe(i.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(i.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(i.widgetIntro,null),e.debug="true"===i.debug,e.debugMessages=[];var v=i.usertoken,f=i.filter,h=i.orderby,m=(a.attrs.num(i.top,1,1e3,1e3),a.attrs.num(i.skip,null,null,1),a.attrs.safe(i.datasetcode,null));null==m&&e.debugMessages.push("Invalid dataset code");var y=a.attrs.safe(i.euroValue,!1),b=a.attrs.safe(i.decimalValue,2),w=a.attrs.safe(i.formatBigNumber,!1);e.isEuroValue=function(){return"true"==y};var x=e.$eval(i.labelColumn),k=e.$eval(i.valueColumn),D=e.$eval(i.maxValueLabelColumn),_=e.$eval(i.maxValueColumn),C=e.$eval(i.targetLabelColumn),I=e.$eval(i.targetValueColumn),M=a.attrs.safe(i.numRows,1);e.showLabel=!i.showLabel||"true"==i.showLabel,e.showValue=!i.showValue||"true"==i.showValue,e.showMaxValueLabel=!i.showMaxValueLabel||"true"==i.showMaxValueLabel,e.showMaxValue=!i.showMaxValue||"true"==i.showMaxValue,console.log("hideLabel ",e.hideLabel);var L=a.attrs.safe(i.maxValue,100),T=a.attrs.safe(i.targetValue,100);e.textAfter=a.attrs.safe(i.textAfter,null),console.log("singlepercentage valuecolumn",k);var $=(e.$eval(i.growAnimation),a.attrs.safe(i.shape,"rectangle")),E=a.attrs.safe(i.orientation,"horizontal"),S=a.attrs.safe(i.fullColor,"#bbb"),V=a.attrs.safe(i.emptyColor,"#fff"),A=a.attrs.safe(i.strokeColor,S);a.attrs.safe(i.fontSize,24);n(function(){var t=angular.element(document.querySelector("#"+e.widgetId+" .yucca-widget-content"));console.log("width",t[0].offsetWidth);var n=t[0].offsetWidth,r="rectangle"!=$||i.externalShapeUrl?n:n/10;e.width=parseInt(a.attrs.num(i.widgetWidth,null,null,n)),e.height=parseInt(a.attrs.num(i.widgetHeight,null,null,r))});var N=a.event.readWidgetEventAttr(i);console.log("eventConfig",N),e.$on("yucca-widget-event",function(t,r){console.log("yucca-widget-event",r),n(function(){void 0==typeof r||null==r||r.sourceId==e.widgetId||a.event.ignoreEvent(r,N)||r.data.datasetcode&&r.data.datasetcode!=m||("dataset.filter.text"==r.eventtype?(filterMap[r.sourceId]=r.data,f=a.event.updateTextFilter(i.Filter,filterMap,columnDataTypeMap),P()):"dataset.filter.odata"==r.eventtype&&(f="",r.data.filter&&""!=r.data.filter?(i.filter&&!r.data.override&&(f="("+i.filter+") and "),f+="("+r.data.filter+")"):f=i.filter,P()))})}),e.label=k.label,e.charts=new Array;var F,W,H,B,O=new XMLSerializer,P=function(){e.tableData=[],e.isLoading=!0,t.getDataEntities(i.datasetcode,v,f,0,M,h).then(function(t){console.log("loadData",t),n(function(){M>t.data.d.__count&&(M=t.data.d.__count);for(var n=0;n<M;n++){var r="svg_"+n+"_"+ +(new Date).getTime();F=t.data.d.results[n][k.key],F=1*F,W=x?t.data.d.results[n][x.key]:a.attrs.safe(i.label,""),H=D?t.data.d.results[n][D.key]:a.attrs.safe(i.maxValueLabel,""),C?B=t.data.d.results[n][C.key]:C=a.attrs.safe(i.targetLabel,""),_&&(L=t.data.d.results[n][_.key]),I&&(T=t.data.d.results[n][I.key]);var s=F/L;console.log("percentage",F,L,s);var d=a.svg.createPercentage(r,s,S,V,A,E),c=angular.copy(g[$]);i.externalShapeUrl?c={type:"custom",url:i.externalShapeUrl,attrs:{}}:c||(c=angular.copy(g.rectangle)),console.log(c);var u;if(c.attrs.fill="url(#"+r+"bg)",c.attrs.stroke="url(#"+r+"stroke)","basic"==c.type||"polygon"==c.type){var p={width:e.width+2,height:e.height+2};if("polygon"==c.type){var v=a.svg.baseSize(c.attrs.points),f="1 1 "+v[0]+" "+v[1],h=e.width/v[0],m=e.height/v[1];c.attrs["stroke-width"]=1/(h>m?m:h),p.viewBox=f}var y=a.svg.sizeAttrs(c.tag,e.width,e.height);for(var N in y)y.hasOwnProperty(N)&&(c.attrs[N]=y[N]);console.log("currentShape",c),u=a.svg.createSvg(p,c.tag,c.attrs,d),e.charts.push({svg:o.trustAsHtml(O.serializeToString(u)),label:W,value:a.render.safeNumber(F,b,e.isEuroValue(),w),maxValueLabel:H,maxValue:a.render.safeNumber(L,b,e.isEuroValue(),w)})}else l.get(c.url).then(function(t){var n={width:"100%",height:e.height};u=a.svg.updateSvg(t.data,n,c.attrs,d),console.log("svg",u),e.charts.push({svg:o.trustAsHtml(O.serializeToString(u)),label:W,value:a.render.safeNumber(F,b,e.isEuroValue(),w),maxValueLabel:H,maxValue:a.render.safeNumber(L,b,e.isEuroValue(),w)})},function(t){console.error("Load svg error",t),e.debugMessages.push("Load svg error "+t)})}console.log("charts",e.charts),e.isLoading=!1})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})};P(),console.log("attrs",i)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_singlepercentage_chart.html",'<div class="yucca-widget yucca-dataset-singlepercentage" id="{{widgetId}}">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-content">\n       <section>\n         <div ng-if="isLoading" class="yucca-dataset-dataexplorer-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n         </div>\n         <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n           <p>{{infoMessage}}</p>\n         </div>\n\t\t  <div ng-if="!isLoading">\n             <div ng-repeat="chart in charts track by $index"  class="yucca-widget-singlepercentage-content">\t\t\t\t<div class="yucca-widget-singlepercentage-label-content"><span class="yucca-widget-label" ng-if="showLabel">{{chart.label}}</span>\t\t\t\t\t<span class="yucca-widget-value" ng-if="showValue">{{chart.value}}</span>\t\t\t\t\t<span class="yucca-widget-max-value-label" ng-if="showMaxValueLabel">{{chart.maxValueLabel}}</span>\t\t\t\t\t<span class="yucca-widget-max-value" ng-if="showMaxValue">{{chart.maxValue}}</span>\t\t\t\t\t<span class="yucca-widget-text-after-value" >{{textAfter}}</span>\t\t\t\t</div>             \t<div ng-bind-html="chart.svg" class="yucca-widget-singlepercentage-chart-content"></div>         \t  </div>\n         </div>\n       </section>\n   \t <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n   \t </section>\n    </div>\n<div>\n</div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetStackedBarChart",["metadataService","dataService","$yuccaHelpers","$timeout","$compile",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_stacked_bar_chart.html",link:function(e,n,r){console.log("elem",n),e.debug="true"===r.debug,e.debugMessages=[];var l=r.usertoken,o=(r.filter,r.orderby),s=(a.attrs.safe(r.filterIds,null),function(){t.getDataEntities(r.datasetCode,l,null,0,50,o).then(function(t){console.log("loadIds",t);var a=t.d.results;if(null!=t.d.results&&t.d.__count>0){e.internalIds=[];for(var n=0;n<a.length;n++)e.internalIds.push([a[n][r.axisX],a[n][r.axisY]]);console.log("internalIds",e.internalIds),e.datachart=[{bar:!0,values:e.internalIds}]}else e.infoMessage="No data found",e.isLoading=!1},function(t){e.isLoading=!1,console.error("loadIds error",t),e.debugMessages.push("Load ids error "+t)})});s(),console.log("datachart",e.datachart),e.options={chart:{type:"historicalBarChart",height:450,margin:{top:20,right:20,bottom:65,left:50},x:function(e){return e[0]},y:function(e){return e[1]},showValues:!0,valueFormat:function(e){return d3.format(",.1f")(e)},duration:100,xAxis:{axisLabel:"X Axis",axisLabelDistance:-10,rotateLabels:30,showMaxMin:!1},yAxis:{axisLabel:"Y Axis",axisLabelDistance:-10},tooltip:{keyFormatter:function(e){return d3.format(e)(e)}},zoom:{enabled:!0,scaleExtent:[1,10],useFixedDomain:!1,useNiceScale:!1,horizontalOff:!1,verticalOff:!0,unzoomEventType:"dblclick.zoom"}}},console.log("attrs",r),e.widgetTitle=r.widgetTitle,e.widgetIntro=a.attrs.safe(r.widgetIntro,null)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_stacked_bar_chart.html",'<div class="yucca-widget yucca-dataset-stacked-bar-chart">\n    <header class="yucca-dataset-stacked-bar-chart-header">\n        {{widgetTitle}} {{metadata.stream.smartobject.twtQuery}}\n    </header>\n    <div class="yucca-widget-intro" ng-show="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-stacked-bar-chart-content">\n        <section >\n           <div ng-show="isLoading" class="yucca-dataset-stacked-bar-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-show="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-show="!isLoading"  o >\n\t\t\t\t<nvd3 options="options" data="datachart" ></nvd3>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-show="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <footer>\n        <div class="yucca-credits-intro">powered by</div>\n        <a href="http://www.smartdatanet.it/" target="_blank">\n          <i>SmartDataNet.it</i>\n        </a>\n    </footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetTreemapChart",["metadataService","dataService","$yuccaHelpers","$timeout","$compile","$rootScope",function(e,t,a,n,r,l){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_treemap_chart.html",link:function(e,r,o){console.log("elem",r);var s="YuccaBasicDatasetTreemapChart";e.widgetId=a.attrs.safe(o.widgetId,s+(new Date).getTime());var i=a.attrs.safe(o.eventControlId,"EventControl");e.widgetTitle=a.attrs.safe(o.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(o.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(o.widgetIntro,null),e.debug="true"===o.debug,e.debugMessages=[];var d=o.usertoken,c=o.filter,u=o.orderby,g=(a.attrs.num(o.top,1,1e3,1e3),a.attrs.num(o.top,null,null,1),a.attrs.safe(o.datasetcode,null));null==g&&e.debugMessages.push("Invalid dataset code");var p=a.attrs.safe(o.euroValue,!1),v=a.attrs.safe(o.decimalValue,2),f=a.attrs.safe(o.formatBigNumber,!1);e.isEuroValue=function(){return"true"==p};"true"===o.skipZeroValues;e.numberFormat={euro:"true"==p,decimal:v,bigNumber:f};var h=a.attrs.safe(o.euroValue2,!1),m=a.attrs.safe(o.decimalValue2,2),y=a.attrs.safe(o.formatBigNumber2,!1);e.isEuroValue2=function(){return"true"==h},e.numberFormat2={euro:"true"==h,decimal:m,bigNumber:y};"false"!==o.showLegend,e.$eval(o.chartColors),a.attrs.safe(o.mainChartColor,"#00bbf0");console.log("wwww",r[0].parentElement);var b=(n(function(){var t=a.render.widgetSize(r[0],n);e.chartWidth=a.attrs.num(o.widgetWidth,300,null,t.w),e.chartHeight=a.attrs.num(o.widgetHeight,300,null,t.h),M()}),a.attrs.safe(o.rootLabel,"")),w=e.$eval(o.treeColumns),x=e.$eval(o.valueColumn),k=e.$eval(o.valueColumn2),D=a.event.readWidgetEventAttr(o);console.log("eventConfig",D);var _={};e.$on("yucca-treemap-event",function(t,n){if(console.log("yucca-treemap-event fuori",n),n.sourceId==e.widgetId){n.data.datasetcode=g;var n=a.event.createEvent(e.widgetId,s,n.eventtype,n.data);n.eventControlId=i,console.log("event",n),l.$broadcast("yucca-widget-event",n)}}),e.$on("yucca-widget-event",function(t,n){if(console.log("treeee yucca-widget-event",n),void 0!=typeof n&&null!=n&&n.sourceId!=e.widgetId&&void 0!=typeof n&&null!=n&&n.sourceId!=e.widgetId&&!a.event.ignoreEvent(n,D))if("dataset.change.value_column"==n.eventtype)x=n.data,L();else if("dataset.filter.text"==n.eventtype)_[n.sourceId]=n.data,c=a.event.updateTextFilter(o.Filter,_,I),M();else if(n.data.datasetcode==g&&"dataset.browse"==n.eventtype){var r=n.data.path;l.$broadcast("yucca-widget-event-"+e.widgetId,{type:"browse",path:r,eventControlId:i})}else"dataset.filter.odata"==n.eventtype&&(c="",n.data.filter&&""!=n.data.filter?(o.filter&&!n.data.override&&(c="("+o.filter+") and "),c+="("+n.data.filter+")"):c=o.filter,M())});var C=null,I={},M=function(){e.isLoading=!0,C=null,t.getDataEntities(o.datasetcode,d,c,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var l in r)r.hasOwnProperty(l)&&"__metadata"!=l&&(I[l]=typeof r[l]);console.log("columnDataTypeMap ",I)}t.getMultipleDataEnties(o.datasetcode,d,c,u,n).then(function(e){console.info("treemapchart:loadData",e),C=e,L()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},L=function(){console.log("prepareData",C);if(e.isLoading=!0,null!=C){for(var t=new Array,n=0;n<C.length;n++)t=t.concat(C[n].data.d.results);e.treemapData=a.data.aggregationTree(b,t,w,x,k),console.log("tree fuori",e.treemapData);for(var r=a.render.safeColors(e.treemapData.children.length,e.$eval(o.chartColors),o.mainChartColor),n=0;n<e.treemapData.children.length;n++)e.treemapData.children[n].color=r[n];console.log("chartData",e.treemapData),l.$broadcast("yucca-widget-ready",{widgetId:e.widgetId,widgetType:"yucca-treemap",eventControlId:i}),console.log("broadcast yucca-widget-ready")}e.isLoading=!1};e.isLoading=!0,console.log("attrs",o)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_treemap_chart.html",'<div class="yucca-widget yucca-dataset-treemap-chart" id="{{widgetId}}" style="min-height: {{chartHeight}}px; min-width: {{chartWidth}}px;">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-dataset-treemap-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-treemap-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}}</p>\n           </div>\n        \t<div ng-if="!isLoading" class="yucca-dataset-treemap-chart-chart" >\n        \t\t<div><treemap-chart data="treemapData" width="{{chartWidth}}" height="{{chartHeight}}" widgetId="{{widgetId}}" number_format2="numberFormat2" number_format="numberFormat"></treemap-chart>\n\t\t\t\t</div>\n       \t</div>\n        </section>\n        <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDistributionTable",["metadataService","dataService","$yuccaHelpers","$timeout","$compile",function(e,t,a,n,r){"use strict";return{restrict:"E",scope:{},templateUrl:"template/distribution_table.html",link:function(e,n,r){console.log("elem",n);var l="YuccaBasicDistributionTable";e.widgetId=a.attrs.safe(r.widgetId,l+(new Date).getTime()),e.widgetTitle=a.attrs.safe(r.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(r.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(r.widgetIntro,null),e.debug="true"===r.debug,e.debugMessages=[];var o=r.usertoken,s=r.filter,i=r.orderby,d=(a.attrs.num(r.top,1,1e3,1e3),a.attrs.num(r.top,null,null,1),a.attrs.safe(r.datasetcode,null));null==d&&e.debugMessages.push("Invalid dataset code");var c=a.attrs.safe(r.euroValue,!1);e.decimalValue=a.attrs.safe(r.decimalValue,2),e.formatBigNumber=a.attrs.safe(r.formatBigNumber,!1),e.isEuroValue=function(){return"true"==c};var u=("true"===r.skipZeroValues,a.attrs.safe(r.groupOperation,"sum"),"false"!==r.showLegend,e.$eval(r.sliceColors)),g=(a.attrs.safe(r.mainColor,"#00bbf0"),a.attrs.safe(r.groupedQuery,!1)),p=e.$eval(r.groupByColumn);null==p&&e.debugMessages.push("Invalid group by column");var v=e.$eval(r.valueColumn),f=a.event.readWidgetEventAttr(r),h={};e.$on("yucca-widget-event",function(t,n){if(console.log("yucca-widget-event",n),void 0!=typeof n&&null!=n&&n.sourceId!=e.widgetId&&!a.event.ignoreEvent(n,f))if("dataset.change.group_by_column"==n.eventtype)p=n.data,g?x():w();else if("dataset.change.value_column"==n.eventtype)v.key=n.data.key,v.label=n.data.label,g?x():w();else if("dataset.filter.text"==n.eventtype)h[n.sourceId]=n.data,s=a.event.updateTextFilter(r.Filter,h,y),g?x():b();else if("dataset.filter.odata"==n.eventtype)s="",n.data.filter&&""!=n.data.filter?(r.filter&&!n.data.override&&(s="("+r.filter+") and "),s+="("+n.data.filter+")"):s=r.filter,g?x():b();else if("dataset.highlight.group_by_column"==n.eventtype){if(e.tableData&&e.tableData[0]&&e.tableData[0].values)for(var l=0;l<e.tableData[0].values.length;l++)if(e.tableData[0].values[l].key==n.data.key){console.log("trovato",e.tableData[0].values[l]),e.tableData[0].values[l].highlight="color: "+n.data.color+"; font-weight: bold; background-color: "+a.render.hex2RgbaColor(n.data.color,10),e.$apply();break}}else if("dataset.de_highlight.group_by_column"==n.eventtype){if(e.tableData&&e.tableData[0]&&e.tableData[0].values)for(var l=0;l<e.tableData[0].values.length;l++)if(e.tableData[0].values[l].key==n.data.key){delete e.tableData[0].values[l].highlight,e.$apply();break}e.tableData&&e.tableData[0][n.data.key]&&(e.tableData[n.data.key].highlight=null)}}),e.tableData=[];var m=null,y={};e.totalResult=0;var b=function(){e.tableData=[],e.isLoading=!0,t.getDataEntities(r.datasetcode,o,s,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var l=a.data.d.results[0];for(var d in l)l.hasOwnProperty(d)&&"__metadata"!=d&&(y[d]=typeof l[d]);console.log("columnDataTypeMap ",y)}t.getMultipleDataEnties(r.datasetcode,o,s,i,n).then(function(e){console.info("discretebarchart:loadData",e),m=e,w()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},w=function(){if(console.log("prepareData",m),e.isLoading=!0,null!=m){e.tableHeader=new Array,e.tableHeader.push(p,v),e.isLoading=!0;for(var t=new Array,n=0;n<m.length;n++)t=t.concat(m[n].data.d.results);e.tableData={},e.tableData=a.data.aggregationSeriesKeyValue(t,[v],p.key,u,r.mainChartColor),console.log("distribution tableData",e.tableData)}e.isLoading=!1},x=function(){e.isLoading=!0,m=null;var n=p.key,l=v.countingMode+","+v.key;t.getDataEntitiesStats(r.datasetcode,o,n,l,s,0,1e3,null).then(function(t){if(console.log("loadDataGrouped",t),null!=t){e.isLoading=!0;var n={key:v.key+"_sts",label:v.label,countingMode:v.countingMode};e.tableData=a.data.aggregationSeriesKeyValue(t.data.d.results,[n],p.key,u,r.mainChartColor),console.log("discrete chartData",e.chartData),e.isLoading=!1}},function(t){e.isLoading=!1,console.error("loadDataGrouped error",t),e.debugMessages.push("Load data error "+t)})};g?x():b(),console.log("attrs",r)}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/distribution_table.html",'<div class="yucca-widget yucca-distribution-table" id="{{widgetId}}">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-table-content">\n        <section>\n         <div ng-if="isLoading" class="yucca-distribution-table-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n         </div>\n           <div ng-if="infoMessage!=null" class="yucca-chart-info-message" >\n             <p>{{infoMessage}} </p>\n           </div>\n\t\t\t<table ng-if="!isLoading"  class="yucca-widget-table" ng-if="!isLoading">\n             <thead >\n                <tr>\n                    <th ng-repeat="col in tableHeader track by $index"> {{col.label}}</th>\n                </tr>\n             </thead>\n             <tbody>\n                 <tr ng-repeat="row in tableData[0].values " class="yucca-distribution-table-table-row" style="{{row.highlight}}">\n                   <td>{{row.label}}</td>                   <td>{{row.value|safeNumber:decimalValue:isEuroValue():formatBigNumber}}</td>                 </tr>\n             </tbody>\n         </table>\n        </section>\n   \t <section class="yucca-widget-debug" ng-if="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n   \t </section>\n    </div>\n<div>\n</div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaControlFilterDataDiscrete",["$yuccaHelpers","$rootScope",function(e,t){"use strict";return{restrict:"E",scope:{},templateUrl:"template/control_filter_data_discrete.html",link:function(a,n,r){console.log("ngYuccaControlFilter - attr",r);var l="ngYuccaControlFilter";a.widgetId=e.attrs.safe(r.widgetId,l+(new Date).getTime());var o=e.attrs.safe(r.eventControlId,"EventControl");if(a.label=e.attrs.safe(r.label,null),a.hint=e.attrs.safe(r.hint,null),a.debug="true"===r.debug,a.debugMessages=[],a.discreteFilterType=e.attrs.safe(r.filterType,"multi"),a.columns=r.valueColumns?a.$eval(r.valueColumns):null,a.columns)for(var s=0;s<a.columns.length;s++)a.columns[s].selected&&(a.columns[s].selectedText=a.columns[s].key);a.flexDirection=null==e.attrs.safe(r.direction,null)?"":"yucca-control-direction-"+r.direction,a.flexAlignItems=null==e.attrs.safe(r.alignItems,null)?"yucca-control-align-items-center":"yucca-control-align-items-"+r.alignItems,a.filter={};var i="true"==r.override,d=null;a.render=e.attrs.safe(r.render,"control"),"control"==a.render&&(a.render="multi"==a.discreteFilterType?"checkbox":"radio"),a.select=function(e){console.log("columns",a.columns),c()},a.toggleSelect=function(e){if(console.log("columns",a.columns),"multi"!=a.discreteFilterType)for(var t=0;t<a.columns.length;t++)a.columns[t].selected=!1;a.columns[e].selected=!a.columns[e].selected,c()};var c=function(){console.log("filterText",a.filter,d);for(var n=" or ",r="",s=0;s<a.columns.length;s++)a.columns[s].selected&&(r+=a.columns[s].filter+n);if(r=r.substring(0,r.length-n.length),!angular.equals(d,r)){var c=e.event.createEvent(a.widgetId,l,"dataset.filter.odata",{filter:r,override:i},o);t.$broadcast("yucca-widget-event",c),d=angular.copy(r)}}}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/control_filter_data_discrete.html",'<div class="yucca-widget yucca-control-filter-data-discrete" id="{{widgetId}}">\n   <div class="yucca-control-main-header">     <div class="yucca-control-main-label" for="yucca-control-{{widgetId}}">{{label}}</div>     <div class="yucca-control-main-hint">{{hint}}</div>   </div>\t<div class="yucca-control-type-radio" ng-if="render==\'radio\' || render==\'checkbox\'">      <div class="yucca-control-items {{flexDirection}} {{flexAlignItems}}"> \t   <div class="{{render}} yucca-control-item" ng-repeat="c in columns track by $index">          <label><input type="{{render}}" ng-click="toggleSelect($index)" name="yucca-control-{{widgetId}}" ng-value="c.key" ng-model="c.selectedText" selected="{{c.selected}}"} >     \t      <span class="cr"><!--<span class="cr-img"></span>--><i class="cr-icon glyphicon glyphicon-ok"></i></span><span>{{c.label}}<span>          </label>       </div>     </div>\t</div>\n\t<div class="yucca-control-type-button" ng-if="render==\'button\'">     <div class="yucca-control-items {{flexDirection}} {{flexAlignItems}}"> \t  \t<div class="yucca-control-select-button" ng-repeat="c in columns track by $index" ng-class="{\'active\': c.selected}">     \t\t<a href ng-click="toggleSelect($index)">{{c.label}}</a>   \t</div>     </div></div>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaControlFilter",["$yuccaHelpers","$rootScope",function(e,t){"use strict";return{restrict:"E",scope:{},templateUrl:"template/control_filter.html",link:function(a,n,r){console.log("ngYuccaControlFilter - attr",r);var l="ngYuccaControlFilter";a.widgetId=e.attrs.safe(r.widgetId,l+(new Date).getTime());var o=e.attrs.safe(r.eventControlId,"EventControl");a.label=e.attrs.safe(r.label,null),a.placeholder=e.attrs.safe(r.placeholder,null==a.label?"":a.label),a.hint=e.attrs.safe(r.hint,null),a.debug="true"===r.debug,a.debugMessages=[],a.filterType=e.attrs.safe(r.filterType,"text"),a.advancedFilter=e.attrs.safe(r.advancedFilter,"none"),a.doubleRangeValues=[0,100],a.filter={};var s=null;a.filterText=function(){if(console.log("filterText",a.filter,s),!angular.equals(s,a.filter)){var n=e.event.createEvent(a.widgetId,l,"dataset.filter.text",{column:r.column,value:a.filter.value},o);a.advancedFilter&&(n.data.advanced=a.filter.advanced),t.$broadcast("yucca-widget-event",n),s=angular.copy(a.filter)}},a.filterRange=function(){console.log("filterRange",a.doubleRangeValues);var n=e.event.createEvent(a.widgetId,l,"dataset.filter.range",{values:a.doubleRangeValues});t.$broadcast("yucca-widget-event",n)},a.resetAdvanced=function(){a.filter={},a.filterText()}}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/control_filter.html",'<div class="yucca-widget yucca-control-filter" id="{{widgetId}}">\n\t<div class="yucca-control-type-select" ng-if="filterType==\'text\'">     <div class="yucca-control-main-label" for="yucca-filter-text-{{widgetId}}">{{label}}</div>     <div class="yucca-control-main-hint">{{hint}}</div>\t  <input type="text" class="yucca-control-filter-text" ng-blur="filterText()" ng-model="filter.value" name="yucca-filter-text" id="yucca-filter-text-{{widgetId}}" placeholder="{{placeholder}}"/>     <div class="yucca-control-filter-text-advanced" ng-if="advancedFilter==\'text\'">       <div class="radio">          <label><input type="radio" name="adv_text_radio_{{widgetId}}" value="exact" ng-model="filter.advanced" ng-change="filterText()" >     \t      <span class="cr"><i class="cr-icon glyphicon glyphicon-ok"></i></span><span>Exact<span>          </label>       </div>       <div class="radio">          <label><input type="radio" name="adv_text_radio_{{widgetId}}" value="startWith" ng-model="filter.advanced" ng-change="filterText()" >     \t      <span class="cr"><i class="cr-icon glyphicon glyphicon-ok"></i></span><span>Start with<span>          </label>       </div>       <div class="radio">          <label><input type="radio" name="adv_text_radio_{{widgetId}}" value="endWith" ng-model="filter.advanced" ng-change="filterText()" >     \t      <span class="cr"><i class="cr-icon glyphicon glyphicon-ok"></i></span><span>End with<span>          </label>       </div>       <div class="yucca-control-reset-link"><a href ng-click="resetAdvanced()">Reset</a></div>    </div>     <div class="yucca-control-filter-text-advanced" ng-if="advancedFilter==\'numeric\'">       <div class="radio">          <label><input type="radio" name="adv_text_radio_{{widgetId}}" value="gt" ng-model="filter.advanced" ng-change="filterText()" >     \t      <span class="cr"><i class="cr-icon glyphicon glyphicon-ok"></i></span><span>&gt;<span>          </label>       </div>       <div class="radio">          <label><input type="radio" name="adv_text_radio_{{widgetId}}" value="ge" ng-model="filter.advanced" ng-change="filterText()" >     \t      <span class="cr"><i class="cr-icon glyphicon glyphicon-ok"></i></span><span>&ge;<span>          </label>       </div>       <div class="radio">          <label><input type="radio" name="adv_text_radio_{{widgetId}}" value="lt" ng-model="filter.advanced" ng-change="filterText()" >     \t      <span class="cr"><i class="cr-icon glyphicon glyphicon-ok"></i></span><span>&lt;<span>          </label>       </div>       <div class="radio">          <label><input type="radio" name="adv_text_radio_{{widgetId}}" value="le" ng-model="filter.advanced" ng-change="filterText()" >     \t      <span class="cr"><i class="cr-icon glyphicon glyphicon-ok"></i></span><span>&le;<span>          </label>       </div>       <div class="yucca-control-reset-link"><a href ng-click="resetAdvanced()">Reset</a></div>     </div> \t</div>\n\t<div class="yucca-control-type-select" ng-if="filterType==\'range\'">     <div class="yucca-control-select-title">        <span class="yucca-control-select-label">{{label}}</span>        <span class="yucca-control-select-hint">{{hint}}</span>     </div>     <div class="yucca-widget-range">\t      <label for="yucca-filter-range-1-{{widgetId}}" class="yucca-widget-double-range-value">Min</label>         <input type="range" class="yucca-widget-filter-range" ng-change="filterRange()" ng-model-options="{ debounce: 1500 }"  ng-model="doubleRangeValues[0]" name="yucca-filter-range-1" id="yucca-filter-range-1-{{widgetId}}"/>         <div class="yucca-widget-range-value">{{doubleRangeValues[0]}} %</div>     </div>     <div class="yucca-widget-range">\t      <label for="yucca-filter-range-2-{{widgetId}}" class="yucca-widget-double-range-value">Max</label>         <input type="range" class="yucca-widget-filter-range" ng-change="filterRange()" ng-model-options="{ debounce: 1500 }"  ng-model="doubleRangeValues[1]" name="yucca-filter-range-2" id="yucca-filter-range-2-{{widgetId}}"/>         <div class="yucca-widget-range-value">{{doubleRangeValues[1]}} %</div>     </div>\t</div>\n\t<div class="yucca-control-type-select" ng-if="filterType==\'range2\'">     <div class="yucca-control-select-title">        <span class="yucca-control-select-label">{{label}}</span>        <span class="yucca-control-select-hint">{{hint}}</span>     </div>     <div class="yucca-widget-double-range">\t      <input type="range" class="yucca-widget-filter-range yucca-widget-double-range-first" ng-change="filterRange()" max="{{doubleRangeValues[1]}}" ng-model="doubleRangeValues[0]" name="yucca-filter-text" id="yucca-filter-text-{{widgetId}}"/>\t      <input type="range" class="yucca-widget-filter-range yucca-widget-double-range-second" ng-change="filterRange()" min="{{doubleRangeValues[0]}}" ng-model="doubleRangeValues[1]" name="yucca-filter-text" id="yucca-filter-text-{{widgetId}}" />     </div>     <div class="yucca-widget-double-range-values">         <div class="yucca-widget-double-range-values-first">Min: {{doubleRangeValues[0]}} %</div>         <div class="yucca-widget-double-range-values-second">Max: {{doubleRangeValues[1]}} %</div>     </div>\t</div>\n\t<div class="yucca-control-type-select" ng-if="filterType==\'range1\'">     <div class="yucca-control-select-title">        <span class="yucca-control-select-label">{{label}}</span>        <span class="yucca-control-select-hint">{{hint}}</span>     </div>     <div class="yucca-widget-slide">\t      <div class="yucca-widget-slide-step {{r.style}}" ng-mouseover="rangeStepHover($index)" ng-mouseout="rangeStepOut($index)" ng-click="selectRangeStep($index)" ng-repeat="r in rangeSteps track by $index">&nbsp;</div>     </div>     <div class="yucca-widget-double-range-values">         <div class="yucca-widget-double-range-values-first">Min: {{selectedSteps[0]}} %</div>         <div class="yucca-widget-double-range-values-second">Max: {{selectedSteps[1]}} %</div>     </div>\t</div>\n</div>\n');
}]),yuccaWidgetsModule.directive("ngYuccaControlMapFilter",["metadataService","dataService","$yuccaHelpers","$http","$timeout","$compile","$rootScope",function(e,t,a,n,r,l,o){"use strict";return{restrict:"E",scope:{},templateUrl:"template/control_map_filter.html",link:function(e,t,n){function l(e){return v}function s(t){console.log("onAreaClick",t),null!=D&&(D.properties.selected=!1),t.properties.selected=!t.properties.selected,D=t,k();var r=a.event.createEvent(e.widgetId,i,"dataset.filter.text",{column:n.column,value:t.properties[f[y].key]},d);o.$broadcast("yucca-widget-event",r)}var i="YuccaControlMapFilter",d=(i+(new Date).getTime(),a.attrs.safe(n.eventControlId,"EventControl"));e.label=a.attrs.safe(n.label,null),e.hint=a.attrs.safe(n.hint,null);var c=a.attrs.num(n.width,null,null,300),u=a.attrs.num(n.height,null,null,400);e.debug="true"===n.debug,e.debugMessages=[];var g=a.attrs.safe(n.borderColor,"#fff"),p=a.attrs.safe(n.selectedColor,"#aaa"),v=a.attrs.safe(n.unselectedColor,"#ddd");e.controlMapMapId="controlMap"+(new Date).getTime();var f=e.$eval(n.geojsons);f&&f.length&&0!=f.lenght||(f=[{}]);for(var h=0;h<f.length;h++){var m=f[h];m.url||(m.url="lib/yucca-angular-widgets/dist/data/piemonte_province_geojson.json"),m.key||(m.key="name"),m.render||(m.render={}),m.render.line||(m.render.line={}),m.render.line.weight||(m.render.line.weight=1),m.render.line.opacity||(m.render.line.opacity=1),m.render.line.dashcolor||(m.render.line.dashcolor="#0e232e"),m.render.line.dasharray||(m.render.line.dasharray=1),m.render.areas||(m.render.areas={}),m.render.areas.fillopacity||(m.render.areas.fillopacity=.7)}e.geojson=null;e.isLoading=!0;var y=0,b=d3.select("svg").attr("width",c).attr("height",u),m=b.append("g"),w=m.append("g").classed("map-layer",!0);d3.json(f[y].url,function(t,a){for(var n in a.features)a.features[n].properties.selected=!1;var r=d3.geo.centroid(a),o=1,i=[c/2,u/2],d=d3.geo.mercator().scale(o).center(r).translate(i),p=d3.geo.path().projection(d),v=p.bounds(a);console.log("bounds",v),o=1/Math.max(1.1*(v[1][0]-v[0][0])/c,1.1*(v[1][1]-v[0][1])/u),i=[c-(v[0][0]+v[1][0])/2,1.1*u-(v[0][1]+v[1][1])/2],d=d3.geo.mercator().center(r).scale(o).translate(i),p=p.projection(d),w.selectAll("path").data(a.features).enter().append("path").attr("d",p).attr("vector-effect","non-scaling-stroke").style("fill",l).style("stroke",g).on("mouseover",x).on("mouseout",k).on("click",s),e.isLoading=!1}),e.info={show:!0},e.updateInfo=function(t,a){r(function(){e.info.show=t,e.info.content=a},100)};var x=function(t){d3.select(this).style("fill",p),e.updateInfo(!0,t.properties.code+" "+t.properties.name)},k=function(t){w.selectAll("path").style("fill",function(e){return e.properties.selected?p:v}),e.updateInfo(!1,"")};e.filter={};var D=null;console.log("attrs",n),e.MAP_PIEDMONT_CENTER={lat:45.3522366,lng:7.515388499999972,zoom:7}}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/control_map_filter.html",'<div class="yucca-widget  yucca-control-map-filter">\n    <div class="yucca-control-main-label" for""yucca-filter-text-{{widgetId}}"">{{label}}</div>    <div class="yucca-control-main-hint">{{hint}}</div>    <div class="yucca-widget-control-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-discretebar-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <svg ng-show="!isLoading"></svg>\n           <div class="info-panel" ng-show="info.show"><span>{{info.content}}</span></div>          </section>\n        <section class="yucca-widget-debug" ng-show="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaControlSelect",["$yuccaHelpers","$rootScope",function(e,t){"use strict";return{restrict:"E",scope:{},templateUrl:"template/control_select.html",link:function(a,n,r){console.log("ngYuccaControlSelect - attr",r);var l="ngYuccaControlSelect";a.widgetId=e.attrs.safe(r.widgetId,l+(new Date).getTime());var o=e.attrs.safe(r.eventControlId,"EventControl");a.label=e.attrs.safe(r.label,null),a.hint=e.attrs.safe(r.hint,null),a.selectEmptyLabel=e.attrs.safe(r.selectEmptyLabel,null),a.debug="true"===r.debug,a.debugMessages=[],a.selected={},a.selected.key=r.selectedValue,a.flexDirection=null==e.attrs.safe(r.direction,null)?"":"yucca-control-direction-"+r.direction,a.flexAlignItems=null==e.attrs.safe(r.alignItems,null)?"yucca-control-align-items-center":"yucca-control-align-items-"+r.alignItems,a.columns=null;var s=null;if(r.groupByColumns?(a.columns=r.groupByColumns?a.$eval(r.groupByColumns):null,s="dataset.change.group_by_column"):r.valueColumns&&(a.columns=r.valueColumns?a.$eval(r.valueColumns):null,s="dataset.change.value_column"),a.selected.key)for(var i=0;i<a.columns.length;i++)if(a.columns[i].key==a.selected.key){a.selectedIndex=i;break}console.log("columns",a.columns),a.render=e.attrs.safe(r.render,"select"),a.select=function(n){console.log("select",n),a.selected.key=n;for(var r=null,i=0;i<a.columns.length;i++)a.columns[i].key==n&&(r=a.columns[i]);var d=e.event.createEvent(a.widgetId,l,s,r,o);console.log("event",d),t.$broadcast("yucca-widget-event",d)}}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/control_select.html",'<div class="yucca-widget yucca-control-select" id="{{widgetId}}">\n   <div class="yucca-control-main-header">     <div class="yucca-control-main-label" for="yucca-control-{{widgetId}}">{{label}}</div>     <div class="yucca-control-main-hint">{{hint}}</div>   </div>\t<div class="yucca-control-type-select" ng-if="render==\'select\'">\t  <select ng-change="select(selected.key)" class="yucca-select" ng-model="selected.key" id="yucca-control-{{widgetId}}">       <option disabled selected value>{{selectEmptyLabel}}</option>\t\t<option ng-repeat="c in columns  track by $index" value="{{c.key}}">{{c.label}}</option>\t  </select>\t</div>\n\t<div class="yucca-control-type-radio" ng-if="render==\'radio\'">      <div class="yucca-control-items {{flexDirection}} {{flexAlignItems}}"> \t   <div class="radio yucca-control-item" ng-repeat="c in columns track by $index">          <label><input type="radio" ng-change="select(c.key)" name="yucca-control-{{widgetId}}" ng-value="c.key" ng-model="selected.key" >     \t      <span class="cr"><!--<span class="cr-img"></span>--><i class="cr-icon glyphicon glyphicon-ok"></i></span><span>{{c.label}}<span>          </label>       </div>     </div>\t</div>\n\t<div class="yucca-control-type-button" ng-if="render==\'button\'">     <div class="yucca-control-items {{flexDirection}} {{flexAlignItems}}"> \t  \t<div class="yucca-control-select-button" ng-repeat="c in columns track by $index" ng-class="{\'active\': c.key==selected.key}">     \t\t<a href ng-click="select(c.key)">{{c.label}}</a>   \t</div>     </div></div>\n</div>\n')}]),yuccaWidgetsModule.directive("ngYuccaDatasetChoroplethMap",["metadataService","dataService","$yuccaHelpers","$http","leafletData","$timeout","$compile","$rootScope",function(e,t,a,n,r,l,o,s){"use strict";return{restrict:"E",scope:{},templateUrl:"template/dataset_choropleth_map.html",link:function(e,l,o){function i(t){var n=t.target;if(n.setStyle({weight:_[W].render.line.weight,opacity:_[W].render.line.opacity,color:_[W].render.line.dashcolor,dashArray:_[W].render.line.dasharray,fillOpacity:_[W].render.areas.fillopacity}),e.info.show=!1,!a.event.ignoreEvent({eventtype:"evtHighlightGroupbycolumn"},S)){var r={};r.key=n.feature.properties[_[W].key],r.value=n.feature.properties.value,r.color=z(n.feature.properties.value);var l=a.event.createEvent(e.widgetId,c,"dataset.de_highlight.group_by_column",r);l.eventControlId=u,s.$broadcast("yucca-widget-event",l)}}function d(t){if(console.log("onAreaClick",t),f){var n=a.event.createEvent(e.widgetId,c,"dataset.filter.text",{datasetcode:f,column:k.key,value:t.target.feature.properties[_[W].key]});n.eventControlId=u,s.$broadcast("yucca-widget-event",n),console.log("event",n),s.$broadcast("yucca-widget-event",n)}}var c="YuccaDatasetChoroplethMap";e.widgetId=a.attrs.safe(o.widgetId,c+(new Date).getTime());var u=a.attrs.safe(o.eventControlId,"EventControl");e.widgetTitle=a.attrs.safe(o.widgetTitle,null),e.widgetSubtitle=a.attrs.safe(o.widgetSubtitle,null),e.widgetIntro=a.attrs.safe(o.widgetIntro,null),e.debug="true"===o.debug,e.debugMessages=[];var g=o.usertoken,p=o.filter,v=o.orderby,f=(a.attrs.num(o.top,1,1e3,1e3),a.attrs.num(o.top,null,null,1),a.attrs.safe(o.datasetcode,null));null==f&&e.debugMessages.push("Invalid dataset code");var h=a.attrs.safe(o.euroValue,!1);a.attrs.safe(o.decimalValue,2),a.attrs.safe(o.formatBigNumber,!1);e.isEuroValue=function(){return"true"==h};var m="true"===o.skipZeroValues,y=e.$eval(o.rangeColors),b=a.attrs.safe(o.mainChartColor,"#00bbf0"),w=a.attrs.safe(o.groupedQuery,!1),x=e.$eval(o.chartLegend);e.chartWidth=a.attrs.num(o.widgetWidth,null,null,null),e.chartHeight=a.attrs.num(o.widgetHeight,null,null,null);var k=e.$eval(o.groupByColumn);null==k&&e.debugMessages.push("Invalid group by column");var D=e.$eval(o.valueColumn);e.datasetChoroplethMapMapId="map"+(new Date).getTime();var _=e.$eval(o.geojsons);_&&_.length&&0!=_.lenght||(_=[{}]);for(var C=0;C<_.length;C++){var I=_[C];I.url||(I.url="lib/yucca-angular-widgets/dist/data/piemonte_province_geojson.json"),I.key||(I.key="code"),I.render||(I.render={}),I.render.line||(I.render.line={}),I.render.line.weight||(I.render.line.weight=1),I.render.line.opacity||(I.render.line.opacity=1),I.render.line.dashcolor||(I.render.line.dashcolor="#0e232e"),I.render.line.dasharray||(I.render.line.dasharray=1),I.render.areas||(I.render.areas={}),I.render.areas.fillopacity||(I.render.areas.fillopacity=.7)}var M=a.attrs.safe(o.mapTilesUrl,Constants.MAP_TILES_CARTO_DB_POSITRON_URL);e.mapTiles={url:M};var h=a.attrs.safe(o.euroValue,!1),T=null,m="true"===o.skipZeroValues,$="false"!==o.zoomControl,E="false"!==o.scrollWheelZoom;e.defaults={zoomControl:$,scrollWheelZoom:E};var S=a.event.readWidgetEventAttr(o);console.log("eventConfig",S);var V={};e.$on("yucca-widget-event",function(t,n){console.log("yucca-widget-event",n),void 0==typeof n||null==n||n.sourceId==e.widgetId||a.event.ignoreEvent(n,S)||("dataset.change.value_column"==n.eventtype?(D.key=n.data.key,D.label=n.data.label,w?loadDataGrouped():P()):"dataset.filter.text"==n.eventtype?(V[n.sourceId]=n.data,p=a.event.updateTextFilter(o.Filter,V,B),w?loadDataGrouped():O()):"dataset.filter.odata"==n.eventtype?(p="",n.data.filter&&""!=n.data.filter?(o.filter&&!n.data.override&&(p="("+o.filter+") and "),p+="("+n.data.filter+")"):p=o.filter,w?loadDataGrouped():O()):"dataset.highlight.group_by_column"==n.eventtype?r.getMap(e.datasetChoroplethMapMapId).then(function(e){e.eachLayer(function(e){e.feature&&e.feature.properties[_[W].key]==n.data.key&&e.setStyle({weight:3,dashArray:"",fillOpacity:.7})})}):"dataset.de_highlight.group_by_column"==n.eventtype&&r.getMap(e.datasetChoroplethMapMapId).then(function(e){e.eachLayer(function(e){e.feature&&e.feature.properties[_[W].key]==n.data.key&&e.setStyle({weight:_[W].render.line.weight,opacity:_[W].render.line.opacity,color:_[W].render.line.dashcolor,dashArray:_[W].render.line.dasharray,fillOpacity:_[W].render.areas.fillopacity})})}))});var A=null,N=null;e.geojson=null;var F=null;e.tableData=[],e.isLoading=!0;var W=0;n.get(_[W].url).then(function(e){T=e.data,F=R(T.features),O()},function(t){e.isLoading=!1,console.error("Load geojson error",t),e.debugMessages.push("Load geojson error "+t)});var H=null,B={},O=function(){console.log("map - loadData",f),e.isLoading=!0,H=null,t.getDataEntities(f,g,p,0,1,null).then(function(a){console.log("loadData",a);var n=a.data.d.__count>1e4?1e4:a.data.d.__count;if(n>0){var r=a.data.d.results[0];for(var l in r)r.hasOwnProperty(l)&&"__metadata"!=l&&(B[l]=typeof r[l]);console.log("columnDataTypeMap ",B)}t.getMultipleDataEnties(o.datasetcode,g,p,v,n).then(function(e){console.info("discretebarchart:loadData",e),H=e,P()},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},function(t){e.isLoading=!1,console.error("Load data error",t),e.debugMessages.push("Load data error "+t)})},P=function(){if(console.log("prepareData",H),null!=H){e.isLoading=!0;for(var t=new Array,n=0;n<H.length;n++)t=t.concat(H[n].data.d.results);var l=a.data.aggregationSeriesKeyValue(t,[D],k.key,null,o.mainChartColor);if(console.log("discrete mapData",l),l[0].values.length>0){for(var s=0;s<l[0].values.length;s++){var i=l[0].values[s];console.log("d",i);for(var d=0;d<T.features.length;d++)i.key.toUpperCase()==T.features[d].properties[_[W].key].toUpperCase()&&(T.features[d].properties.value=i.value,T.features[d].properties.color=i.color)}for(var c=0;c<T.features.length;c++)0!=T.features[c].properties.value&&((null==A||T.features[c].properties.value>A)&&(A=T.features[c].properties.value),(null==N||T.features[c].properties.value<N)&&(N=T.features[c].properties.value));e.geojson={},console.info("geojson_data",T),e.geojson.data=T,e.geojson.style=U,e.geojson.onEachFeature=Y,r.getMap(e.datasetChoroplethMapMapId).then(function(e){e.fitBounds(F)}),x&&x.show&&G()}e.isLoading=!1}e.isLoading=!1},R=function(e){var t=[];for(var a in e)if("MultiPolygon"==e[a].geometry.type)for(var n in e[a].geometry.coordinates)for(var r in e[a].geometry.coordinates[n]){var l=e[a].geometry.coordinates[n][r];for(var o in l)t.push(L.GeoJSON.coordsToLatLng(l[o]))}else for(var r in e[a].geometry.coordinates){var l=e[a].geometry.coordinates[r];for(var o in l)t.push(L.GeoJSON.coordsToLatLng(l[o]))}return t},U=function(e){return{fillColor:z(e.properties.value),weight:_[W].render.line.weight,opacity:_[W].render.line.opacity,color:_[W].render.line.dashcolor,dashArray:_[W].render.line.dasharray,fillOpacity:_[W].render.areas.fillopacity}},z=function(e){var t="#ddd";if(m&&0==e);else if(y)for(var n=0;n<y.length&&(t=y[n].color,!(e<=y[n].limit));n++);else{var r=-1*((e-N)/(A-N)-.5)*1.8;t=a.render.colorLuminance(b,r)}return t},Y=function(e,t){console.log(e,t),t.on({mouseover:j,mouseout:i,click:d})};e.info={show:!1};var j=function(t){console.log("e.target",t.target);var n=t.target;n.setStyle({weight:3,dashArray:"",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||L.Browser.edge||n.bringToFront(),e.info.top=t.layerPoint.y+30,e.info.left=t.layerPoint.x+20;var r=a.render.safeNumber(n.feature.properties.value,e.decimalValue,e.isEuroValue());if(e.info.content="<strong>"+k.label+"</strong>: "+n.feature.properties[_[W].key]+" <br><strong>"+D.label+"</strong>: "+r,e.info.show=!0,!a.event.ignoreEvent({eventtype:"evtHighlightGroupbycolumn"},S)){var l={};l.key=n.feature.properties[_[W].key],l.value=n.feature.properties.value,l.color=z(n.feature.properties.value);var o=a.event.createEvent(e.widgetId,c,"dataset.highlight.group_by_column",l);o.eventControlId=u,s.$broadcast("yucca-widget-event",o)}},G=function(){var t=[],n=[];if(y){t.push(y[0].color),n.push("<"+a.render.safeNumber(y[0].limit,e.decimalValue,e.isEuroValue()));for(var r=1;r<y.length-1;r++)t.push(y[r].color),n.push(""+a.render.safeNumber(y[r-1].limit,e.decimalValue,e.isEuroValue())+" - "+a.render.safeNumber(y[r].limit,e.decimalValue,e.isEuroValue()));t.push(y[y.length-1].color),n.push(">"+a.render.safeNumber(y[y.length-1].limit,e.decimalValue,e.isEuroValue()))}else for(var l=(A-N)/5,r=0;r<5;r++){var o=-.9*(r-2);t.push(a.render.colorLuminance(b,o)),0==r?n.push("<"+a.render.safeNumber(l+N,e.decimalValue,e.isEuroValue())):4==r?n.push(">"+a.render.safeNumber(A-l,e.decimalValue,e.isEuroValue())):n.push(""+a.render.safeNumber(N+l*r,e.decimalValue,e.isEuroValue())+" - "+a.render.safeNumber(N+l*(r+1),e.decimalValue,e.isEuroValue()))}e.legend={position:x.position,colors:t,labels:n}};console.log("attrs",o),e.widgetTitle=o.widgetTitle,e.widgetIntro=a.attrs.safe(o.widgetIntro,null),e.MAP_PIEDMONT_CENTER={lat:45.3522366,lng:7.515388499999972,zoom:7}}}}]),yuccaWidgetsTemplatesModule.run(["$templateCache",function(e){e.put("template/dataset_choropleth_map.html",'<div class="yucca-widget yucca-dataset-choropleth-map" id="{{widgetId}}">\n    <widget-header widget-title="{{widgetTitle}}" widget-subtitle="{{widgetSubtitle}}" ></widget-header>\n    <div class="yucca-widget-intro" ng-if="widgetIntro!=null">{{widgetIntro}}</div>\n    <div class="yucca-widget-chart-content">\n        <section>\n           <div ng-if="isLoading" class="yucca-dataset-discretebar-chart-loading" >\n             <div class="yucca-widget-spinner"><div class="bullet1"></div><div class="bullet2"></div><div class="bullet3"></div></div>\n           </div>\n           <leaflet ng-attr-id="{{datasetChoroplethMapMapId}}"  defaults="defaults" tiles="mapTiles" bounds="mapBounds" geojson="geojson" class="yucca-dataset-choropleth-map-map" ng-if="geojson!=null" legend="legend" controls="mapControls"></leaflet>\n           <div class="info-panel" ng-show="info.show" style="top:{{info.top}}px; left:{{info.left}}px"><span ng-bind-html="info.content"></span></div>          </section>\n        <section class="yucca-widget-debug" ng-show="debug && debugMessages.length>0">\n          \t<ul><li ng-repeat="m in debugMessages track by $index">{{m}}</li></ul>\n        </section>\n    </div>\n    <widget-footer ng-if="showFooter" widget-footer-text="{{footerText}}"><widget-footer>\n</div>\n')}]);